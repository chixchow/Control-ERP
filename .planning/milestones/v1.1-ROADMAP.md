# Milestone v1.1: Read-Layer Build-Out

**Status:** SHIPPED 2026-02-10
**Phases:** 9-13
**Total Plans:** 10

## Overview

Expand the natural language interface from sales/financial foundation to all major business domains -- customer intelligence, inventory management, production workflow -- and integrate a Crystal Reports routing catalog. Every new skill validates against Control's built-in reports before shipping.

## Parallelism

```
          +---> Phase 9 (Financial) ---+
          |                            |
START ----+                            +---> Phase 11 (Inventory) ---> Phase 12 (Production) ---> Phase 13 (Glossary)
          |                            |
          +---> Phase 10 (Customer) ---+
```

- **Wave 1** (parallel): Phases 9, 10 -- zero dependencies between Financial and Customer
- **Wave 2**: Phase 11 -- cross-references Financial GL cost accounts for inventory valuation
- **Wave 3**: Phase 12 -- soft dependency on Inventory for part usage context
- **Wave 4**: Phase 13 -- routes to ALL domain skills, must come last

## Phases

### Phase 9: Financial Depth

**Goal**: Users can answer AR/AP, P&L, and cash flow questions through natural language against the Control ERP -- extending the validated financial skill with analytical depth
**Depends on**: v1.0 Phase 5 (financial foundation already shipped)
**Requirements**: FIN-04, FIN-05, FIN-06, FIN-07
**Plans**: 2 plans

Plans:
- [x] 09-01-PLAN.md -- AR detail with customer breakdown + AP detail with vendor breakdown
- [x] 09-02-PLAN.md -- P&L analysis with comparison periods + cash flow and bank balance queries

**Critical pitfalls:**
- GL sign convention inversion: Revenue stored as negative credits. Must use SUM(-Amount) for GLClassificationType IN (4000, 4001).
- DueDate semantic overloading: AR aging MUST use SaleDate (invoice date), NOT DueDate (production deadline).
- GL view vs Ledger table: Must use GL view (excludes ~307K off-balance-sheet entries), not Ledger directly.

**Verification:** PASSED (13/13 must-haves). All 4 requirements satisfied. 14 SQL queries across AR Detail, AP Detail, P&L Analysis, Cash Flow. Extracted to references/financial-analysis.md (412 lines).

### Phase 10: Customer Intelligence

**Goal**: Users can look up any customer, understand their value and behavior, and identify at-risk accounts -- through a new control-erp-customers skill
**Depends on**: v1.0 Phase 1 (core skill for TransactionType/StatusID/pricing rules)
**Requirements**: CUST-01, CUST-02, CUST-03
**Plans**: 2 plans

Plans:
- [x] 10-01-PLAN.md -- Create customer skill with profile lookup, smart search, and drill-down queries (CUST-01)
- [x] 10-02-PLAN.md -- Add ranking, RFM segmentation, and churn detection with personalized dormancy (CUST-02, CUST-03)

**Critical pitfalls:**
- Account table uses CompanyName, NOT AccountName.
- Must filter IsClient=1, IsActive=1 by default (Account has IsClient, IsProspect, IsActive flags).
- Must use core skill's TransactionType=1, SubTotalPrice, SaleDate patterns -- no independent implementations.

**Verification:** Initially gaps_found (RFM Recency scoring inversion). Fixed post-verification. Final: PASSED (6/7 â†’ 7/7 after fix). All 3 requirements satisfied.

### Phase 11: Inventory Management

**Goal**: Users can check stock levels, identify reorder needs, and plan material usage -- through a new control-erp-inventory skill
**Depends on**: Phase 9 (cross-references Financial GL cost accounts for inventory valuation)
**Requirements**: INV-01, INV-02, INV-03
**Plans**: 2 plans

Plans:
- [x] 11-01-PLAN.md -- Create inventory skill with table architecture, stock level queries (INV-01), and reorder monitoring (INV-02)
- [x] 11-02-PLAN.md -- Add purchasing intelligence, material consumption, inventory valuation (INV-03), and NL routing

**Critical pitfalls:**
- QuantityAvailable vs QuantityOnHand: OnHand - Reserved = Available. "Available" is what matters for new orders.
- Must query Inventory table with ClassTypeID 12200, not Part table quantities.
- Two-tier confidence model: purchasing data reliable, inventory quantities caveated (Google Sheets migration).

**Verification:** PASSED (11/11 must-haves). All 3 requirements satisfied. 22 SQL queries. GL NodeID 10414 for authoritative valuation ($651K).

### Phase 12: Production Workflow

**Goal**: Users can track artwork approvals, monitor station workload, and analyze production dwell time -- through a new control-erp-production skill
**Depends on**: Phase 11 (soft -- part usage cards reference Part table)
**Requirements**: PROD-01, PROD-02, PROD-03
**Plans**: 2 plans

Plans:
- [x] 12-01-PLAN.md -- Create production skill with table architecture and artwork pipeline queries (PROD-01)
- [x] 12-02-PLAN.md -- Add station workload (PROD-02), station dwell time analysis (PROD-03), and NL routing

**Critical pitfalls:**
- Geography columns in Station table crash SELECT * queries -- must specify columns explicitly.
- Journal table is multi-purpose (5.18M rows) -- must filter JournalActivityType=45 for station-related entries.
- FLS does NOT use TimeCard for per-job tracking -- station dwell time (transition timestamps) is the production time metric.

**Verification:** PASSED (13/13 must-haves). All 3 requirements satisfied. 17 SQL queries. LEAD() window functions for dwell time calculation.

### Phase 13: Glossary Integration + Reports Catalog

**Goal**: Users asking any business question get routed to the correct skill, and users asking about reports get guidance on which Crystal Report to run vs. when to use a custom query
**Depends on**: Phases 9, 10, 11, 12 (routes to ALL domain skills -- must come last)
**Requirements**: RPT-01
**Plans**: 2 plans

Plans:
- [x] 13-01-PLAN.md -- Crystal Reports catalog (36 reports with coverage status) + gap log file
- [x] 13-02-PLAN.md -- Expand NL routing to all 6 domain skills + validate with 25 test queries

**Verification:** PASSED (12/12 must-haves). RPT-01 satisfied. 75 NL routing entries across all 6 domain skills. 100% routing accuracy (25/25 test queries).

---

## Milestone Summary

**Key Decisions:**
- Extend control-erp-financial (not create separate skill) -- 80% of new content builds on existing queries
- Fold reports catalog into control-erp-glossary (not standalone skill) -- too thin for standalone
- Two-tier confidence model for inventory: Primary (PO data) vs Secondary (inventory quantities)
- GL NodeID 10414 is authoritative for inventory valuation, not part-level calculation
- LEAD() window function for production dwell time (not TimeCard)
- Route "top customers" to customers skill (not sales) -- comprehensive ranking with YoY, Pareto
- Overlap resolution rules documented inline (6 explicit rules) vs algorithmic disambiguation

**Issues Resolved:**
- RFM Recency scoring inversion caught by verifier and fixed (ORDER BY Recency DESC)
- Dead cross-reference to non-existent references/customer-analysis.md cleaned up
- TBD markers removed from customer skill

**Issues Deferred:**
- Payment forecast (analytics milestone)
- HR/Payroll queries (future milestone)
- Division-level reporting (future milestone)
- 5 Crystal Reports not yet covered (payroll, service, timecard domains)

**Technical Debt Incurred:**
- COGS is aggregate at GL level; product-line margin uses two-query approach
- Inventory quantities caveated due to Google Sheets migration
- Only 74/392 parts have reorder points configured in Control
- Bottleneck detection thresholds may need calibration against FLS production volume
- Report metadata inferred from filenames, not extracted from Crystal Reports binary

---

_For current project status, see .planning/ROADMAP.md_
