---
phase: 03-wiki-knowledge-formalization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - output/wiki/references/chapi-architecture.md
  - output/wiki/references/crystal-reports-sql-patterns.md
  - output/wiki/references/macro-automation-reference.md
autonomous: true

must_haves:
  truths:
    - "A developer reading chapi-architecture.md can understand how to call CHAPI -- HTTP endpoint URL format, SQL Bridge functions, and available import stored procedures"
    - "Crystal Reports SQL patterns from 13 wiki standard report pages are extracted with actual table names, joins, and filters -- authoritative source, not inferred"
    - "Macro automation reference contains all 95 message types, all RuleAction types, and trigger events in a clean quick-reference format"
  artifacts:
    - path: "output/wiki/references/chapi-architecture.md"
      provides: "Consolidated CHAPI developer reference"
      min_lines: 150
      contains: "12556"
    - path: "output/wiki/references/crystal-reports-sql-patterns.md"
      provides: "Authoritative Crystal Report join patterns from wiki"
      min_lines: 100
      contains: "TransHeader"
    - path: "output/wiki/references/macro-automation-reference.md"
      provides: "Complete macro system quick-reference"
      min_lines: 80
      contains: "RuleAction"
  key_links:
    - from: "output/wiki/references/chapi-architecture.md"
      to: "output/wiki/reference/chapi/"
      via: "Consolidation of 18 CHAPI reference files"
      pattern: "sqlmacro.*name=.*ProcName"
    - from: "output/wiki/references/chapi-architecture.md"
      to: "output/wiki/reference/stored_procedures/"
      via: "Import stored procedure catalog"
      pattern: "import_company|import_contact|import_order"
    - from: "output/wiki/references/crystal-reports-sql-patterns.md"
      to: "output/wiki/reports/*_standard.md"
      via: "Extraction of actual report SQL from wiki pages"
      pattern: "FROM.*JOIN"
    - from: "output/wiki/references/macro-automation-reference.md"
      to: "output/wiki/extracts/macros_automation_knowledge.md"
      via: "Quick-reference formatted from comprehensive extract"
      pattern: "231\\d{2}"
---

<objective>
Formalize three wiki-sourced reference documents: CHAPI architecture, Crystal Reports SQL patterns, and macro automation system (WIKI-03, WIKI-04, WIKI-05).

Purpose: These three references are required by the phase success criteria and are consumed by downstream phases (Phase 5 needs CHAPI for write-path understanding, Phase 8 needs Crystal Reports for DOC-04, Phase 6 needs macro terminology for glossary). The source material already exists in wiki extracts and reference files -- this plan consolidates it into developer-consumable format.

Output: Three formalized reference documents in `output/wiki/references/`.
</objective>

<execution_context>
@/Users/cain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-wiki-knowledge-formalization/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Consolidate CHAPI architecture reference</name>
  <files>output/wiki/references/chapi-architecture.md</files>
  <action>
Create `output/wiki/references/` directory if it does not exist.

Read and synthesize content from these source files into a single consolidated reference:

**Primary sources (read these):**
- `output/wiki/reference/chapi/chapi_url_endpoint_listener.md` -- HTTP endpoint details (port 12556, URL format)
- `output/wiki/reference/chapi/chapi.md` -- Overview
- `output/wiki/reference/sql_bridge/sql_bridge.md` -- SQL Bridge core functions (Lock, Unlock, NextID, NextNumber, Refresh, RefreshEx, Recompute)
- `output/wiki/extracts/database_integration_knowledge.md` -- Synthesized architecture (first ~200 lines for architecture overview)

**Secondary sources (scan for procedure names and signatures):**
- `output/wiki/reference/stored_procedures/` -- 17 files with full T-SQL. Read the first 30-50 lines of each to extract: procedure name, parameters, and purpose. Do NOT copy the full T-SQL into the reference.

Write `output/wiki/references/chapi-architecture.md` with these sections:

1. **Overview**: What CHAPI is (Control HTTP API), when to use it (all write operations), how it relates to SQL Bridge
2. **HTTP Endpoint**: URL format `http://{server}:12556/chapi/sqlmacro?name={ProcName}&{param}={value}`, port 12556, GET/POST semantics
3. **SQL Bridge Core Functions**: Table of all core functions with: function name, purpose, when to call it, parameter signature
   - NextID(ClassTypeID) -- get next ID for new record
   - NextNumber(ClassTypeID) -- get next human-readable number
   - Lock(ClassTypeID, ID) -- lock record for editing
   - Unlock(ClassTypeID, ID) -- release lock
   - Refresh(ClassTypeID, ID) -- tell Control to reload object
   - RefreshEx(ClassTypeID, ID, MacroMessageType) -- refresh with macro trigger
   - Recompute(ClassTypeID, ID) -- recalculate derived fields
4. **Import Stored Procedures Catalog**: Table listing all 17 procedures with: procedure name, purpose, key parameters (not full T-SQL). Procedures:
   - import_company, import_contact, import_order, import_estimate, import_line_item, import_payment, import_address, import_shipping_information, import_shipping_information_detail, import_part, import_part_category, insert_part_on_a_line_item, convert_estimate_to_order, add_note, customer_list_import, quickbooks_import, import_text_file_to_cols
5. **Operation Patterns**: How to perform insert/update/delete (the Lock -> Modify -> Refresh -> Unlock pattern)
6. **Safety Rules**: Critical rules for writes (always use CHAPI, never direct SQL; always Lock before modify; always Refresh after modify)
7. **Source Files**: List of source files this reference was compiled from, for traceability

Do NOT duplicate full T-SQL source code. This is a REFERENCE document, not a code dump.
Do NOT replace or modify any existing files in `output/wiki/reference/`.
  </action>
  <verify>
Verify `output/wiki/references/chapi-architecture.md` exists.
Verify it contains "12556" (port number), "sqlmacro" (endpoint path), "NextID" (SQL Bridge function), and "import_company" (stored procedure).
Verify it has the 7 sections listed above (check for section headers).
  </verify>
  <done>A developer reading chapi-architecture.md understands: how to call CHAPI (URL format + port), what SQL Bridge functions do (all 7 listed with purpose), what import procedures are available (all 17 cataloged), and the Lock-Modify-Refresh-Unlock pattern for safe writes.</done>
</task>

<task type="auto">
  <name>Task 2: Extract Crystal Reports SQL patterns and verify macro reference</name>
  <files>output/wiki/references/crystal-reports-sql-patterns.md, output/wiki/references/macro-automation-reference.md</files>
  <action>
**Part A: Crystal Reports SQL Patterns (WIKI-04)**

Read all 13 `*_standard.md` files from `output/wiki/reports/`:
1. ar_detail_report_standard.md
2. ar_summary_report_standard.md
3. deposits_made_report_standard.md
4. estimate_report_standard.md
5. gl_listing_report_standard.md
6. historical_ar_report_standard.md
7. invoice_report_standard.md
8. orders_placed_between_report_standard.md
9. sales_by_x_report_standard.md
10. sales_report_standard.md
11. wip_and_built_report_standard.md
12. wip_by_line_item_report_standard.md
13. work_order_report_standard.md

For each report, extract into `output/wiki/references/crystal-reports-sql-patterns.md`:
- Report name
- Primary data source (tables/views)
- JOIN patterns (actual table linkages documented by Cyrious)
- WHERE clause patterns (common filters)
- Key display fields
- Parameters accepted

Then add a **Cross-Reference with Inferred Analysis** section:
- For each wiki-documented report, check if a corresponding file exists in `output/reports/` (the inferred analysis)
- Note any discrepancies between wiki-documented (authoritative) and inferred joins
- Specifically flag the Sales Report discrepancy: wiki says GL view is primary source, inferred analysis assumed TransHeader directly
- For the remaining ~23 reports in `output/reports/` that have NO wiki documentation, list them with a note: "Inferred only -- no wiki documentation available for validation"

Finally, add a **Common Join Patterns** summary:
- Extract unique join patterns across all 13 reports
- Group by pattern type (e.g., "TransHeader -> Account via AccountID", "GL -> TransHeader via TransactionID")

**Part B: Macro Automation Quick-Reference (WIKI-05)**

Read `output/wiki/extracts/macros_automation_knowledge.md` (focus on the tables/reference sections).

Create `output/wiki/references/macro-automation-reference.md` as a QUICK-REFERENCE that:
1. Lists all 95 Macro Message Types (IDs 0-94) in a clean table: ID | Name | NeedsAltID | AltID Description
2. Lists all 10 RuleAction types with ClassTypeIDs (231XX range): Type | ClassTypeID | Description
3. Lists all 14 macro categories with entity/table mappings
4. Summarizes trigger events per entity type (compact format)
5. Notes the database tables: RuleMacro, RuleAction, RuleActivity (with key columns, not full schema)

This is a QUICK-REFERENCE reformatting, not new research. The macros_automation_knowledge.md extract already has all this data -- this task structures it into a fast-lookup format.

Do NOT modify any existing files. These are new reference documents only.
  </action>
  <verify>
Verify `output/wiki/references/crystal-reports-sql-patterns.md` exists and contains all 13 report names.
Verify it contains a "Cross-Reference" section mentioning inferred analysis discrepancies.
Verify `output/wiki/references/macro-automation-reference.md` exists and contains "95" (message types), "IDs 0-94", "RuleAction", and ClassTypeIDs in the 231XX range (e.g., 23110, 23120, 23130).
  </verify>
  <done>Crystal Reports SQL patterns are extracted from authoritative wiki sources with cross-reference against inferred analysis. Macro automation quick-reference provides fast lookup for all 95 message types, 10 RuleAction types, and trigger events. Both documents are in output/wiki/references/ ready for downstream consumption.</done>
</task>

</tasks>

<verification>
- `output/wiki/references/chapi-architecture.md` exists with all 7 sections, port 12556, URL format, 7 SQL Bridge functions, 17 stored procedures cataloged
- `output/wiki/references/crystal-reports-sql-patterns.md` exists with 13 wiki-sourced report patterns, cross-reference section, common join patterns summary
- `output/wiki/references/macro-automation-reference.md` exists with 95 message types, 10 RuleAction types, 14 categories, trigger events
- No existing files were modified (only new files in output/wiki/references/)
</verification>

<success_criteria>
- WIKI-03 satisfied: CHAPI architecture reference is developer-consumable -- a reader understands HTTP endpoint, SQL Bridge functions, and available stored procedures
- WIKI-04 satisfied: Crystal Reports SQL patterns extracted from authoritative wiki source, cross-referenced with inferred analysis, discrepancies flagged
- WIKI-05 satisfied: Macro automation system documented with all 95 trigger events and RuleAction types in quick-reference format
</success_criteria>

<output>
After completion, create `.planning/phases/03-wiki-knowledge-formalization/03-02-SUMMARY.md`
</output>
