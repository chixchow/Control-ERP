---
phase: 12-production-workflow
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - skills/control-erp-production/control-erp-production-SKILL.md
autonomous: true

must_haves:
  truths:
    - "User can ask 'what's the workload at [station]' and get WIP counts with dollar values per station, covering both order-level and line-item-level separately"
    - "User can ask 'which stations are backed up' and get bottleneck identification combining WIP count + dwell time"
    - "User can ask 'how long do orders sit in [station]' and get average station dwell time calculated from Journal station transitions (JournalActivityType=45), not TimeCard"
    - "User can see dwell time broken down by order size to identify where large vs small orders slow down"
    - "Station queries correctly handle dual-level model: dual-level stations (1-Approved, 6-Shipping) return both orders and line items; line-item-only stations (2-Production-Embroidery) return only line items"
    - "NL routing table covers all PROD-01, PROD-02, PROD-03 patterns with clear trigger-to-query mapping"
    - "Dwell time queries use LEAD() window function with PARTITION BY TransactionID, ISNULL(LinkID, 0) and 3-month default window"
  artifacts:
    - path: "skills/control-erp-production/control-erp-production-SKILL.md"
      provides: "Station workload queries with dual-level WIP"
      contains: "STATION WORKLOAD"
    - path: "skills/control-erp-production/control-erp-production-SKILL.md"
      provides: "Station dwell time analysis queries"
      contains: "STATION DWELL TIME"
    - path: "skills/control-erp-production/control-erp-production-SKILL.md"
      provides: "Natural language routing table"
      contains: "NATURAL LANGUAGE INTERPRETATION"
    - path: "skills/control-erp-production/control-erp-production-SKILL.md"
      provides: "Station hierarchy reference with classification flags"
      contains: "STATION HIERARCHY"
  key_links:
    - from: "Order-level WIP query"
      to: "TransHeader.StationID -> Station.ID"
      via: "JOIN with StatusID IN (1,2) and TransactionType=1 filter"
      pattern: "TransHeader.*StationID.*Station.*StatusID IN.*1.*2"
    - from: "Line-item-level WIP query"
      to: "TransDetail.StationID -> Station.ID"
      via: "JOIN with parent TransHeader StatusID filter"
      pattern: "TransDetail.*StationID.*Station.*TransHeader.*StatusID"
    - from: "Dwell time calculation"
      to: "Journal.JournalActivityType=45 with LEAD() window"
      via: "PARTITION BY TransactionID, ISNULL(LinkID,0) ORDER BY StartDateTime"
      pattern: "LEAD.*PARTITION BY.*TransactionID.*LinkID.*JournalActivityType = 45"
    - from: "Current WIP dwell"
      to: "COALESCE(next_transition, GETDATE())"
      via: "For items still at a station, dwell = time since last transition"
      pattern: "COALESCE.*GETDATE"
    - from: "Station classification"
      to: "Station.ShowForWIP, ShowForLineItem, ShowForLineWIP flags"
      via: "Flags determine order-level vs line-item-level vs dual"
      pattern: "ShowForWIP.*ShowForLineItem.*ShowForLineWIP"
---

<objective>
Add station workload queries (PROD-02), station dwell time analysis (PROD-03), and natural language routing to the production skill.

Purpose: Station workload and dwell time are tightly coupled -- stations are the common dimension, and bottleneck detection combines count + dwell time. This plan completes the production skill with all three requirements (PROD-01 from Plan 01, PROD-02 and PROD-03 here) and adds the NL routing table.

Output: Extended skill file with station hierarchy reference, WIP workload queries (order-level and line-item-level), dwell time analysis (average dwell, current WIP dwell, dwell by order size), bottleneck detection, and complete NL routing table.
</objective>

<execution_context>
@/Users/cain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-production-workflow/12-CONTEXT.md
@.planning/phases/12-production-workflow/12-RESEARCH.md
@.planning/phases/12-production-workflow/12-01-SUMMARY.md
@skills/control-erp-core/control-erp-core-SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Station Hierarchy Reference and Workload Queries (PROD-02)</name>
  <files>skills/control-erp-production/control-erp-production-SKILL.md</files>
  <action>
Replace the Plan 02 placeholder comment in the skill file with the following sections.

**Section 5: STATION HIERARCHY REFERENCE**

Document the FLS station model with classification logic.

**Station Classification:**
- **Order-level**: `ShowForWIP = 1` or `ShowForBuilt = 1` or `ShowForSale = 1` or `ShowForPendingEstimates = 1`
- **Line-item-level**: `ShowForLineItem = 1` or `ShowForLineWIP = 1` or `ShowForLineBuilt = 1` or `ShowForLineSale = 1`
- **Dual-level (both)**: Station has BOTH order-level and line-item-level flags (e.g., 1-Approved, 0-Design-Proof, 6-Shipping)

**FLS Production Stage Hierarchy:**
Use a table format showing the numbered-stage system:

| Stage | Station Name | ID | Order-Level | LI-Level | TimeClock | Notes |
|-------|-------------|-----|-------------|----------|-----------|-------|
| 0 | 0-Design (dept) | 1016 | -- | -- | -- | Department parent |
| 0 | 0-Design-Preflight | 10004 | WIP, Est | -- | -- | |
| 0 | 0-Design-Need Art | 10002 | WIP, Est | -- | -- | |
| 0 | 0-Design-Request Art | 10003 | WIP, Est | -- | -- | |
| 0 | 0-Design-Proof | 1020 | WIP, Est | LI (all) | Yes | **Dual-level** |
| 0 | 0-Design-Wait for Art | 1012 | WIP, Est | LI (all) | -- | **Dual-level** |
| 0 | 0-Design-Complete | 1069 | WIP | LI (all) | -- | **Dual-level** |
| 1 | 1-Approved | 1024 | WIP, Est | LI (all) | -- | **Dual-level** |
| 1.1 | 1.1 Pre-Production | 10008 | -- | LI (all) | Yes | LI only |
| 2 | 2-Production (dept) | 1025 | WIP | -- | -- | Order-level only |
| 2 | 2-Production-Digital | 1027 | -- | LI (all) | Yes | LI only |
| 2 | 2-Production-West Side | 1073 | -- | LI (all) | Yes | LI only |
| 2 | 2-Production-SP | 1028 | -- | LI (all) | Yes | LI only |
| 2 | 2-Production-DTG | 10001 | -- | LI (all) | Yes | LI only |
| 2 | 2-Production-Garment | 1030 | -- | LI (all) | Yes | LI only |
| 2 | 2-Production-Embroidery | 1031 | -- | LI (all) | Yes | LI only |
| 2 | 2-Production-Contract | 1029 | WIP | LI (all) | -- | **Dual-level** |
| 2 | 2-Production-Press Ons | 1071 | -- | LI (all) | Yes | LI only |
| 2.1 | 2.1-Print In Progress | 10007 | -- | LI (all) | Yes | LI only |
| 3 | 3-Transfer | 1068 | -- | LI (all) | Yes | LI only |
| 4 | 4-Cutting | 1043 | -- | LI (all) | Yes | LI only |
| 5 | 5-Finishing | 1032 | -- | LI (all) | Yes | LI only |
| 6 | 6-Shipping | 1033 | WIP | LI (all) | Yes | **Dual-level** |

**Administrative Stations (non-production):**
Brief list of Hold stations (On-Hold, On-Hold-Artwork, On-Hold-Payment, Out For Approval), Post-production stations (Waiting For Pick-up, Waiting For Shipment, Picked-Up, Shipped, Delivered, Built), and note that Time/Payroll and PO stations exist but are not relevant for production tracking.

**Station Discovery Query:**
```sql
-- Active production-relevant stations (excludes Time/PO stations)
SELECT
    s.ID,
    s.StationName,
    s.SortIndex,
    s.ShowForWIP,
    s.ShowForLineItem,
    s.ShowForLineWIP,
    s.ShowOnTimeClock,
    s.DepartmentID,
    s.MarkLIComplete,
    CASE
        WHEN (s.ShowForWIP = 1 OR s.ShowForBuilt = 1 OR s.ShowForSale = 1)
             AND (s.ShowForLineItem = 1 OR s.ShowForLineWIP = 1)
        THEN 'Dual (order + line item)'
        WHEN s.ShowForWIP = 1 OR s.ShowForBuilt = 1 OR s.ShowForSale = 1
        THEN 'Order-level'
        WHEN s.ShowForLineItem = 1 OR s.ShowForLineWIP = 1
        THEN 'Line-item-level'
        ELSE 'Other'
    END AS StationLevel
FROM Station s
WHERE s.IsActive = 1
    AND s.ID NOT IN (200, 201, 202, 1001, 1002, 1004, 1005, 1006, 1007, 1008)  -- Exclude Time/PTO stations
    AND s.ID NOT BETWEEN 100 AND 110  -- Exclude PO lifecycle stations
ORDER BY s.SortIndex
```
Note: NEVER use SELECT * on Station (geography columns crash). This query explicitly lists safe columns.

**Section 6: STATION WORKLOAD QUERIES (PROD-02)**

6a. **Order-Level WIP by Station (stage summary)**
```sql
SELECT
    s.StationName,
    s.SortIndex,
    COUNT(*) AS OrderCount,
    SUM(th.SubTotalPrice) AS TotalRevenue,
    MIN(th.DueDate) AS EarliestDueDate,
    MAX(DATEDIFF(day, th.OrderCreatedDate, GETDATE())) AS OldestOrderDays
FROM TransHeader th
JOIN Station s ON th.StationID = s.ID
WHERE th.TransactionType = 1
  AND th.StatusID IN (1, 2)
  AND th.IsActive = 1
GROUP BY s.StationName, s.SortIndex
ORDER BY s.SortIndex
```
Add formatting guidance:
- Present as a pipeline view sorted by stage (SortIndex)
- For each station: "**[StationName]**: [OrderCount] orders ($[TotalRevenue]) -- earliest due: [EarliestDueDate]"
- Summary line: "**Total WIP**: [sum] orders across [station count] stations"
- Reference: FLS current WIP is ~67 orders (2-Production: 40, 0-Design-Proof: 14, Out For Approval: 6)

6b. **Line-Item-Level WIP by Station**
```sql
SELECT
    s.StationName,
    s.SortIndex,
    COUNT(*) AS LineItemCount,
    SUM(td.MeAndSonsSubTotalPrice) AS TotalValue,
    COUNT(DISTINCT td.TransHeaderID) AS OrdersRepresented
FROM TransDetail td
JOIN Station s ON td.StationID = s.ID
JOIN TransHeader th ON td.TransHeaderID = th.ID
WHERE th.TransactionType = 1
  AND th.StatusID IN (1, 2)
  AND th.IsActive = 1
  AND td.IsActive = 1
  AND td.ParentID = th.ID  -- Top-level line items only (avoids sub-items)
GROUP BY s.StationName, s.SortIndex
ORDER BY s.SortIndex
```
Note: `ParentID = th.ID` filters to top-level line items only (children of the header, not sub-line-items). This prevents double-counting from assembly/sub-item structures.
Reference: FLS current LI WIP is ~116 items (Waiting For Shipment: 42, 0-Design-Proof: 37, 2-Production-Embroidery: 12)

6c. **Specific Station Detail (order list for a station)**
For when user asks "what's at [station]" or "show me [station] queue":
```sql
-- Order-level detail for a specific station
SELECT
    th.OrderNumber,
    a.CompanyName AS Customer,
    th.SubTotalPrice AS OrderValue,
    th.DueDate,
    DATEDIFF(day, th.OrderCreatedDate, GETDATE()) AS OrderAgeDays,
    th.StatusID
FROM TransHeader th
JOIN Station s ON th.StationID = s.ID
JOIN Account a ON th.AccountID = a.ID
WHERE th.TransactionType = 1
  AND th.StatusID IN (1, 2)
  AND th.IsActive = 1
  AND s.StationName LIKE '%station_name%'
ORDER BY th.DueDate ASC

-- Line-item detail for a specific station
SELECT
    th.OrderNumber,
    a.CompanyName AS Customer,
    td.Description AS LineItem,
    td.Quantity,
    td.MeAndSonsSubTotalPrice AS LineValue,
    s.StationName
FROM TransDetail td
JOIN Station s ON td.StationID = s.ID
JOIN TransHeader th ON td.TransHeaderID = th.ID
JOIN Account a ON th.AccountID = a.ID
WHERE th.TransactionType = 1
  AND th.StatusID IN (1, 2)
  AND th.IsActive = 1
  AND td.IsActive = 1
  AND s.StationName LIKE '%station_name%'
ORDER BY th.OrderNumber, td.SortOrder
```
Add guidance: When the user names a station, search by LIKE pattern against StationName. For dual-level stations (e.g., 1-Approved, 6-Shipping), run BOTH queries and present both views. For line-item-only stations (e.g., 2-Production-Embroidery), only run the line-item query.

6d. **Stage-Level Summary (combined order + line-item view)**
For an overview grouped by numbered stage:
```sql
-- Parse stage number from station name prefix
SELECT
    CASE
        WHEN s.StationName LIKE '0-%' THEN '0-Design'
        WHEN s.StationName LIKE '1-%' OR s.StationName = '1-Approved' THEN '1-Approved'
        WHEN s.StationName LIKE '1.1%' THEN '1.1-Pre-Production'
        WHEN s.StationName LIKE '2-%' THEN '2-Production'
        WHEN s.StationName LIKE '2.1%' THEN '2.1-Print In Progress'
        WHEN s.StationName LIKE '3-%' THEN '3-Transfer'
        WHEN s.StationName LIKE '4-%' THEN '4-Cutting'
        WHEN s.StationName LIKE '5-%' THEN '5-Finishing'
        WHEN s.StationName LIKE '6-%' THEN '6-Shipping'
        ELSE 'Other (' + s.StationName + ')'
    END AS Stage,
    COUNT(DISTINCT th.ID) AS WIPOrders,
    SUM(th.SubTotalPrice) AS TotalOrderValue
FROM TransHeader th
JOIN Station s ON th.StationID = s.ID
WHERE th.TransactionType = 1
  AND th.StatusID IN (1, 2)
  AND th.IsActive = 1
GROUP BY
    CASE
        WHEN s.StationName LIKE '0-%' THEN '0-Design'
        WHEN s.StationName LIKE '1-%' OR s.StationName = '1-Approved' THEN '1-Approved'
        WHEN s.StationName LIKE '1.1%' THEN '1.1-Pre-Production'
        WHEN s.StationName LIKE '2-%' THEN '2-Production'
        WHEN s.StationName LIKE '2.1%' THEN '2.1-Print In Progress'
        WHEN s.StationName LIKE '3-%' THEN '3-Transfer'
        WHEN s.StationName LIKE '4-%' THEN '4-Cutting'
        WHEN s.StationName LIKE '5-%' THEN '5-Finishing'
        WHEN s.StationName LIKE '6-%' THEN '6-Shipping'
        ELSE 'Other (' + s.StationName + ')'
    END
ORDER BY MIN(s.SortIndex)
```
Note: This gives a high-level pipeline view. The CASE statement groups substations into their parent stage. For detailed substation breakdown, use queries 6a/6b.

CRITICAL REMINDERS for the executor:
- Always filter TransactionType=1 and StatusID IN (1,2) for WIP
- Always use ParentID = th.ID for top-level line items
- Never SELECT * from Station
- For dual-level stations, present both order and line-item views
- For line-item-only stations, only present line-item view
  </action>
  <verify>
1. Section 5 (STATION HIERARCHY) has complete stage table with all numbered stages 0-6
2. Station classification logic documented (Order-level, LI-level, Dual-level)
3. Station discovery query specifies columns explicitly (no SELECT *)
4. Administrative stations (Hold, Post-production) listed separately
5. Section 6 (STATION WORKLOAD) has 4 subsections: order-level WIP (6a), LI-level WIP (6b), specific station detail (6c), stage summary (6d)
6. Order-level WIP query uses TransHeader.StationID with StatusID IN (1,2)
7. LI-level WIP query uses TransDetail.StationID with ParentID = th.ID filter
8. Specific station detail has BOTH order and LI queries with guidance on when to use each
9. Stage summary groups substations into parent stages via CASE statement
10. Reference WIP counts included (67 orders, 116 line items)
11. Formatting guidance explains pipeline view presentation
  </verify>
  <done>PROD-02 covered with station hierarchy reference (complete stage table, classification logic, discovery query) and 4 workload query templates (order-level WIP, LI-level WIP, station detail with dual-level guidance, stage-level summary). All queries use correct WIP filters and avoid Station SELECT *.</done>
</task>

<task type="auto">
  <name>Task 2: Add Station Dwell Time Analysis (PROD-03) and NL Routing</name>
  <files>skills/control-erp-production/control-erp-production-SKILL.md</files>
  <action>
Append the remaining sections to the skill file.

**Section 7: STATION DWELL TIME ANALYSIS (PROD-03)**

Add a section intro explaining the dwell time methodology:
- Station dwell time = time between consecutive station transitions in the Journal table
- Journal records: JournalActivityType=45, StationID = new station (moved TO), LinkID = TransDetail.ID for LI-level (NULL for order-level)
- EndDateTime is ALWAYS NULL -- dwell is calculated as delta between consecutive StartDateTime values using LEAD() window function
- Always filter by date range (1.06M station change records total). Default: 3-month rolling window.
- For items still at their current station (no next transition), use COALESCE(next_transition, GETDATE())
- The business goal: 1-business-day turnaround per station

7a. **Average Dwell Time by Station (order-level, last 3 months)**
```sql
WITH OrderTransitions AS (
    SELECT
        j.TransactionID,
        j.StationID,
        s.StationName,
        s.SortIndex,
        j.StartDateTime AS ArrivedAt,
        LEAD(j.StartDateTime) OVER (
            PARTITION BY j.TransactionID
            ORDER BY j.StartDateTime
        ) AS LeftAt
    FROM Journal j
    JOIN Station s ON j.StationID = s.ID
    WHERE j.JournalActivityType = 45
      AND j.LinkID IS NULL  -- order-level only
      AND j.StartDateTime > DATEADD(month, -3, GETDATE())
)
SELECT
    StationName,
    COUNT(*) AS TransitionCount,
    AVG(DATEDIFF(minute, ArrivedAt, LeftAt)) / 60.0 AS AvgDwellHours,
    AVG(DATEDIFF(minute, ArrivedAt, LeftAt)) / 1440.0 AS AvgDwellDays,
    MAX(DATEDIFF(minute, ArrivedAt, LeftAt)) / 1440.0 AS MaxDwellDays,
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY DATEDIFF(minute, ArrivedAt, LeftAt))
        OVER (PARTITION BY StationName) / 1440.0 AS MedianDwellDays
FROM OrderTransitions
WHERE LeftAt IS NOT NULL  -- exclude items still at the station
GROUP BY StationName, SortIndex
HAVING COUNT(*) > 10  -- minimum sample size
ORDER BY SortIndex
```
Note: If PERCENTILE_CONT causes issues (it requires OVER clause in some SQL Server versions), fall back to AVG only. The median is more representative than the mean because a few long-running orders can skew averages heavily.

Add formatting guidance:
- Present as a table: "**[StationName]**: avg [AvgDwellHours]h (median [MedianDwellDays]d, max [MaxDwellDays]d) -- [TransitionCount] transitions"
- Flag stations where AvgDwellDays > 1 as exceeding the 1-business-day goal
- Reference: 2-Production has the longest dwell (days to weeks), 6-Shipping is fast (~1-4 hours)

7b. **Average Dwell Time by Station (line-item-level, last 3 months)**
```sql
WITH LITransitions AS (
    SELECT
        j.TransactionID,
        j.LinkID,
        j.StationID,
        s.StationName,
        s.SortIndex,
        j.StartDateTime AS ArrivedAt,
        LEAD(j.StartDateTime) OVER (
            PARTITION BY j.TransactionID, j.LinkID
            ORDER BY j.StartDateTime
        ) AS LeftAt
    FROM Journal j
    JOIN Station s ON j.StationID = s.ID
    WHERE j.JournalActivityType = 45
      AND j.LinkID IS NOT NULL  -- line-item-level only
      AND j.StartDateTime > DATEADD(month, -3, GETDATE())
)
SELECT
    StationName,
    COUNT(*) AS TransitionCount,
    AVG(DATEDIFF(minute, ArrivedAt, LeftAt)) / 60.0 AS AvgDwellHours,
    AVG(DATEDIFF(minute, ArrivedAt, LeftAt)) / 1440.0 AS AvgDwellDays,
    MAX(DATEDIFF(minute, ArrivedAt, LeftAt)) / 1440.0 AS MaxDwellDays
FROM LITransitions
WHERE LeftAt IS NOT NULL
GROUP BY StationName, SortIndex
HAVING COUNT(*) > 10
ORDER BY SortIndex
```

7c. **Current WIP Dwell Time (how long have current items been at their station)**
For items currently in production -- how long have they been sitting:
```sql
-- Order-level: current station dwell for WIP orders
SELECT
    th.OrderNumber,
    a.CompanyName AS Customer,
    s.StationName AS CurrentStation,
    th.SubTotalPrice AS OrderValue,
    j_last.StartDateTime AS ArrivedAtStation,
    DATEDIFF(hour, j_last.StartDateTime, GETDATE()) AS HoursAtStation,
    DATEDIFF(hour, j_last.StartDateTime, GETDATE()) / 24.0 AS DaysAtStation,
    th.DueDate
FROM TransHeader th
JOIN Station s ON th.StationID = s.ID
JOIN Account a ON th.AccountID = a.ID
CROSS APPLY (
    SELECT TOP 1 j.StartDateTime
    FROM Journal j
    WHERE j.JournalActivityType = 45
      AND j.TransactionID = th.ID
      AND j.LinkID IS NULL
    ORDER BY j.StartDateTime DESC
) j_last
WHERE th.TransactionType = 1
  AND th.StatusID IN (1, 2)
  AND th.IsActive = 1
ORDER BY DATEDIFF(hour, j_last.StartDateTime, GETDATE()) DESC
```
Add formatting guidance:
- Show longest-sitting orders first
- Flag items exceeding 1 business day (24 hours) as "OVER GOAL"
- Flag items exceeding 7 days as "CRITICAL"
- Include DueDate context: if DueDate is past, flag as "PAST DUE"

7d. **Dwell Time by Order Size (identify where large vs small orders slow down)**
Bucket orders by SubTotalPrice and compare dwell times:
```sql
WITH OrderTransitions AS (
    SELECT
        j.TransactionID,
        j.StationID,
        s.StationName,
        s.SortIndex,
        j.StartDateTime AS ArrivedAt,
        LEAD(j.StartDateTime) OVER (
            PARTITION BY j.TransactionID
            ORDER BY j.StartDateTime
        ) AS LeftAt,
        th.SubTotalPrice
    FROM Journal j
    JOIN Station s ON j.StationID = s.ID
    JOIN TransHeader th ON j.TransactionID = th.ID
    WHERE j.JournalActivityType = 45
      AND j.LinkID IS NULL
      AND j.StartDateTime > DATEADD(month, -3, GETDATE())
      AND th.TransactionType = 1
)
SELECT
    StationName,
    CASE
        WHEN SubTotalPrice < 500 THEN 'Small (<$500)'
        WHEN SubTotalPrice < 2000 THEN 'Medium ($500-$2K)'
        WHEN SubTotalPrice < 5000 THEN 'Large ($2K-$5K)'
        ELSE 'XL ($5K+)'
    END AS OrderSize,
    COUNT(*) AS Transitions,
    AVG(DATEDIFF(minute, ArrivedAt, LeftAt)) / 60.0 AS AvgDwellHours,
    AVG(DATEDIFF(minute, ArrivedAt, LeftAt)) / 1440.0 AS AvgDwellDays
FROM OrderTransitions
WHERE LeftAt IS NOT NULL
GROUP BY StationName, SortIndex,
    CASE
        WHEN SubTotalPrice < 500 THEN 'Small (<$500)'
        WHEN SubTotalPrice < 2000 THEN 'Medium ($500-$2K)'
        WHEN SubTotalPrice < 5000 THEN 'Large ($2K-$5K)'
        ELSE 'XL ($5K+)'
    END
HAVING COUNT(*) > 5
ORDER BY SortIndex,
    CASE
        WHEN SubTotalPrice < 500 THEN 1
        WHEN SubTotalPrice < 2000 THEN 2
        WHEN SubTotalPrice < 5000 THEN 3
        ELSE 4
    END
```
Note: This answers the user's key question: "do large orders slow down at certain stations?" Size buckets can be adjusted based on FLS order distribution. The HAVING > 5 filter ensures minimum sample sizes.

7e. **Bottleneck Detection (combines WIP count + dwell time)**
This is the "which stations are backed up" query -- combines count AND dwell:
```sql
WITH CurrentDwell AS (
    SELECT
        th.StationID,
        DATEDIFF(hour,
            (SELECT TOP 1 j.StartDateTime FROM Journal j
             WHERE j.JournalActivityType = 45 AND j.TransactionID = th.ID AND j.LinkID IS NULL
             ORDER BY j.StartDateTime DESC),
            GETDATE()
        ) AS HoursAtStation
    FROM TransHeader th
    WHERE th.TransactionType = 1
      AND th.StatusID IN (1, 2)
      AND th.IsActive = 1
)
SELECT
    s.StationName,
    COUNT(*) AS WIPCount,
    SUM(th.SubTotalPrice) AS TotalValue,
    AVG(cd.HoursAtStation) AS AvgHoursAtStation,
    AVG(cd.HoursAtStation) / 24.0 AS AvgDaysAtStation,
    MAX(cd.HoursAtStation) / 24.0 AS MaxDaysAtStation,
    CASE
        WHEN COUNT(*) >= 10 AND AVG(cd.HoursAtStation) > 48 THEN 'CRITICAL BOTTLENECK'
        WHEN COUNT(*) >= 5 AND AVG(cd.HoursAtStation) > 24 THEN 'BOTTLENECK'
        WHEN AVG(cd.HoursAtStation) > 48 THEN 'SLOW (low volume)'
        ELSE 'OK'
    END AS BottleneckStatus
FROM TransHeader th
JOIN Station s ON th.StationID = s.ID
JOIN CurrentDwell cd ON cd.StationID = th.StationID
WHERE th.TransactionType = 1
  AND th.StatusID IN (1, 2)
  AND th.IsActive = 1
GROUP BY s.StationName, s.SortIndex
ORDER BY
    CASE
        WHEN COUNT(*) >= 10 AND AVG(cd.HoursAtStation) > 48 THEN 1
        WHEN COUNT(*) >= 5 AND AVG(cd.HoursAtStation) > 24 THEN 2
        WHEN AVG(cd.HoursAtStation) > 48 THEN 3
        ELSE 4
    END,
    COUNT(*) DESC
```
Note: Bottleneck = high WIP count AND long dwell time. A station with 2 orders sitting for a week is "slow" not "bottlenecked". A station with 40 orders sitting for 3 days is a bottleneck. The thresholds (count >= 5/10, hours > 24/48) can be adjusted. For the ORDER BY, the executor should use a subquery or rewrite as needed if the server-level SQL does not allow aggregates in ORDER BY CASE -- wrap in a CTE if necessary.

**Section 8: NATURAL LANGUAGE INTERPRETATION**

Create the complete NL routing table:

| User Says | Route To | Section |
|-----------|----------|---------|
| "show me the artwork pipeline" / "artwork status" / "proof status" | Artwork Pipeline Summary | 4a |
| "pending approvals" / "what artwork needs approval" | Artwork Drill-Down (StatusID=3) | 4b |
| "artwork in design" / "what's being designed" | Artwork Drill-Down (StatusID=1) | 4b |
| "rejected artwork" / "what was rejected" | Artwork Drill-Down (StatusID=10) | 4b |
| "stuck artwork" / "overdue artwork" / "artwork taking too long" | Stuck Artwork Detection | 4c |
| "artwork turnaround time" / "how long does approval take" | Artwork Turnaround | 4d |
| "turnaround trend" / "are we getting faster" | Turnaround Trend | 4e |
| "revision rate" / "how often do proofs get rejected" | Revision Rate Analysis | 4f |
| "what is [designer] working on" / "artwork by designer" | Artwork by Designer | 4g |
| "artwork for order [number]" / "proof status for [order]" | Artwork with Line Items | 4h |
| "what's in production" / "WIP" / "work in progress" | Order-Level WIP by Station | 6a |
| "line items in production" / "line item WIP" | LI-Level WIP by Station | 6b |
| "what's at [station]" / "[station] queue" / "show me [station]" | Station Detail | 6c |
| "pipeline overview" / "stage summary" / "production stages" | Stage-Level Summary | 6d |
| "which stations are backed up" / "bottlenecks" / "where are we stuck" | Bottleneck Detection | 7e |
| "how long at [station]" / "dwell time" / "station dwell" | Avg Dwell Time (order) | 7a |
| "line item dwell time" / "line item processing time" | Avg Dwell Time (LI) | 7b |
| "how long have current orders been sitting" / "current WIP age" | Current WIP Dwell | 7c |
| "do large orders take longer" / "dwell by order size" | Dwell by Order Size | 7d |
| "station list" / "what stations do we have" | Station Discovery | 5 |
| "what's the workload at [station]" | Station Detail (6c) + Dwell (7a/7b) combined | 6c+7a |

**Cross-Skill Routing:**
- "order detail for [number]" / "order status" -> Redirect to control-erp-sales or control-erp-core (order lookup)
- "customer artwork history" / "all artwork for [customer]" -> Use 4b with AccountID filter added
- "inventory for [part]" / "stock levels" -> Redirect to control-erp-inventory
- "time card" / "hours worked" / "employee time" -> Not in this skill; FLS does not track per-job time; redirect to payroll if asking about employee hours

**Key Ambiguity Resolution:**
- "what's in production" -> 6a (order-level WIP by station, most common intent)
- "production status for order X" -> 6c (specific station detail) + 4h (artwork if relevant)
- "what's backed up" / "bottleneck" -> 7e (bottleneck detection combining count + dwell)
- "workload at [X]" -> 6c (WIP detail) + 7a/7b (dwell context)

**Section 9: FORMATTING & RESPONSE GUIDELINES**

Document standard formatting patterns:
- **Summary views**: Show counts and dollar totals, rounded to dollars ($1,234). No individual order numbers.
- **Detail views**: Show order numbers, customer names, individual dollar amounts with cents ($1,234.56).
- **Dwell times**: Show in hours for < 24h, days for >= 24h. Always note the 1-business-day goal.
- **Default scope**: Active/open items only. Completed work shown only on explicit request.
- **Currency**: Rounded in summaries, precise in detail views.
- **Station names**: Always use the full station name from the database (e.g., "2-Production-Embroidery", not "Embroidery").
- **Dual-level context**: When showing a dual-level station, always note: "This station tracks both orders and line items. [N] orders and [M] line items are currently here."

CRITICAL REMINDERS for the executor:
- Always use LEAD() with PARTITION BY TransactionID, ISNULL(LinkID, 0) for dwell
- Always filter JournalActivityType = 45 AND date range for Journal
- Use COALESCE(next_transition, GETDATE()) for current WIP dwell
- Never SELECT * from Station
- Bottleneck = count + dwell combined, not just one
  </action>
  <verify>
1. Section 7 (STATION DWELL TIME) has 5 subsections: avg order dwell (7a), avg LI dwell (7b), current WIP dwell (7c), dwell by order size (7d), bottleneck detection (7e)
2. Dwell methodology documented (LEAD window, JournalActivityType=45, LinkID=NULL for order-level)
3. All dwell queries use 3-month rolling window (DATEADD(month, -3, GETDATE()))
4. All dwell queries PARTITION BY TransactionID (plus LinkID for LI queries)
5. Current WIP dwell uses CROSS APPLY for most recent Journal entry
6. Dwell by order size has 4 size buckets with minimum sample filter
7. Bottleneck detection combines WIP count + dwell time with severity levels
8. 1-business-day goal referenced in formatting guidance
9. Section 8 (NL INTERPRETATION) has 21+ trigger patterns covering all PROD-01, PROD-02, PROD-03 sections
10. Cross-skill routing documented (sales, inventory, payroll)
11. Key ambiguity resolution documented
12. Section 9 (FORMATTING) has standard patterns for summaries vs detail views
13. Plan 02 placeholder removed (replaced with actual content)
  </verify>
  <done>PROD-02 and PROD-03 fully covered: station hierarchy with classification logic, 4 WIP workload queries (order-level, LI-level, station detail, stage summary), 5 dwell time queries (avg order, avg LI, current WIP, by order size, bottleneck detection). NL routing table maps 21+ trigger phrases. Cross-skill routing and ambiguity resolution documented. Formatting guidelines standardized. Production skill file complete for all three requirements (PROD-01, PROD-02, PROD-03).</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. skills/control-erp-production/control-erp-production-SKILL.md is complete with 9 sections
2. Station hierarchy reference includes complete stage table (0-6) with classification flags
3. Station discovery query specifies columns explicitly (no SELECT *)
4. Order-level WIP uses TransHeader.StationID with correct WIP filters
5. Line-item WIP uses TransDetail.StationID with ParentID = th.ID
6. Dual-level station guidance present (run both queries for dual-level, LI-only for LI-only)
7. Dwell time uses LEAD() with PARTITION BY TransactionID, ISNULL(LinkID, 0)
8. All Journal queries filter JournalActivityType=45 AND date range
9. Current WIP dwell calculates time since last station transition
10. Dwell by order size has meaningful size buckets
11. Bottleneck detection combines count + dwell with severity thresholds
12. NL routing covers all 3 requirements (21+ patterns)
13. Cross-skill routing to sales, inventory, payroll documented
14. Formatting guidelines standardize summary vs detail presentation
</verification>

<success_criteria>
- PROD-02 fully covered: station workload at both order and line-item level, stage summary, station detail, dual-level handling
- PROD-03 fully covered: dwell time analysis with order/LI separation, current WIP dwell, order size breakdown, bottleneck detection
- Station dwell uses Journal transitions (NOT TimeCard)
- 1-business-day turnaround goal referenced throughout
- NL routing covers all PROD-01, PROD-02, PROD-03 patterns
- Cross-skill boundaries documented
- Complete skill file ready for deployment covering PROD-01, PROD-02, PROD-03
</success_criteria>

<output>
After completion, create `.planning/phases/12-production-workflow/12-02-SUMMARY.md`
</output>
