---
phase: 08-documentation-milestone-close
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - output/docs/crystal-reports-catalog.md
  - output/docs/known-gotchas.md
autonomous: true

must_haves:
  truths:
    - "A future session can look up any Crystal Report by name and find its filename, menu location, and whether it uses a system report template"
    - "The Crystal Reports catalog clearly states that .rpt SQL extraction is deferred to Milestone 2"
    - "All 13 known gotchas are documented with wrong pattern, correct pattern, and quantified impact"
    - "The gotchas document is a flat numbered list — no severity grouping, no categories"
    - "Each gotcha cites the specific skill file and line/section that prevents the error"
  artifacts:
    - path: "output/docs/crystal-reports-catalog.md"
      provides: "DOC-04 — Crystal Reports catalog from ReportMenuItem metadata"
      contains: "DropShipInvoice"
    - path: "output/docs/known-gotchas.md"
      provides: "DOC-05 — flat numbered list of 13 known gotchas with wrong/correct patterns"
      contains: "TransDetailParam"
  key_links:
    - from: "output/docs/known-gotchas.md"
      to: "skills/control-erp-core/control-erp-core-SKILL.md"
      via: "line/section citations for each gotcha"
    - from: "output/docs/crystal-reports-catalog.md"
      to: "output/reports/"
      via: "cross-references to individual report analysis files"
---

<objective>
Create the Crystal Reports catalog (DOC-04) and known gotchas document (DOC-05) — reference documents for report routing and error prevention.

Purpose: Crystal Reports catalog answers "does a built-in report already exist for this?" before writing custom queries. Known gotchas prevent future sessions from repeating costly errors ($1.3M+ in aggregate).

Output: Two markdown files in output/docs/ — one catalog from database metadata, one flat list of validated gotchas.
</objective>

<execution_context>
@/Users/cain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-documentation-milestone-close/08-CONTEXT.md
@.planning/phases/08-documentation-milestone-close/08-RESEARCH.md

Source files:
@output/report_summary.md
@output/schemas/ReportMenuItem.md
@output/wiki/references/crystal-reports-sql-patterns.md
@validation/milestone1-scorecard.md
@skills/control-erp-core/control-erp-core-SKILL.md
@skills/control-erp-sales/control-erp-sales-SKILL.md
@skills/control-erp-financial/control-erp-financial-SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Crystal Reports catalog (DOC-04)</name>
  <files>output/docs/crystal-reports-catalog.md</files>
  <action>
Create `output/docs/crystal-reports-catalog.md` by querying the ReportMenuItem table via MCP and synthesizing with existing report analysis docs.

**Step 1: Query ReportMenuItem table**
Execute this query via MCP mssql read_data tool:
```sql
SELECT DISTINCT
    rmi.MenuItemName,
    rmi.FileName,
    rmi.UseSystemReport,
    rmi.SystemReportID,
    parent.MenuItemName AS ParentMenu,
    rmi.IsActive,
    rmi.IsSystem
FROM ReportMenuItem rmi
LEFT JOIN ReportMenuItem parent ON rmi.ParentID = parent.ID
WHERE rmi.FileName IS NOT NULL OR rmi.UseSystemReport = 1
ORDER BY parent.MenuItemName, rmi.MenuItemName
```

If MCP is unavailable (Mac environment), fall back to existing `output/report_summary.md` (36 reports) and `output/schemas/ReportMenuItem.md` (table structure). Note the fallback in the document.

**Step 2: Structure the catalog**

1. **Overview** — How many reports exist, where they live in the menu, and the two types (custom .rpt files vs system report templates).

2. **Report Catalog Table** — All reports from the query, formatted as:
   | Report Name | Filename | Menu Location | System Report | Active | Notes |

3. **Most-Used Reports** — Highlight DropShipInvoice.rpt (450 menu items), any other high-frequency reports.

4. **System Reports** — List reports using UseSystemReport=true with their SystemReportID. Cross-reference with `output/schemas/CrystalSystemReports.md` if available.

5. **When to Use Reports vs Custom Queries** — Guidance section:
   - Use built-in report when: exact format needed, customer-facing document (invoice, packing slip), regulatory/tax document
   - Use custom query when: ad-hoc analysis, combining data from multiple domains, data not covered by existing reports, aggregation/trending
   - Reference skill templates for common custom query patterns

6. **Wiki-Documented Report SQL** — Cross-reference the 13 reports documented in `output/wiki/references/crystal-reports-sql-patterns.md` with their menu entries.

7. **Milestone 2 Deferred Items** — Explicitly note:
   - .rpt file SQL extraction requires Visual Studio on Windows machine
   - Once extracted, SQL will be cross-referenced with skill query patterns
   - RPT-01 requirement (Crystal Report catalog skill with routing logic) targets M2

Also cross-reference individual report analyses in `output/reports/*.md` where they exist (list which reports have detailed analysis docs).

Target ~150-250 lines.
  </action>
  <verify>
Verify the file exists and contains:
- A report catalog table with at least 20 entries
- A section mentioning DropShipInvoice
- A "When to Use Reports vs Custom Queries" section
- A "Milestone 2" or "Deferred" section noting .rpt extraction is deferred
- File length between 100-300 lines
  </verify>
  <done>
output/docs/crystal-reports-catalog.md exists with report catalog from ReportMenuItem data, usage guidance, wiki cross-references, and M2 deferral note. DOC-04 requirement satisfied.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create known gotchas document (DOC-05)</name>
  <files>output/docs/known-gotchas.md</files>
  <action>
Create `output/docs/known-gotchas.md` as a flat numbered list of all 13 known gotchas from RESEARCH.md sources. Per CONTEXT.md: flat numbered list, wrong/correct patterns, no severity grouping.

For each gotcha, use this template:
```
N. **[Short name]**
   - WRONG: `[incorrect code/approach]`
   - CORRECT: `[correct code/approach]`
   - Impact: [quantified impact — dollar amount, record count, or failure mode]
   - Skill reference: [skill file, section/line]
```

**The 13 gotchas (from RESEARCH.md section "DOC-05: Known Gotchas"):**

1. **TransDetailParam IsActive Filter** — WRONG: `WHERE tdp.IsActive = 1` → CORRECT: No IsActive filter on TransDetailParam → Impact: $1.33M revenue undercount (DyeSub shows $464K instead of $1,793K) → core skill lines 120-125, sales skill line 147

2. **SubTotalPrice vs TotalPrice** — WRONG: `SUM(TotalPrice)` → CORRECT: `SUM(SubTotalPrice)` → Impact: $11.6K overcount (includes tax) → core skill Revenue Query Formula section

3. **SaleDate vs OrderCreatedDate** — WRONG: `WHERE OrderCreatedDate BETWEEN...` → CORRECT: `WHERE SaleDate BETWEEN...` → Impact: Wrong time period assignment (orders attributed to creation date, not sale date) → core skill Date Filtering section

4. **EstimateCreatedDate for Type 2** — WRONG: `WHERE SaleDate BETWEEN...` on Type 2 → CORRECT: `WHERE EstimateCreatedDate BETWEEN...` → Impact: Zero results (SaleDate and OrderCreatedDate are always NULL on Type 2) → core skill Date Filtering section

5. **SaleDate IS NOT NULL filter** — WRONG: `WHERE TransactionType = 1` (no SaleDate filter) → CORRECT: `WHERE TransactionType = 1 AND SaleDate IS NOT NULL` → Impact: Includes WIP/Built orders that aren't yet sales → core skill Revenue Query Formula

6. **CompanyName not AccountName** — WRONG: `SELECT AccountName FROM Account` → CORRECT: `SELECT CompanyName FROM Account` → Impact: Query failure (column doesn't exist) → MEMORY.md

7. **DueDate means different things by type** — WRONG: Treating DueDate uniformly for AR aging → CORRECT: Understand DueDate semantics vary by TransactionType → Impact: Incorrect aging buckets → financial skill Caveat 2

8. **GL view vs Ledger table** — WRONG: Using GL view for comprehensive ledger analysis → CORRECT: Use Ledger table directly (GL view excludes off-balance-sheet entries) → Impact: Missing ~307K entries (11% of Ledger, cost accounting entries) → financial skill Caveat 1

9. **Web order deduplication** — WRONG: Counting WebOrderID without deduplication → CORRECT: Use DISTINCT WebOrderID or check for duplicate patterns → Impact: 8.4% overcount of web orders → scorecard Test 5.1, core skill web order section

10. **Header vs Detail revenue gap** — WRONG: Expecting TransHeader.SubTotalPrice = SUM(TransDetail.SubTotalPrice) → CORRECT: Accept ~$7K gap due to rounding/adjustments; use header-level for totals → Impact: ~$7K discrepancy causes false alarm → sales skill Caveat 1

11. **Type 2 in revenue totals** — WRONG: Counting Type 2 (estimates) in revenue → CORRECT: Filter to TransactionType = 1 only for revenue → Impact: Double-counting (estimate + converted order both counted) → core skill TransactionType section

12. **TC_ variables not in TransDetailParam** — WRONG: Looking for table cover variables in TransDetailParam → CORRECT: Use Description pattern matching for table cover identification → Impact: Zero results for table cover product queries → sales skill Table Cover section (lines 62-63)

13. **pre-2017 SQL Server (no STRING_AGG)** — WRONG: Using STRING_AGG() in queries → CORRECT: Use FOR XML PATH or STUFF...FOR XML PATH for string concatenation → Impact: Query syntax error → CLAUDE.md, SKILL.md line 21

Add a brief header explaining: "These gotchas were discovered and validated during Milestone 1 development. Each represents a real error that produced incorrect results. The wrong/correct patterns and impact magnitudes are validated against actual database queries."

Add a brief footer: "All gotchas are actively prevented by the skill files referenced above. Loading the appropriate skill before querying ensures these errors are avoided."

Target ~100-180 lines. Keep it tight — the value is in the patterns, not explanation.
  </action>
  <verify>
Verify the file exists and contains:
- Exactly 13 numbered gotcha entries
- Each entry has WRONG and CORRECT patterns
- Each entry has an Impact line
- Each entry has a skill/file reference
- No severity categories, grouping, or priority labels (flat list only)
- File length between 80-200 lines
  </verify>
  <done>
output/docs/known-gotchas.md exists with 13 flat-numbered gotchas, each with wrong/correct/impact/reference. DOC-05 requirement satisfied.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `ls -la output/docs/crystal-reports-catalog.md output/docs/known-gotchas.md` — both files exist
2. Confirm gotchas count: `grep -c '^\d\+\.' output/docs/known-gotchas.md` returns 13 (or grep for `**` pattern headers)
3. Confirm Crystal Reports has catalog table: `grep -c '|' output/docs/crystal-reports-catalog.md` returns >= 20
4. Confirm no severity grouping in gotchas: `grep -ci 'critical\|high\|medium\|low\|severity' output/docs/known-gotchas.md` returns 0
5. Confirm M2 deferral noted: `grep -c 'Milestone 2' output/docs/crystal-reports-catalog.md` returns >= 1
</verification>

<success_criteria>
- DOC-04 satisfied: Crystal Reports catalog with report names, filenames, menu locations, and usage guidance exists
- DOC-05 satisfied: 13 known gotchas documented as flat numbered list with wrong/correct/impact/reference
- Crystal Reports catalog explicitly notes .rpt extraction deferred to M2
- Gotchas have no severity grouping (flat list per CONTEXT.md)
- Both documents are machine-readable reference material
</success_criteria>

<output>
After completion, create `.planning/phases/08-documentation-milestone-close/08-02-SUMMARY.md`
</output>
