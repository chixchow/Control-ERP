---
phase: 05-financial-foundation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - skills/control-erp-financial/control-erp-financial-SKILL.md
autonomous: true

must_haves:
  truths:
    - "Deposit workflow is documented showing the two-step process: payment hits Undeposited account, then deposit moves funds to Cash-Checking (90)"
    - "Payment.TenderType field is documented with all observed values (0=Cash, 1=Check, 2=Credit Card, 4=Online, 5=ACH/Wire, 7=Wire Transfer) and their BankAccountID mappings"
    - "All 15 Payment ClassTypeID values are documented (20000 through 20038) with meanings"
    - "Built status cost flow is documented showing NodeID 34 (Cost Of Built - FGI) and off-balance sheet entries via NodeIDs 60/61"
  artifacts:
    - path: "skills/control-erp-financial/control-erp-financial-SKILL.md"
      provides: "Deposit workflow, TenderType reference, Payment ClassTypeIDs, Built cost flow, off-balance sheet explanation"
      contains: "TenderType"
  key_links:
    - from: "Deposit Workflow section"
      to: "Payment Posting Patterns section"
      via: "Deposit is the step AFTER payment posting"
      pattern: "Undeposited.*Cash-Checking"
    - from: "Built Cost Flow section"
      to: "GL Transaction Flows section"
      via: "Built status is Stage 2.5 between WIP and Sale"
      pattern: "Cost Of Built"
---

<objective>
Add payment and cost flow documentation to the financial skill: deposit workflow, TenderType/ClassTypeID references, and Built status cost flow with off-balance sheet explanation.

Purpose: The financial skill documents how payments post to GL accounts (Stage 2 and Paths A/B) but stops there. Users need to understand what happens after payment (deposit workflow), how to query by payment method (TenderType), what payment subtypes exist (ClassTypeID), and how costs flow through Built status before Sale. This plan completes the payment and cost lifecycle documentation.

Output: Updated `skills/control-erp-financial/control-erp-financial-SKILL.md` with deposit workflow, TenderType reference, complete Payment ClassTypeID reference, Built cost flow, and off-balance sheet explanation.
</objective>

<execution_context>
@/Users/cain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-financial-foundation/05-RESEARCH.md
@.planning/phases/05-financial-foundation/05-01-SUMMARY.md
@skills/control-erp-financial/control-erp-financial-SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deposit workflow and Payment reference tables</name>
  <files>skills/control-erp-financial/control-erp-financial-SKILL.md</files>
  <action>
  Add three new subsections to the PAYMENT POSTING PATTERNS section, AFTER the existing "Other GL Register Entries" subsection.

  **Part A: Add "### Deposit Workflow (Undeposited -> Bank)" subsection.**

  First, verify the deposit pattern with a live query:
  ```sql
  SELECT TOP 5 l.ID, l.GLAccountID, ga.AccountName, l.Amount, l.DepositJournalID, l.EntryDateTime
  FROM Ledger l
  INNER JOIN GLAccount ga ON l.GLAccountID = ga.ID
  WHERE l.DepositJournalID IS NOT NULL AND l.GLAccountID IN (90, 91, 92, 93, 543, 10137, 10528, 10530, 10531)
  ORDER BY l.ID DESC
  ```

  Document the two-step deposit process:

  **Step 1 - Payment Received** (already documented in Paths A/B):
  ```
  Debit  Undeposited [Method] (92/93/etc.)  $payment
  Credit Order Prepayments (24) or AR (14)  $payment
  ```

  **Step 2 - Deposit Processed** (NEW):
  ```
  Debit  Cash-Checking (90)                 $deposit_total
  Credit Undeposited [Method] (92/93/etc.)  $deposit_total
  ```

  Key points to document:
  - Deposits group multiple payments into a single batch via `Ledger.DepositJournalID`
  - `Payment.Undeposited` flag (bit) indicates whether a payment has been deposited yet
  - Deposits are created in Control via the "Make Deposit" function
  - Until deposited, funds sit in the Undeposited account and do NOT appear in Cash-Checking
  - Query to find undeposited payments:
  ```sql
  SELECT p.ID, p.Amount, p.TenderType, ga.AccountName AS UndepositedAccount
  FROM Payment p
  INNER JOIN GLAccount ga ON p.BankAccountID = ga.ID
  WHERE p.Undeposited = 1 AND p.IsActive = 1
  ```

  **Part B: Add "### Payment.TenderType Reference" subsection.**

  Verify with:
  ```sql
  SELECT p.TenderType, COUNT(*) AS Cnt, MIN(ga.AccountName) AS TypicalBankAccount
  FROM Payment p
  LEFT JOIN GLAccount ga ON p.BankAccountID = ga.ID
  WHERE p.IsActive = 1
  GROUP BY p.TenderType
  ORDER BY p.TenderType
  ```

  Create a reference table:

  | TenderType | Payment Method | Default BankAccountID |
  |------------|---------------|----------------------|
  | 0 | Cash | 91 (Undeposited Cash) |
  | 1 | Check | 93 (Undeposited Checks) |
  | 2 | Credit Card (MC/Visa) | 92 (Undeposited MCVisa) |
  | 4 | Online/Authorize.net | 10528 (Undeposited Authorize.net) |
  | 5 | ACH/Wire | 90 (Cash-Checking direct) |
  | 7 | Wire Transfer | 90 (Cash-Checking direct) |
  | 8 | Other/Legacy | varies |
  | NULL | System entries | N/A (master payments, failed, etc.) |

  Note: "TenderType values 3 and 6 are not observed at FLS. ACH (5) and Wire (7) post directly to Cash-Checking, bypassing the undeposited step."

  **Part C: Add "### Payment ClassTypeID Reference" subsection.**

  Verify with:
  ```sql
  SELECT ClassTypeID, COUNT(*) AS Cnt FROM Payment WHERE IsActive = 1 GROUP BY ClassTypeID ORDER BY ClassTypeID
  ```

  Create a comprehensive reference table:

  | ClassTypeID | Type | Description |
  |-------------|------|-------------|
  | 20000 | Master Payment | Parent grouping for multi-order payments |
  | 20001 | Order Payment | Payment applied to a specific order |
  | 20002 | Credit Payment | Payment from customer credit balance |
  | 20003 | Change Returned | Cash change given back to customer |
  | 20004 | Order Refund | Refund issued against an order |
  | 20005 | Credit Refund | Refund issued from customer credit |
  | 20006 | Credit Memo Payment | Payment created from credit memo |
  | 20007 | Failed Payment | Payment attempt that failed (CC decline, etc.) |
  | 20009 | Bill Payment | Payment made to a vendor for a bill |
  | 20011 | Overpayment | Payment exceeding balance due |
  | 20012 | Payment to Credit | Payment transferred to customer credit balance |
  | 20032 | Master Payment Authorization | CC authorization grouping for multi-order auth |
  | 20037 | Master Bill Payment | Parent grouping for multi-bill payments |
  | 20038 | Receipt | Receiving document payment (PO receipts) |

  Add note: "For most payment queries, filter to ClassTypeID IN (20001, 20009) to get individual order and bill payments. Use 20000/20037 when analyzing payment batches."

  **What NOT to change:** Do not modify existing Path A/B documentation, Payment Description Format section, or any GL Transaction Flow stages. Only ADD new subsections after the existing content.
  </action>
  <verify>
  Read the modified file and confirm:
  1. A "Deposit Workflow" subsection exists with the two-step process and undeposited payments query
  2. A "Payment.TenderType Reference" subsection exists with all observed values and BankAccountID mappings
  3. A "Payment ClassTypeID Reference" subsection exists with all 14 ClassTypeID values
  4. Existing Path A/B and Payment Description Format sections are unchanged
  </verify>
  <done>
  Deposit workflow documents the Undeposited -> Cash-Checking flow with DepositJournalID grouping. TenderType reference maps all payment methods to their BankAccountIDs. All 14 Payment ClassTypeID values are documented with meanings and query guidance.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Built cost flow and off-balance sheet documentation</name>
  <files>skills/control-erp-financial/control-erp-financial-SKILL.md</files>
  <action>
  Add two new subsections to the GL TRANSACTION FLOWS section, enhancing the order lifecycle documentation.

  **Part A: Add "### Built Status â€” Cost Flow (Stage 2.5)" subsection** AFTER Stage 2 (Deposit/Prepayment Received) and BEFORE Stage 3a.

  Verify with a live query:
  ```sql
  SELECT TOP 10 l.GLAccountID, ga.AccountName, l.Amount, l.OffBalanceSheet, l.Description
  FROM Ledger l
  INNER JOIN GLAccount ga ON l.GLAccountID = ga.ID
  INNER JOIN Journal j ON l.JournalID = j.ID
  WHERE j.ActivityType = 6  -- Marked Built
  AND l.GLAccountID IN (11, 12, 34, 60, 61, 10414)
  ORDER BY l.ID DESC
  ```

  Document the Built status GL entries:

  **Stage 2.5: Order Marked Built**
  ```
  -- Transfer from WIP to Built
  Credit WIP (11)                       $order_total
  Debit  Built (12)                     $order_total

  -- Cost tracking (accrual-tracked parts)
  Credit Inventory (10414)              $accrual_cost
  Debit  Cost Of Built - FGI (34)       $accrual_cost

  -- Cost tracking (non-accrual parts, OFF-BALANCE SHEET)
  Credit Unclassified Inventory (60)    $nonaccrual_cost   [OffBalanceSheet=1]
  Debit  Unclassified Expense (61)      $nonaccrual_cost   [OffBalanceSheet=1]
  ```

  Key points:
  - Built status is an intermediate hold between production and sale
  - NodeID 34 (Cost Of Built - FGI = Finished Goods Inventory) holds costs until the order is sold
  - At sale, NodeID 34 clears as costs move to COGS
  - Non-accrual parts use off-balance sheet tracking (OffBalanceSheet=1 in Ledger) to avoid double-counting parts that were expensed at purchase

  **Part B: Add "### Off-Balance Sheet Entries" subsection** AFTER the GL view definition at the top of the GL/LEDGER ARCHITECTURE section (after the `CREATE VIEW GL AS...` code block and the bullet points explaining GL vs Ledger).

  Document:
  - **What are off-balance sheet entries?** Ledger entries with `OffBalanceSheet = 1` that are excluded from the GL view. These track costs for parts that were expensed at purchase (not carried as inventory assets).
  - **Why they exist:** Control supports two part cost tracking modes:
    - **Accrual** (financial): Parts are inventory assets until consumed. Uses NodeID 10414 (Inventory). Appears in GL view.
    - **Cost Accounting** (non-financial): Parts are expensed at purchase. Uses NodeIDs 60/61 (Unclassified Inventory/Expense). Off-balance sheet to prevent double-counting.
  - **When to include them:** Only when analyzing total production costs including non-accrual materials. For standard financial reporting, the GL view correctly excludes them.
  - **Count context:** ~307K off-balance sheet entries vs ~2.44M on-balance sheet entries (~11% of all Ledger entries).
  - Add query example:
  ```sql
  -- Total cost including off-balance sheet entries for an order
  SELECT
      CASE l.OffBalanceSheet WHEN 0 THEN 'Financial (GL)' ELSE 'Cost Accounting (OBS)' END AS EntryType,
      SUM(l.Amount) AS TotalCost
  FROM Ledger l
  WHERE l.TransHeaderID = @TransHeaderID
      AND l.GLAccountID IN (10414, 34, 60, 61)  -- inventory/cost accounts
  GROUP BY l.OffBalanceSheet
  ```

  **Part C: Update the Natural Language Interpretation table** to add entries for the new content. Add these rows to the existing table:

  | User Says | Action |
  |-----------|--------|
  | "undeposited payments" / "pending deposits" | Undeposited payments query (Payment.Undeposited = 1) |
  | "deposit history" / "bank deposits" | Deposit workflow query (Ledger.DepositJournalID) |
  | "payment method breakdown" | Group payments by TenderType |
  | "closeout status" / "period locks" | Closeout query by type |
  | "production costs for order" / "total cost including materials" | Ledger query with OffBalanceSheet included |

  **What NOT to change:** Do not modify existing Stages 1, 3a, 3b, the Bill Lifecycle section, or any AR/AP/P&L sections.
  </action>
  <verify>
  Read the modified file and confirm:
  1. A "Built Status -- Cost Flow (Stage 2.5)" subsection exists between Stage 2 and Stage 3a with GL entries for NodeIDs 11, 12, 34, 60, 61, 10414
  2. An "Off-Balance Sheet Entries" subsection exists in the GL/LEDGER ARCHITECTURE section explaining accrual vs cost accounting
  3. The Natural Language Interpretation table has 5 new rows for deposits, payment methods, closeout, and production costs
  4. Existing Stages 1, 3a, 3b and Bill Lifecycle are unchanged
  </verify>
  <done>
  Built status cost flow documents the intermediate FGI hold (NodeID 34) and non-accrual part tracking via off-balance sheet entries (NodeIDs 60/61). Off-balance sheet entries are explained with the accrual vs cost accounting distinction. Natural language interpretation table updated with new query triggers.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Search for "TenderType" in the file -- should appear in the Payment reference section
2. Search for "DepositJournalID" -- should appear in both the Ledger field reference (from 05-01) and the deposit workflow section
3. Search for "Cost Of Built" or "FGI" -- should appear in the Built status cost flow section
4. Search for "OffBalanceSheet" -- should appear in both the GL architecture section and the Built cost flow section
5. Confirm the file structure flows logically: GL Architecture (with OBS explanation) -> GLAccount -> GL Transaction Flows (with Built stage) -> Payment Posting (with deposit/TenderType/ClassTypeID) -> AR -> AP -> P&L -> Closeout -> Caveats -> NL Interpretation
6. Confirm no existing validated content was modified (AR $80,899, AP $125,319 context notes still present)
</verification>

<success_criteria>
1. Deposit workflow documents the two-step Undeposited -> Cash-Checking process with DepositJournalID grouping and undeposited payments query
2. TenderType reference maps all observed values (0-8, NULL) to payment methods and default BankAccountIDs
3. All 14 Payment ClassTypeID values documented with meanings and query guidance
4. Built status cost flow shows NodeID 34 (FGI) intermediary and NodeIDs 60/61 off-balance sheet tracking
5. Off-balance sheet entries explained with accrual vs cost accounting distinction and ~307K/2.44M count context
6. Natural Language Interpretation table has 5 new entries for deposits, payment methods, closeout, and production costs
</success_criteria>

<output>
After completion, create `.planning/phases/05-financial-foundation/05-02-SUMMARY.md`
</output>
