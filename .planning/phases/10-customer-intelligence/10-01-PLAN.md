---
phase: 10-customer-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/control-erp-customers/control-erp-customers-SKILL.md
autonomous: true

must_haves:
  truths:
    - "User can search for a customer by name, number, or contact name and get a pick list if multiple matches"
    - "User can view a complete customer profile with contacts, addresses, phone numbers, account flags, order history, revenue, AR balance, last contact date"
    - "Customer profile shows executive summary by default with drill-down queries available for contacts, addresses, and order history"
    - "All revenue figures include YoY comparison (trailing 12mo vs prior 12mo)"
    - "Walk-In account (ID=10, AccountNumber=0) is excluded from analytics"
  artifacts:
    - path: "skills/control-erp-customers/control-erp-customers-SKILL.md"
      provides: "Customer lookup, search, and profile queries with NL routing"
      contains: "CUSTOMER PROFILE"
    - path: "skills/control-erp-customers/control-erp-customers-SKILL.md"
      provides: "Smart search with exact-then-fuzzy matching"
      contains: "CUSTOMER SEARCH"
    - path: "skills/control-erp-customers/control-erp-customers-SKILL.md"
      provides: "Drill-down queries for contacts, addresses, order history"
      contains: "DRILL-DOWN"
  key_links:
    - from: "Customer profile query"
      to: "Account + AccountContact + Employee + PaymentTerms"
      via: "Direct FK joins (PrimaryContactID, SalesPersonID1, PaymentTermsID)"
      pattern: "LEFT JOIN.*AccountContact.*ON a.PrimaryContactID"
    - from: "AR balance in profile"
      to: "TransHeader.BalanceDue (NOT Account.CreditBalance)"
      via: "SUM(BalanceDue) subquery on AccountID"
      pattern: "SUM.*BalanceDue.*WHERE.*AccountID"
    - from: "Revenue in profile"
      to: "TransHeader with core skill formula"
      via: "TransactionType=1, SubTotalPrice, SaleDate, StatusID NOT IN (9)"
      pattern: "TransactionType = 1.*SubTotalPrice.*SaleDate IS NOT NULL"
    - from: "Contact activity"
      to: "Journal + ContactActivity split table"
      via: "Journal.AccountID with ContactActivity.ID = Journal.ID"
      pattern: "Journal.*AccountID.*ContactActivity"
---

<objective>
Create the control-erp-customers skill with customer profile lookup, smart search, and drill-down queries -- covering requirement CUST-01.

Purpose: Users need to search for any customer and instantly get a complete profile with contacts, revenue, AR balance, and relationship data. This is the foundation skill file that Plans 02 builds upon for segmentation and churn detection.

Output: New skill file `skills/control-erp-customers/control-erp-customers-SKILL.md` with YAML frontmatter, table architecture, customer search, executive profile, drill-down queries, and NL routing table.
</objective>

<execution_context>
@/Users/cain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-customer-intelligence/10-CONTEXT.md
@.planning/phases/10-customer-intelligence/10-RESEARCH.md
@skills/control-erp-core/control-erp-core-SKILL.md
@skills/control-erp-financial/control-erp-financial-SKILL.md
@output/skill/references/common_joins.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run Discovery Queries and Create Skill File Foundation</name>
  <files>skills/control-erp-customers/control-erp-customers-SKILL.md</files>
  <action>
First, run these discovery queries using the mssql MCP tool to fill in research gaps:

1. **Account flag distribution:**
```sql
SELECT IsClient, IsProspect, IsVendor, IsActive, COUNT(*) AS Cnt
FROM Account
GROUP BY IsClient, IsProspect, IsVendor, IsActive
ORDER BY Cnt DESC
```

2. **Unique ordering customers:**
```sql
SELECT COUNT(DISTINCT AccountID) AS UniqueCustomers
FROM TransHeader
WHERE TransactionType = 1 AND IsActive = 1 AND SaleDate IS NOT NULL AND StatusID NOT IN (9)
```

3. **Journal ClassTypeID for contact activities:**
```sql
SELECT TOP 20 j.ClassTypeID, j.JournalActivityType, j.JournalActivityText, COUNT(*) AS Cnt
FROM Journal j
WHERE j.AccountID > 0 AND j.IsActive = 1
GROUP BY j.ClassTypeID, j.JournalActivityType, j.JournalActivityText
ORDER BY Cnt DESC
```

4. **AccountUserField population check:**
```sql
SELECT TOP 5 Sales_Status, ASI, PPAI
FROM AccountUserField
WHERE Sales_Status IS NOT NULL OR ASI IS NOT NULL
```

Then create the skill directory and file: `skills/control-erp-customers/control-erp-customers-SKILL.md`

Write the file with these sections (using discovery results to inform actual ClassTypeID values and counts):

**YAML frontmatter:**
```yaml
---
name: control-erp-customers
description: Look up any FLS Banners customer by name, number, or contact. Get complete profiles with contacts, addresses, revenue, AR balance. Analyze customer rankings, segmentation, and at-risk detection. Use when the user asks about customers, accounts, contacts, "who", customer value, or churn risk. Depends on control-erp-core for business rules.
---
```

**Section 1: Header and overview**
- `# Control ERP Customer Intelligence -- Lookup, Segmentation & Risk`
- Depends on: control-erp-core
- Brief overview: what this skill covers (profile lookup, search, ranking, segmentation, churn)
- **Account table quick facts** (from discovery results): total accounts, active clients, active prospects, ordering customers count

**Section 2: TABLE ARCHITECTURE**
Document the core tables used by this skill and their relationships:
- Account (54,719 rows) -- the customer record. Key fields: CompanyName (NOT AccountName), AccountNumber, IsClient, IsProspect, IsActive, IsVendor, PrimaryContactID, AccountingContactID, BillingAddressID, ShippingAddressID, MainPhoneNumberID, SalesPersonID1/2/3, PaymentTermsID, CreditBalance (credits TO customer, NOT AR), CreditLimit, HasCreditAccount, DateCreated, IndustryID, OriginID
- AccountContact (64,851) -- contacts with AccountID direct FK AND ParentID polymorphic (ParentClassTypeID=2000)
- TransHeader (232,243) -- orders/revenue, AccountID FK
- Address (125,614) + AddressLink (304,987) -- polymorphic addresses (ParentClassTypeID=2000 for Account)
- PhoneNumber (314,805) -- polymorphic phones (ParentClassTypeID=2000)
- Journal + ContactActivity -- split table for CRM activity (use discovered ClassTypeID)
- Employee (103) -- sales rep lookup
- PaymentTerms (28) -- terms reference
- Payment (286,084) -- late payment detection

Include a clear WARNINGS box:
- CompanyName, NOT AccountName (column does not exist)
- CreditBalance = credits TO customer, NOT AR balance
- AR = SUM(TransHeader.BalanceDue) for open orders
- Default filter: IsClient=1 AND IsActive=1
- Exclude Walk-In: AccountNumber > 0 (or ID <> 10)
- Revenue: use core skill formula (TransactionType=1, SubTotalPrice, SaleDate IS NOT NULL, StatusID NOT IN (9))

**Section 3: CUSTOMER SEARCH**
Three-step smart search pattern (from research, Pattern 2):
1. Exact match on AccountNumber (TRY_CAST to int)
2. LIKE match on CompanyName
3. Contact name search via AccountContact.AccountID

Each query must filter IsActive=1. Show the "pick list" format for multiple matches. Include example NL triggers: "look up customer X", "find account X", "search for X".

**Section 4: CUSTOMER PROFILE -- Executive Summary**
Complete profile query from research (Pattern 1, lines 398-453). Include:
- Account info (CompanyName, AccountNumber, CustomerSince, IsClient/IsProspect/IsActive)
- Primary contact + email
- Accounting contact + email
- Main phone (from denormalized Account columns: PrimaryNumber, PriNumberTypeText)
- Sales rep (Employee JOIN on SalesPersonID1)
- Payment terms (PaymentTerms JOIN)
- Credit info (CreditBalance labeled as "Customer Credits", CreditLimit, HasCreditAccount)
- Industry/Origin (MarketingListItem JOINs)
- Revenue aggregates via correlated subqueries: TotalOrders, LifetimeRevenue, LastOrderDate
- **YoY revenue**: Trailing 12mo revenue AND Prior 12mo revenue with percent change
- AR balance: SUM(TransHeader.BalanceDue) for open orders (NOT Account.CreditBalance)
- Last contact activity date (use Journal query with discovered ClassTypeID)

**Section 5: DRILL-DOWN QUERIES**
These expand the executive summary when the user asks for detail:

1. **All Contacts** -- AccountContact WHERE AccountID = @ID, ordered by IsPrimaryContact DESC. Show FirstName, LastName, Position, EmailAddress, Phone, PhoneType, IsPrimaryContact, IsAccountingContact.

2. **All Addresses** -- AddressLink JOIN Address WHERE ParentID = @ID AND ParentClassTypeID = 2000. Show AddressName, IsBillingAddress, StreetAddress1/2, City, State, PostalCode.

3. **Recent Order History** -- TransHeader WHERE AccountID = @ID AND TransactionType = 1, TOP 20 by SaleDate DESC. Show OrderNumber, SaleDate, SubTotalPrice, BalanceDue, StatusID (with status text CASE), Description.

4. **Last Contact Activity** -- Journal JOIN ContactActivity with discovered ClassTypeID. Show date, description, activity type, completed by.

**Section 6: NATURAL LANGUAGE INTERPRETATION (partial -- Plan 02 will extend)**
Create the routing table with entries for all CUST-01 patterns:
- "look up [customer]" / "find [customer]" / "search [customer]" -> Customer Search
- "customer profile for [X]" / "tell me about [customer]" / "account info" -> Executive Profile
- "contacts for [customer]" / "who works at [customer]" -> All Contacts drill-down
- "addresses for [customer]" / "where is [customer]" -> All Addresses drill-down
- "orders for [customer]" / "order history for [customer]" -> Recent Order History
- "last contact with [customer]" / "when did we last talk to [customer]" -> Last Contact Activity
- "AR for [customer]" / "what does [customer] owe" -> Redirect to financial skill or inline AR subquery

Add a placeholder comment: `<!-- Plan 02 adds: ranking, segmentation, RFM, dormancy, at-risk routing -->`

CRITICAL REMINDERS:
- Use CompanyName (NOT AccountName -- column does not exist)
- Use SubTotalPrice for revenue (NOT TotalPrice)
- Use SaleDate for date filtering (NOT OrderCreatedDate)
- AR = SUM(TransHeader.BalanceDue), NOT Account.CreditBalance
- Always filter IsClient=1, IsActive=1 by default
- Exclude Walk-In: AccountNumber > 0
- Include YoY on every revenue figure
  </action>
  <verify>
1. Run discovery queries and record results (Account flag distribution, unique ordering customers, Journal ClassTypeID, AccountUserField population)
2. File exists at skills/control-erp-customers/control-erp-customers-SKILL.md
3. YAML frontmatter has name and description
4. TABLE ARCHITECTURE section documents all core tables with correct column names
5. WARNINGS box lists all critical gotchas (CompanyName, CreditBalance, Walk-In, default filters)
6. CUSTOMER SEARCH section has 3-step smart search with IsActive=1 filter
7. CUSTOMER PROFILE has executive summary query with ALL fields listed in the action
8. YoY revenue comparison is included in profile (trailing 12mo + prior 12mo + pct change)
9. AR balance uses SUM(TransHeader.BalanceDue), NOT Account.CreditBalance
10. DRILL-DOWN section has 4 queries (contacts, addresses, order history, last contact)
11. NL INTERPRETATION table has routing for all CUST-01 patterns
12. No references to "AccountName" anywhere in the file (must be CompanyName)
  </verify>
  <done>New skill file created with YAML frontmatter, table architecture with warnings, 3-step customer search, executive profile with YoY revenue and correct AR balance, 4 drill-down queries, and NL routing for CUST-01 patterns. Discovery query results embedded in the file (actual account counts, ClassTypeID values).</done>
</task>

<task type="auto">
  <name>Task 2: Validate Revenue Cross-Check and Finalize Profile Section</name>
  <files>skills/control-erp-customers/control-erp-customers-SKILL.md</files>
  <action>
Run a revenue cross-check query via MCP to validate the customer-level revenue formula sums correctly:

```sql
SELECT
    SUM(SubTotalPrice) AS TotalRevenue,
    COUNT(DISTINCT AccountID) AS UniqueCustomers,
    COUNT(*) AS TotalOrders
FROM TransHeader
WHERE TransactionType = 1
  AND IsActive = 1
  AND SaleDate IS NOT NULL
  AND StatusID NOT IN (9)
  AND SaleDate >= '2025-01-01' AND SaleDate < '2026-01-01'
```

This should produce approximately $3,052,952.52 (the core baseline). Document the exact result in the skill file as a validation note.

Then add a **REVENUE VALIDATION** section to the skill file (after the TABLE ARCHITECTURE section):
- Document the cross-check: "Customer-level SUM(SubTotalPrice) for 2025 = $X, matching core baseline within 0.02%"
- Explain the validated formula: TransactionType=1, IsActive=1, SaleDate IS NOT NULL, StatusID NOT IN (9)
- Note: This formula MUST be used for all revenue calculations in this skill -- no independent implementations
- Include the Walk-In exclusion note: "Exclude AccountNumber=0 (Walk-In) from customer analytics. Walk-In revenue is included in the global total but should not appear in per-customer rankings."

Also run a quick sanity check on the top 5 customers to have concrete examples for testing:

```sql
SELECT TOP 5
    a.CompanyName,
    a.AccountNumber,
    SUM(th.SubTotalPrice) AS Revenue2025
FROM Account a
JOIN TransHeader th ON th.AccountID = a.ID
WHERE a.IsActive = 1 AND a.IsClient = 1 AND a.AccountNumber > 0
  AND th.TransactionType = 1 AND th.IsActive = 1
  AND th.SaleDate IS NOT NULL AND th.StatusID NOT IN (9)
  AND th.SaleDate >= '2025-01-01' AND th.SaleDate < '2026-01-01'
GROUP BY a.CompanyName, a.AccountNumber
ORDER BY Revenue2025 DESC
```

Add these as test reference values in the REVENUE VALIDATION section (e.g., "Top 5 customers for 2025: [customer] = $X, ..."). These serve as regression anchors for anyone using the skill.

Review the complete file for:
- Consistent formatting with other skills (compare to financial skill structure)
- No duplicate section headers
- All SQL queries properly formatted in code blocks
- Total line count tracking (needed to decide about references/ extraction in Plan 02)
  </action>
  <verify>
1. Revenue cross-check query run and result documented
2. REVENUE VALIDATION section exists in skill file
3. Cross-check total matches core baseline ($3,052,952.52) within 0.1%
4. Walk-In exclusion documented
5. Top 5 customer test values recorded as regression anchors
6. File formatting consistent with financial skill pattern
7. Line count noted in summary (for Plan 02 extraction decision)
  </verify>
  <done>Revenue cross-check validates customer-level formula matches core baseline. Top 5 customer regression anchors recorded. REVENUE VALIDATION section documents the validated formula and Walk-In exclusion. File is consistent with existing skill formatting patterns.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. skills/control-erp-customers/control-erp-customers-SKILL.md exists with valid YAML frontmatter
2. Discovery results embedded (Account flag distribution, Journal ClassTypeID, ordering customer count)
3. Customer search (3-step smart match) handles name, number, and contact search
4. Executive profile includes ALL required fields (contacts, revenue with YoY, AR balance, last contact)
5. AR balance uses SUM(TransHeader.BalanceDue), never Account.CreditBalance
6. Revenue formula matches core skill exactly (TransactionType=1, SubTotalPrice, SaleDate, StatusID NOT IN 9)
7. Revenue cross-check validates against $3,052,952.52 baseline
8. Walk-In account excluded from analytics
9. 4 drill-down queries present (contacts, addresses, order history, last contact)
10. NL routing table covers all CUST-01 patterns
11. File uses CompanyName throughout (never AccountName)
</verification>

<success_criteria>
- CUST-01 fully covered: customer search, profile, contacts, addresses, phones, order history, AR balance, last contact
- Revenue validated against core baseline ($3,052,952.52)
- All critical gotchas addressed (CompanyName, CreditBalance vs AR, Walk-In, default filters)
- File structure ready for Plan 02 to extend with segmentation and churn sections
- Discovery results captured (actual ClassTypeID values, account distribution counts)
</success_criteria>

<output>
After completion, create `.planning/phases/10-customer-intelligence/10-01-SUMMARY.md`
</output>
