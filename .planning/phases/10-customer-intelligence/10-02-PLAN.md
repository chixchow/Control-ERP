---
phase: 10-customer-intelligence
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - skills/control-erp-customers/control-erp-customers-SKILL.md
  - skills/control-erp-customers/references/customer-analysis.md
autonomous: true

must_haves:
  truths:
    - "User can ask 'who are our top customers' and get a revenue-ranked list with YoY comparison"
    - "User can ask 'show customer segmentation' and get RFM-scored segments with named categories (Champions, Loyal, At Risk, Lost, etc.)"
    - "User can ask 'which customers are at risk' and get dormancy-detected list sorted by combined revenue impact and overdue severity"
    - "Dormancy thresholds are personalized per customer's historical ordering cadence (avg gap + 1.5 stdev, minimum 4 orders)"
    - "Customers without enough history default to 90-day threshold"
    - "Revenue at risk shows trailing 12mo revenue plus trend direction (up/down vs prior year)"
    - "Top customer rankings cross-check against validated sales skill output"
  artifacts:
    - path: "skills/control-erp-customers/control-erp-customers-SKILL.md"
      provides: "Customer ranking, RFM segmentation, and at-risk detection sections"
      contains: "CUSTOMER RANKING"
    - path: "skills/control-erp-customers/control-erp-customers-SKILL.md"
      provides: "Churn detection with personalized dormancy thresholds"
      contains: "AT-RISK DETECTION"
    - path: "skills/control-erp-customers/references/customer-analysis.md"
      provides: "Detailed RFM methodology and dormancy algorithm with full SQL"
      contains: "RFM SEGMENTATION"
  key_links:
    - from: "Ranking query"
      to: "TransHeader + Account with core revenue formula"
      via: "GROUP BY AccountID with SUM(SubTotalPrice)"
      pattern: "GROUP BY.*CompanyName.*ORDER BY.*Revenue.*DESC"
    - from: "RFM scoring"
      to: "NTILE(5) window functions on Recency/Frequency/Monetary"
      via: "CTE with quintile scoring"
      pattern: "NTILE\\(5\\).*OVER.*ORDER BY"
    - from: "Dormancy detection"
      to: "LAG window function for order gap calculation"
      via: "CustomerCadence CTE with avg gap + 1.5 stdev"
      pattern: "LAG.*SaleDate.*OVER.*PARTITION BY.*AccountID"
    - from: "Combined risk score"
      to: "Revenue impact * overdue severity blend"
      via: "ORDER BY in HAVING clause"
      pattern: "Trailing12MoRevenue.*DaysOverdue"
---

<objective>
Add customer segmentation, CLV analysis, ranking, RFM scoring, and churn detection to the customer skill -- covering requirements CUST-02 and CUST-03.

Purpose: Users need to understand which customers are most valuable (ranking/segmentation) and which are at risk of churning (dormancy detection with personalized thresholds). This transforms the profile-lookup skill into a full customer intelligence tool.

Output: Extended skill file with ranking, RFM, and at-risk sections. Detailed algorithms extracted to `references/customer-analysis.md` if main file exceeds ~1,000 lines. Complete NL routing for all customer intelligence patterns.
</objective>

<execution_context>
@/Users/cain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-customer-intelligence/10-CONTEXT.md
@.planning/phases/10-customer-intelligence/10-RESEARCH.md
@.planning/phases/10-customer-intelligence/10-01-SUMMARY.md
@skills/control-erp-customers/control-erp-customers-SKILL.md
@output/skill/references/advanced_analytics.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Customer Ranking and RFM Segmentation (CUST-02)</name>
  <files>
    skills/control-erp-customers/control-erp-customers-SKILL.md
    skills/control-erp-customers/references/customer-analysis.md
  </files>
  <action>
Add two new major sections to the skill file after the DRILL-DOWN QUERIES section and before the NL INTERPRETATION section.

**Section: CUSTOMER RANKING & TOP CUSTOMERS**

1. **Top Customers by Revenue (default)** -- Trailing 12-month ranking. Use the query from research Pattern 3 (lines 496-527). Must include:
   - CompanyName, AccountNumber
   - RevenueT12M (trailing 12 months)
   - RevenuePrior12M (prior 12 months)
   - YoYChangePct (percent change)
   - OrdersT12M (order count)
   - AvgOrderValueT12M
   - Default TOP 10, note that user can request different sizes ("top 25", "all")
   - Exclude Walk-In (AccountNumber > 0)
   - Filter: IsActive=1 AND IsClient=1

2. **Alternative Rankings** -- Note these variants the user can request:
   - "top by order count" -> ORDER BY OrdersT12M DESC
   - "top by average order" -> ORDER BY AvgOrderValueT12M DESC
   - "top customers all time" -> Remove date filter, use lifetime SUM
   - "top customers this year" / "top customers 2025" -> WHERE SaleDate >= '2025-01-01'

3. **Pareto Analysis (80/20 rule)** -- CTE that calculates cumulative revenue percentage to show how many customers account for 80% of revenue. Use the pattern from advanced_analytics.md. Include the ROW_NUMBER and SUM() OVER (ORDER BY Revenue DESC) window function pattern.

4. **Cross-check note:** "Top 10 results should be consistent with the sales skill's top customer output. Any discrepancy indicates a filter difference -- verify TransactionType=1, SubTotalPrice, SaleDate, StatusID NOT IN (9) match."

**Section: CUSTOMER SEGMENTATION (RFM)**

1. **RFM Overview** -- Brief explanation: Recency (days since last order), Frequency (order count in period), Monetary (total revenue in period). NTILE(5) scoring creates quintiles.

2. **RFM Scoring Query** -- Use the query from research Pattern 4 (lines 167-203). Ensure:
   - 2-year lookback window for RFM calculations
   - NTILE(5) on each dimension
   - R_Score: lower recency = higher score (ORDER BY Recency DESC)
   - Named segment mapping using CASE statement:
     - Champions (R>=4, F>=4, M>=4)
     - Loyal (R>=3, F>=3, M>=3)
     - New Customers (R>=4, F<=2)
     - At Risk (R<=2, F>=3, M>=3)
     - Can't Lose Them (R<=2, F>=4, M>=4)
     - Lost (R<=2, F<=2)
     - Needs Attention (everything else)
   - Exclude Walk-In (AccountNumber > 0)

3. **Segment Summary** -- A wrapper query that counts customers and sums revenue per segment. This is what the user sees when they ask "show customer segmentation":
```sql
-- Wrap the RFM query above as a CTE, then:
SELECT
    Segment,
    COUNT(*) AS CustomerCount,
    SUM(Monetary) AS TotalRevenue,
    AVG(Monetary) AS AvgRevenue,
    AVG(Recency) AS AvgDaysSinceOrder,
    AVG(Frequency) AS AvgOrders
FROM RFMSegmented
GROUP BY Segment
ORDER BY TotalRevenue DESC
```

**Extraction decision:** After adding these sections, check the total line count of the main SKILL.md file. If it exceeds ~1,000 lines:
- Create `skills/control-erp-customers/references/customer-analysis.md`
- Move the FULL RFM scoring query (the detailed CTE with NTILE calculations) to references
- Move the Pareto analysis full query to references
- Keep summary/overview and simplified versions in the main file
- Add cross-references: "See references/customer-analysis.md for full RFM methodology"

If under ~1,000 lines, keep everything in the main file (no extraction needed).

CRITICAL REMINDERS:
- All revenue uses SubTotalPrice, TransactionType=1, SaleDate IS NOT NULL, StatusID NOT IN (9)
- Walk-In excluded (AccountNumber > 0)
- YoY on every revenue figure
- IsClient=1 AND IsActive=1 default filters
  </action>
  <verify>
1. CUSTOMER RANKING section exists with top customers query (trailing 12mo, YoY, default TOP 10)
2. Alternative ranking variants documented (by order count, by avg order, all time, specific year)
3. Pareto analysis query present with cumulative percentage calculation
4. Cross-check note referencing sales skill consistency
5. RFM SEGMENTATION section with scoring query using NTILE(5)
6. All 7 named segments mapped (Champions through Needs Attention)
7. Segment summary query present for "show segmentation" response
8. Walk-In excluded from all ranking/segmentation queries
9. All revenue queries use validated formula (TransactionType=1, SubTotalPrice, SaleDate, StatusID NOT IN 9)
10. If over 1,000 lines: references/customer-analysis.md created with full queries; main file has summaries with cross-references
11. If under 1,000 lines: all content in main file
  </verify>
  <done>Customer ranking with top customers (default revenue, trailing 12mo, with YoY), alternative rankings, Pareto analysis, and full RFM segmentation with 7 named segments added to skill. Extraction to references/ completed if line threshold exceeded.</done>
</task>

<task type="auto">
  <name>Task 2: Add Churn Detection and Complete NL Routing (CUST-03)</name>
  <files>
    skills/control-erp-customers/control-erp-customers-SKILL.md
    skills/control-erp-customers/references/customer-analysis.md
  </files>
  <action>
Add the AT-RISK DETECTION section after the RFM SEGMENTATION section, and complete the NL INTERPRETATION table.

**Section: AT-RISK DETECTION & DORMANCY**

1. **Multi-Signal Risk Model Overview** -- Brief explanation of the 4 risk signals:
   - **Dormancy**: Customer hasn't ordered within their personalized threshold
   - **Declining spend**: Trailing 12mo revenue significantly below prior 12mo
   - **Shrinking orders**: Average order value declining
   - **Late payments**: Increasing BalanceDue or overdue AR

2. **Personalized Dormancy Detection (primary query)** -- Use the full query from research Pattern 5 (lines 214-269). This is the core at-risk query. Must include:
   - OrderGaps CTE using LAG() window function to calculate days between orders per customer
   - CustomerCadence CTE computing: AVG gap, STDEV gap, personal threshold (avg + 1.5 * stdev)
   - Minimum 4 orders required to establish a pattern (COUNT(*) >= 4)
   - 90-day fallback for customers without enough history
   - Output columns: CompanyName, AccountNumber, LastOrderDate, DaysSinceLastOrder, TypicalOrderGapDays, DormancyThresholdDays, DaysOverdue, Trailing12MoRevenue, Prior12MoRevenue
   - HAVING clause: DaysSinceLastOrder > PersonalThreshold (only show actually overdue customers)
   - ORDER BY combined score: Trailing12MoRevenue * (DaysSinceLastOrder / PersonalThreshold) DESC
   - This sorts by blended impact: high-revenue slightly-overdue ranks similar to mid-revenue very-overdue

3. **Simple Dormancy (fallback)** -- For quick "who hasn't ordered in X days":
```sql
SELECT
    a.CompanyName,
    a.AccountNumber,
    MAX(th.SaleDate) AS LastOrderDate,
    DATEDIFF(DAY, MAX(th.SaleDate), GETDATE()) AS DaysSinceLastOrder,
    SUM(CASE WHEN th.SaleDate >= DATEADD(YEAR, -1, GETDATE()) THEN th.SubTotalPrice ELSE 0 END) AS Trailing12MoRevenue
FROM Account a
JOIN TransHeader th ON th.AccountID = a.ID
WHERE a.IsActive = 1 AND a.IsClient = 1 AND a.AccountNumber > 0
  AND th.TransactionType = 1 AND th.IsActive = 1
  AND th.SaleDate IS NOT NULL AND th.StatusID NOT IN (9)
GROUP BY a.CompanyName, a.AccountNumber
HAVING DATEDIFF(DAY, MAX(th.SaleDate), GETDATE()) > @DaysThreshold  -- User specifies: 90, 180, etc.
ORDER BY Trailing12MoRevenue DESC
```

4. **Spend Trend Detection** -- Customers with significant revenue decline:
```sql
-- Customers where trailing 12mo revenue dropped >30% vs prior 12mo
;WITH CustomerTrend AS (
    SELECT
        a.ID,
        a.CompanyName,
        a.AccountNumber,
        SUM(CASE WHEN th.SaleDate >= DATEADD(YEAR, -1, GETDATE()) THEN th.SubTotalPrice ELSE 0 END) AS T12M,
        SUM(CASE WHEN th.SaleDate >= DATEADD(YEAR, -2, GETDATE())
                  AND th.SaleDate < DATEADD(YEAR, -1, GETDATE()) THEN th.SubTotalPrice ELSE 0 END) AS P12M
    FROM Account a
    JOIN TransHeader th ON th.AccountID = a.ID
    WHERE a.IsActive = 1 AND a.IsClient = 1 AND a.AccountNumber > 0
      AND th.TransactionType = 1 AND th.IsActive = 1
      AND th.SaleDate IS NOT NULL AND th.StatusID NOT IN (9)
    GROUP BY a.ID, a.CompanyName, a.AccountNumber
)
SELECT
    CompanyName,
    AccountNumber,
    T12M AS CurrentRevenue,
    P12M AS PriorRevenue,
    CAST((T12M - P12M) * 100.0 / NULLIF(P12M, 0) AS DECIMAL(5,1)) AS YoYChangePct
FROM CustomerTrend
WHERE P12M > 0 AND T12M < P12M * 0.7  -- 30%+ decline
ORDER BY P12M DESC  -- Highest prior-year revenue first (most impactful losses)
```

5. **Risk Signal Notes:**
   - Dormancy is the primary signal (most actionable)
   - Spend trend is the secondary signal (detects slow fade before full dormancy)
   - Late payment detection: reference the financial skill's AR detail for per-customer overdue AR (do not duplicate the query here)
   - Shrinking order size: can be computed from the ranking query by comparing AvgOrderValue across time periods (document the approach, not a separate query)

**If references/customer-analysis.md was created in Task 1:**
Move the full personalized dormancy query (with OrderGaps and CustomerCadence CTEs) to the references file. Keep a simplified version and cross-reference in the main file.

**If references/customer-analysis.md was NOT created in Task 1 but main file now exceeds ~1,000 lines:**
Create the references file now and extract the detailed RFM + dormancy + Pareto queries to it. Keep summaries and simplified versions in the main file.

**Complete the NL INTERPRETATION table** -- Replace the placeholder comment from Plan 01 and add ALL routing entries:

Ranking/Segmentation routes:
- "top customers" / "best customers" / "biggest customers" -> Top Customers by Revenue
- "top customers by orders" / "most frequent customers" -> Top Customers by Order Count
- "customer segmentation" / "RFM" / "segment customers" -> RFM Segment Summary
- "80/20" / "Pareto" / "which customers make up 80%" -> Pareto Analysis
- "customer lifetime value" / "CLV" -> Top Customers (lifetime, remove date filter)

At-Risk routes:
- "at risk customers" / "customers at risk" / "churn risk" -> Personalized Dormancy Detection
- "who hasn't ordered" / "inactive customers" / "dormant customers" -> Simple Dormancy (with threshold)
- "customers haven't ordered in X days/months" -> Simple Dormancy with specified threshold
- "declining customers" / "losing customers" / "revenue decline" -> Spend Trend Detection
- "customer health" / "account health" -> Combined: Dormancy + Spend Trend overview

Cross-domain routes:
- "AR for [customer]" -> Reference financial skill for detailed AR aging
- "orders for [customer]" -> Recent Order History drill-down (from Plan 01)
- "sales by customer" -> Reference sales skill or use Top Customers ranking

CRITICAL: Verify the complete file has no references to "AccountName" (must be CompanyName). Verify all revenue queries use the validated formula. Verify Walk-In is excluded from all analytics queries.
  </action>
  <verify>
1. AT-RISK DETECTION section exists with multi-signal risk model overview
2. Personalized dormancy query has OrderGaps CTE with LAG(), CustomerCadence with avg+1.5*stdev, 4-order minimum, 90-day fallback
3. Simple dormancy fallback query present with user-specified threshold
4. Spend trend detection query identifies >30% revenue decline
5. Combined sort score blends revenue impact with overdue severity
6. NL INTERPRETATION table is COMPLETE with routing for ALL patterns (search, profile, drill-down, ranking, segmentation, at-risk)
7. No placeholder comments remaining in the file
8. Cross-domain routes reference financial skill and sales skill where appropriate
9. If file exceeds ~1,000 lines: detailed queries extracted to references/customer-analysis.md with cross-references
10. No "AccountName" anywhere in the file (grep check)
11. All analytics queries exclude Walk-In (AccountNumber > 0)
12. All revenue queries use validated formula
13. Total line count of main SKILL.md tracked
  </verify>
  <done>At-risk detection with personalized dormancy thresholds, spend trend analysis, and complete NL routing table added. All CUST-03 patterns covered. Extraction to references/ completed if threshold exceeded. Skill file is complete with all three requirements (CUST-01, CUST-02, CUST-03) fully implemented.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. CUST-02 covered: Top customers (revenue default, alternative rankings), Pareto analysis, full RFM segmentation with 7 named segments
2. CUST-03 covered: Personalized dormancy detection (avg gap + 1.5 stdev, 4-order minimum, 90-day fallback), simple dormancy, spend trend
3. All ranking queries include YoY comparison
4. Combined risk scoring blends revenue impact with overdue severity
5. NL routing table is complete (all CUST-01 + CUST-02 + CUST-03 patterns)
6. Revenue queries consistent with core baseline formula
7. Walk-In excluded from all analytics
8. File extraction to references/ handled correctly based on line count
9. No "AccountName" in file (must be CompanyName)
10. Cross-domain references to financial skill and sales skill documented
</verification>

<success_criteria>
- CUST-02 fully covered: top customer rankings (revenue, order count, lifetime), Pareto analysis, RFM segmentation with Champions/Loyal/At Risk/Lost/etc.
- CUST-03 fully covered: personalized dormancy (avg+1.5*stdev, 4-order minimum, 90-day fallback), simple dormancy, spend trend, combined risk scoring
- All revenue figures include YoY
- NL routing complete for all customer intelligence patterns
- Skill file properly structured (main file ~800-1,000 lines, detailed queries in references/ if needed)
- Internal consistency: ranking output cross-checks against validated sales skill numbers
</success_criteria>

<output>
After completion, create `.planning/phases/10-customer-intelligence/10-02-SUMMARY.md`
</output>
