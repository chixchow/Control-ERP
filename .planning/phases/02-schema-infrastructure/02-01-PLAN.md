---
phase: 02-schema-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - output/schemas/Account.md
  - output/schemas/TransHeader.md
  - output/schemas/TransDetail.md
  - output/schemas/Product.md
  - output/schemas/Employee.md
  - output/schemas/TimeCard.md
  - output/schemas/Payment.md
  - output/schemas/Part.md
  - output/schemas/Shipments.md
  - output/schemas/Station.md
  - output/relationships.md
autonomous: true

must_haves:
  truths:
    - "Spot-checking any 5 schema files against the live database shows matching column names, data types, nullable flags, and approximate row counts"
    - "The FK count in relationships.md matches the count from sys.foreign_keys (or any discrepancy is documented and explained)"
    - "Inferred relationships section in relationships.md covers common naming patterns (AccountID -> Account.ID, StoreID -> Store.ID, etc.)"
  artifacts:
    - path: "output/schemas/*.md"
      provides: "187 table schema files with columns, types, nullable, row counts"
      min_files: 187
    - path: "output/relationships.md"
      provides: "Explicit FK + inferred relationship documentation"
      contains: "sys.foreign_keys"
  key_links:
    - from: "output/schemas/*.md"
      to: "INFORMATION_SCHEMA.COLUMNS"
      via: "spot-check verification queries"
      pattern: "Column Name.*Data Type.*Nullable"
    - from: "output/relationships.md"
      to: "sys.foreign_keys"
      via: "FK count verification query"
      pattern: "FK_Name.*ParentTable.*ReferencedTable"
---

<objective>
Verify schema documentation (CORE-03) and FK relationships (CORE-04) against the live StoreData database.

Purpose: The 187 schema files and relationships.md already exist and were found ~95% complete during research. This plan performs the formal spot-check verification required by the success criteria -- querying the actual database and comparing results to the documentation. Any discrepancies found are corrected in-place.

Output: Verified schema files (with any corrections applied) and a verified relationships.md. A verification log documenting what was checked and what was found.
</objective>

<execution_context>
@/Users/cain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-schema-infrastructure/02-RESEARCH.md

Key existing artifacts:
@output/schemas/Account.md (example schema file format)
@output/relationships.md (FK and inferred relationships)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Spot-check 10 schema files against live database</name>
  <files>
    output/schemas/Account.md
    output/schemas/TransHeader.md
    output/schemas/TransDetail.md
    output/schemas/Product.md
    output/schemas/Employee.md
    output/schemas/TimeCard.md
    output/schemas/Payment.md
    output/schemas/Part.md
    output/schemas/Shipments.md
    output/schemas/Station.md
  </files>
  <action>
    For each of the 10 tables listed above, perform a 3-part verification:

    1. **Column verification**: Run `SELECT COLUMN_NAME, DATA_TYPE, CHARACTER_MAXIMUM_LENGTH, IS_NULLABLE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'TableName' ORDER BY ORDINAL_POSITION` and compare the result to the Columns table in the corresponding schema .md file. Check for:
       - Missing columns (in DB but not in .md)
       - Extra columns (in .md but not in DB)
       - Wrong data types
       - Wrong nullable flags

    2. **Row count verification**: Run `SELECT COUNT(*) AS RowCount FROM dbo.TableName` and compare to the Row Count listed in the schema file. If the count differs by more than 10%, update the schema file with the new count. If within 10%, leave as-is (counts drift over time).
       - EXCEPTION: For TimeCard, do NOT run `SELECT *` -- it has geography columns. The COUNT(*) query is safe.

    3. **FK verification per table**: Check if the schema file's Foreign Keys section matches what the database reports for that specific table.

    If any discrepancies are found, update the schema .md file to match the database. Add a note at the bottom of any corrected file: `<!-- Verified against live DB on YYYY-MM-DD -->`.

    Record all results in a verification log (keep in memory for the summary).

    The success criterion requires 5+ tables spot-checked. We are doing 10 for higher confidence. These 10 were selected to cover different domains: Accounts (Account), Orders (TransHeader, TransDetail), Products (Product), HR (Employee, TimeCard), Finance (Payment), Inventory (Part), Shipping (Shipments), Production (Station).
  </action>
  <verify>
    All 10 INFORMATION_SCHEMA queries executed successfully. Any discrepancies found were corrected in the schema files. No query errors (especially no geography column errors on TimeCard).
  </verify>
  <done>
    10 schema files verified against live database. Column lists, data types, nullable flags match. Row counts within 10% or updated. Any corrections applied directly to the .md files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify FK relationship completeness against sys.foreign_keys</name>
  <files>output/relationships.md</files>
  <action>
    1. **Count FK relationships in database**: Run the full sys.foreign_keys query from CLAUDE.md:
       ```sql
       SELECT
           fk.name AS FK_Name,
           tp.name AS ParentTable,
           cp.name AS ParentColumn,
           tr.name AS ReferencedTable,
           cr.name AS ReferencedColumn
       FROM sys.foreign_keys fk
       JOIN sys.foreign_key_columns fkc ON fk.object_id = fkc.constraint_object_id
       JOIN sys.tables tp ON fkc.parent_object_id = tp.object_id
       JOIN sys.columns cp ON fkc.parent_object_id = cp.object_id AND fkc.parent_column_id = cp.column_id
       JOIN sys.tables tr ON fkc.referenced_object_id = tr.object_id
       JOIN sys.columns cr ON fkc.referenced_object_id = cr.object_id AND fkc.referenced_column_id = cr.column_id
       ORDER BY tp.name, cp.name
       ```

    2. **Compare with relationships.md**: Read `output/relationships.md` and compare:
       - Total FK count from database vs count documented
       - Any FKs in database not listed in relationships.md (additions since initial extraction)
       - Any FKs in relationships.md not in database (removed or renamed)

    3. **Verify inferred relationships section exists**: Confirm relationships.md has a section documenting inferred/implicit relationships based on naming patterns (e.g., AccountID -> Account.ID, StoreID -> Store.ID). This section does NOT need database verification -- it is pattern-based documentation.

    4. **Fix any gaps**: If the database has FKs not documented in relationships.md, add them to the appropriate section. If relationships.md has FKs that no longer exist, remove or mark them.

    5. **Document the verification**: At the top or bottom of relationships.md, add a verification note: `<!-- FK count verified against sys.foreign_keys on YYYY-MM-DD: N explicit FKs -->`.
  </action>
  <verify>
    The sys.foreign_keys query executed successfully. FK count from database matches relationships.md (or discrepancies have been resolved). Inferred relationships section confirmed present.
  </verify>
  <done>
    relationships.md verified against live database. Explicit FK count matches sys.foreign_keys output. Inferred relationships section present and covering major naming patterns. Any missing FKs added, any stale FKs removed.
  </done>
</task>

</tasks>

<verification>
- 10 schema files spot-checked against INFORMATION_SCHEMA.COLUMNS with zero unresolved discrepancies
- FK count from sys.foreign_keys matches relationships.md documented count
- No query errors during verification (especially no geography/spatial errors)
- All corrections applied to source files (not just noted)
</verification>

<success_criteria>
1. Spot-checking any 5 of the 10 verified tables shows matching column names, data types, nullable flags between .md file and live database
2. relationships.md FK count matches sys.foreign_keys count (or documented explanation for any difference)
3. Inferred relationships section exists in relationships.md covering common column naming patterns
4. Requirements CORE-03 and CORE-04 can be marked verified
</success_criteria>

<output>
After completion, create `.planning/phases/02-schema-infrastructure/02-01-SUMMARY.md`
</output>
