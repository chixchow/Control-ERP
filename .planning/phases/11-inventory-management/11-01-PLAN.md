---
phase: 11-inventory-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/control-erp-inventory/control-erp-inventory-SKILL.md
autonomous: true

must_haves:
  truths:
    - "User can search for a part by name and get current stock levels showing both QuantityAvailable and QuantityOnHand with unit context"
    - "User can ask 'what needs reordering' and get parts below their reorder threshold with suggested reorder quantities"
    - "Stock level queries use the Inventory table (ClassTypeID 12200) with IsGroup=0 AND IsDivisionSummary=0 filter, never Part table quantities alone"
    - "Results always include unit context (DisplayUnitText) and note when display units differ from inventory units"
    - "Data quality warnings appear for negative quantities and for the two-tier confidence model"
  artifacts:
    - path: "skills/control-erp-inventory/control-erp-inventory-SKILL.md"
      provides: "Inventory skill with table architecture, stock checks, and reorder alerts"
      contains: "STOCK LEVEL"
    - path: "skills/control-erp-inventory/control-erp-inventory-SKILL.md"
      provides: "Reorder monitoring queries"
      contains: "REORDER"
    - path: "skills/control-erp-inventory/control-erp-inventory-SKILL.md"
      provides: "Two-tier confidence model documentation"
      contains: "PRIMARY TIER"
  key_links:
    - from: "Stock level query"
      to: "Part JOIN Inventory ON PartID with warehouse filter"
      via: "Canonical join with ClassTypeID=12200, IsGroup=0, IsDivisionSummary=0, WarehouseID=10"
      pattern: "JOIN Inventory.*PartID.*ClassTypeID = 12200.*IsGroup = 0"
    - from: "Part category display"
      to: "PricingElement table (ClassTypeID 12035)"
      via: "LEFT JOIN on Part.CategoryID = PricingElement.ID"
      pattern: "PricingElement.*CategoryID.*12035"
    - from: "Reorder alert query"
      to: "Inventory.ReorderPoint and ReOrderQuantity fields"
      via: "WHERE QuantityAvailable <= ReorderPoint AND ReorderPoint > 0"
      pattern: "QuantityAvailable.*ReorderPoint"
---

<objective>
Create the control-erp-inventory skill with table architecture, stock level queries (INV-01), and reorder monitoring (INV-02).

Purpose: Users need to check what's in stock and what needs reordering. This is the most common inventory use case and establishes the skill file that Plan 02 extends with purchasing intelligence and material planning.

Output: New skill file `skills/control-erp-inventory/control-erp-inventory-SKILL.md` with YAML frontmatter, table architecture, two-tier confidence model, stock level queries, reorder alert report, and data quality warnings.
</objective>

<execution_context>
@/Users/cain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-inventory-management/11-CONTEXT.md
@.planning/phases/11-inventory-management/11-RESEARCH.md
@skills/control-erp-core/control-erp-core-SKILL.md
@skills/control-erp-customers/control-erp-customers-SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Skill File with Table Architecture and Two-Tier Model</name>
  <files>skills/control-erp-inventory/control-erp-inventory-SKILL.md</files>
  <action>
Create the skill directory and file: `skills/control-erp-inventory/control-erp-inventory-SKILL.md`

Write the file with these sections:

**YAML frontmatter:**
```yaml
---
name: control-erp-inventory
description: Check stock levels, find parts, monitor reorder points, look up purchase order history and vendor costs, analyze material consumption. Use when user asks about inventory, stock, parts, reorder, warehouse, material, purchase orders, POs, vendor costs, "what's in stock", "what does X cost", or supplier queries. Depends on control-erp-core for business rules.
---
```

**Section 1: Header and overview**
- `# Control ERP Inventory Management -- Stock, Reorder & Purchasing Intelligence`
- `**Depends on:** control-erp-core` (always read core first for business rules)
- Overview paragraph explaining the two-tier model:
  - **Primary Tier (Reliable):** Purchasing intelligence -- PO history, vendor costs, order frequency. Type 7 PO data is well-maintained.
  - **Secondary Tier (Caveated):** Inventory quantities -- stock levels, reorder alerts. FLS is migrating inventory data from Google Sheets to Control; quantities may not reflect reality. Always caveat inventory quantity results.
- Key stats: 392 active tracked parts, 74 with reorder points configured, 2 warehouses (Default=10 has all meaningful stock)

**Section 2: CRITICAL WARNINGS**
Create a prominent warnings box (use `> **WARNING**` blockquote style) with:
1. **Inventory data quality:** FLS inventory is being migrated from Google Sheets. Quantities may be inaccurate. Always warn users that stock levels should be verified physically. Purchasing data (PO history) is reliable.
2. **Inventory table has 4 rows per part:** Must always filter `IsGroup = 0 AND IsDivisionSummary = 0` to get actual warehouse rows, not summaries. Without this filter, quantities are doubled or quadrupled.
3. **Use Inventory table, not Part table quantities:** Part has quantity fields but they are NOT canonical. Always use `Inventory` table with `ClassTypeID = 12200`.
4. **AverageCost is per inventory unit, not per display unit:** When display units differ from inventory units (50 parts), costs need context. Always show the unit alongside cost.
5. **Never use QuantityOnHand * AverageCost for total valuation:** Produces -$2.1M (meaningless). Use GL NodeID 10414 for accounting valuation ($651K).
6. **Default filter chain:** `Part.IsActive = 1 AND Part.TrackInventory = 1` then context-dependent: stock checks exclude zero-qty, reorder checks include zero-qty.
7. **Negative quantities are expected:** 214 records have negative QuantityOnHand. Flag them as data quality issues, don't treat as errors.

**Section 3: TABLE ARCHITECTURE**
Document the tables used by this skill with row counts:

| Table | Rows | Purpose | Key Columns |
|-------|------|---------|-------------|
| **Part** | 7,684 (392 active tracked) | Parts catalog | ItemName, SKU, TrackInventory, AccrueCosts, CategoryID, UnitID, UnitCost, DisplayUnitText, UseInvUnitsForDisplay, PartType |
| **Inventory** | 27,268 | Stock levels per warehouse | PartID, WarehouseID, QuantityAvailable, QuantityOnHand, QuantityReserved, QuantityOnOrder, AverageCost, ReorderPoint, ReOrderQuantity, IsGroup, IsDivisionSummary, ClassTypeID=12200 |
| **PricingElement** | (varies) | Part categories | ElementName, ClassTypeID=12035 (for part categories) |
| **_Unit** | 55 | Unit of measure reference | UnitText, UnitType, ConversionUnit |
| **Warehouse** | 5 | Warehouse definitions | Name, IsDefault, IsGroup, DivisionDataID |
| **VendorTransDetail** | 129,701 | PO line items | ItemID, ItemClassTypeID (12014=Part, 12076=CatalogItem), UnitPrice, Quantity, UnitText, TransHeaderID |
| **CatalogItem** | 581 | Vendor catalog links | PartID, VendorID, Cost, VendorPartName, IsDefault |
| **TransHeader** | 232,243 | PO headers (Type 7) | TransactionType=7, AccountID (vendor), TransactionNumber, StatusID |
| **PartUsageCard** | 286,713 | Consumption history | PartID, Amount, Cost, PostDate, TransHeaderID, WarehouseID, IsVoided |
| **InventoryLog** | 906,845 | Movement history | PartID, InventoryID, QuantityOnHand, ClassTypeID (20531=adjust, 20520=update, 20530=receive) |

**FLS Warehouse Configuration (discovered):**
- **Warehouse 10** (Default Warehouse for Company): Primary warehouse, 273 parts with stock. **Use this for all queries by default.**
- **Warehouse 10001** (Apparel WH): Only 3 parts with stock. Mention only if user asks about warehouse breakdown or apparel.
- Warehouses 11 and 10000 are group/summary records -- always filter out.

**Inventory Formula (from Control wiki):**
```
Billed + Received Only = On Hand
On Hand - Reserved = Available
Available + On Order = Expected
```

**Inventory Tracking Modes:**
1. No Tracking (TrackInventory=0) -- 4,487 active parts, skip these
2. Level Tracking Only (TrackInventory=1, AccrueCosts=0) -- 193 active parts, quantities only, no GL entries
3. Full Accrual (TrackInventory=1, AccrueCosts=1) -- 199 active parts, full GL integration via NodeID 10414

**Part Category Reference (Top 10):**
Include the top 10 categories from research: Blank Table Covers (112), Inks (27), DH - Feather Flag (21), DH - Tent Spare Parts (16), Fabrics (15), Packing Materials (14), FR 66 Knit (12), DH - Golf (12), Knit Poly (11), DH - Pillow Case Frame (10).

**Part-to-Inventory Join Pattern:**
Document the canonical join (from research):
```sql
-- Canonical Part -> Inventory join (gets actual warehouse row, not summaries)
SELECT p.ItemName, i.QuantityOnHand, i.QuantityAvailable, i.AverageCost
FROM Part p
JOIN Inventory i ON i.PartID = p.ID
    AND i.ClassTypeID = 12200
    AND i.IsGroup = 0 AND i.IsDivisionSummary = 0
    AND i.WarehouseID = 10
WHERE p.IsActive = 1 AND p.TrackInventory = 1
```

Note: Do NOT use Part.InventoryID for joining (only 29 of 392 tracked parts have it populated -- legacy field).
  </action>
  <verify>
1. File exists at skills/control-erp-inventory/control-erp-inventory-SKILL.md
2. YAML frontmatter has name and description with NL trigger terms
3. Two-tier model (Primary=purchasing, Secondary=inventory) documented in overview
4. CRITICAL WARNINGS section has all 7 warnings
5. TABLE ARCHITECTURE lists all 10 tables with row counts and key columns
6. FLS warehouse configuration documents Warehouse 10 as default
7. Inventory formula documented (Billed + Received = OnHand, OnHand - Reserved = Available)
8. Canonical Part-to-Inventory join includes ClassTypeID=12200, IsGroup=0, IsDivisionSummary=0
9. Part.InventoryID explicitly warned against
  </verify>
  <done>Skill file created with YAML frontmatter, two-tier confidence model, 7 critical warnings, complete table architecture (10 tables), FLS warehouse configuration, inventory formula, tracking modes, and canonical join pattern.</done>
</task>

<task type="auto">
  <name>Task 2: Add Stock Level Queries (INV-01) and Reorder Monitoring (INV-02)</name>
  <files>skills/control-erp-inventory/control-erp-inventory-SKILL.md</files>
  <action>
Append to the skill file the query sections for INV-01 and INV-02.

**Section 4: STOCK LEVEL QUERIES (INV-01)**

4a. **Check Inventory for a Specific Part (by name search)**
```sql
SELECT
    p.ItemName,
    p.SKU,
    pe.ElementName AS Category,
    i.QuantityAvailable,
    i.QuantityOnHand,
    i.QuantityReserved,
    i.QuantityOnOrder,
    i.AverageCost,
    p.DisplayUnitText AS Unit,
    CASE WHEN p.UseInvUnitsForDisplay = 0
         THEN p.DisplayUnitText + ' (inventory tracked in: ' + u.UnitText + ')'
         ELSE p.DisplayUnitText END AS UnitContext,
    i.ReorderPoint,
    i.Location
FROM Part p
JOIN Inventory i ON i.PartID = p.ID
    AND i.ClassTypeID = 12200
    AND i.IsGroup = 0 AND i.IsDivisionSummary = 0
    AND i.WarehouseID = 10
LEFT JOIN PricingElement pe ON p.CategoryID = pe.ID AND pe.ClassTypeID = 12035
LEFT JOIN _Unit u ON p.UnitID = u.UnitID
WHERE p.IsActive = 1
    AND p.TrackInventory = 1
    AND p.ItemName LIKE '%search_term%'
ORDER BY p.ItemName
```

Add guidance for result formatting:
- Summary format: "**[ItemName]**: [QuantityAvailable] available ([QuantityOnHand] on hand, [QuantityReserved] reserved) -- [Unit]"
- If QuantityAvailable is negative, add warning: "(negative quantity -- data quality issue, verify physically)"
- If UseInvUnitsForDisplay = 0, show both display and inventory units
- If ReorderPoint > 0 and QuantityAvailable <= ReorderPoint, add: "BELOW REORDER POINT"

4b. **What's In Stock (broad overview)**
Show top 25 parts with stock, ordered by QuantityOnHand DESC:
```sql
SELECT TOP 25
    p.ItemName,
    pe.ElementName AS Category,
    i.QuantityAvailable,
    i.QuantityOnHand,
    p.DisplayUnitText AS Unit,
    i.AverageCost
FROM Part p
JOIN Inventory i ON i.PartID = p.ID
    AND i.ClassTypeID = 12200
    AND i.IsGroup = 0 AND i.IsDivisionSummary = 0
    AND i.WarehouseID = 10
LEFT JOIN PricingElement pe ON p.CategoryID = pe.ID AND pe.ClassTypeID = 12035
WHERE p.IsActive = 1
    AND p.TrackInventory = 1
    AND i.QuantityOnHand > 0
ORDER BY i.QuantityOnHand DESC
```
Note: 552 inventory records have QuantityOnHand > 0 across 392 tracked parts. For broad queries, show top 25 to avoid overwhelming output.

4c. **Parts by Category**
```sql
SELECT
    pe.ElementName AS Category,
    COUNT(*) AS PartCount,
    SUM(CASE WHEN i.QuantityOnHand > 0 THEN 1 ELSE 0 END) AS WithStock,
    SUM(CASE WHEN i.QuantityAvailable < 0 THEN 1 ELSE 0 END) AS NegativeQty
FROM Part p
JOIN Inventory i ON i.PartID = p.ID
    AND i.ClassTypeID = 12200
    AND i.IsGroup = 0 AND i.IsDivisionSummary = 0
    AND i.WarehouseID = 10
LEFT JOIN PricingElement pe ON p.CategoryID = pe.ID AND pe.ClassTypeID = 12035
WHERE p.IsActive = 1 AND p.TrackInventory = 1
GROUP BY pe.ElementName
ORDER BY PartCount DESC
```

4d. **Part Detail Card (drill-down for a specific part)**
For when user wants full detail on one part:
```sql
SELECT
    p.ID AS PartID,
    p.ItemName,
    p.SKU,
    p.BarCode,
    pe.ElementName AS Category,
    p.DisplayUnitText AS DisplayUnit,
    CASE WHEN p.UseInvUnitsForDisplay = 0 THEN u.UnitText ELSE p.DisplayUnitText END AS InventoryUnit,
    p.UseInvUnitsForDisplay,
    p.TransferUnitText AS PurchaseUnit,
    p.TransferUnitQuantity AS QtyPerPurchaseUnit,
    i.QuantityAvailable,
    i.QuantityOnHand,
    i.QuantityBilled,
    i.QuantityReceivedOnly,
    i.QuantityReserved,
    i.QuantityOnOrder,
    i.QuantityExpected,
    i.AverageCost,
    i.ReorderPoint,
    i.ReOrderQuantity,
    i.YellowNotificationPoint,
    i.RedNotificationPoint,
    i.Location,
    p.UnitCost AS DefaultUnitCost,
    p.Vendor,
    p.VendorPartNumber,
    CASE WHEN p.AccrueCosts = 1 THEN 'Full Accrual (GL integrated)' ELSE 'Level Tracking Only' END AS TrackingMode
FROM Part p
JOIN Inventory i ON i.PartID = p.ID
    AND i.ClassTypeID = 12200
    AND i.IsGroup = 0 AND i.IsDivisionSummary = 0
    AND i.WarehouseID = 10
LEFT JOIN PricingElement pe ON p.CategoryID = pe.ID AND pe.ClassTypeID = 12035
LEFT JOIN _Unit u ON p.UnitID = u.UnitID
WHERE p.ID = @PartID
```

**Section 5: REORDER MONITORING (INV-02)**

5a. **Parts Below Reorder Point**
```sql
SELECT
    p.ItemName,
    pe.ElementName AS Category,
    i.QuantityAvailable,
    i.QuantityOnHand,
    i.ReorderPoint,
    i.ReOrderQuantity AS SuggestedReorderQty,
    i.QuantityOnOrder,
    p.DisplayUnitText AS Unit,
    i.AverageCost,
    i.AverageCost * i.ReOrderQuantity AS EstimatedReorderCost
FROM Part p
JOIN Inventory i ON i.PartID = p.ID
    AND i.ClassTypeID = 12200
    AND i.IsGroup = 0 AND i.IsDivisionSummary = 0
    AND i.WarehouseID = 10
LEFT JOIN PricingElement pe ON p.CategoryID = pe.ID AND pe.ClassTypeID = 12035
WHERE p.IsActive = 1
    AND p.TrackInventory = 1
    AND i.ReorderPoint > 0
    AND i.QuantityAvailable <= i.ReorderPoint
ORDER BY (i.QuantityAvailable - i.ReorderPoint) ASC
```
Note: Only 74 parts have ReorderPoint configured. Include zero-quantity parts in reorder checks (zero = definitely needs reorder). Sort by most urgent (biggest deficit) first.

Add formatting guidance:
- For each part: "[ItemName]: [QuantityAvailable] available vs [ReorderPoint] reorder point -- REORDER [SuggestedReorderQty] [Unit] (est. $[EstimatedReorderCost])"
- If QuantityOnOrder > 0, note: "(already [QuantityOnOrder] on order)"
- If QuantityAvailable is negative, flag urgently

5b. **Reorder Summary by Category**
```sql
SELECT
    pe.ElementName AS Category,
    COUNT(*) AS PartsNeedingReorder,
    SUM(i.ReOrderQuantity * i.AverageCost) AS TotalEstimatedCost
FROM Part p
JOIN Inventory i ON i.PartID = p.ID
    AND i.ClassTypeID = 12200
    AND i.IsGroup = 0 AND i.IsDivisionSummary = 0
    AND i.WarehouseID = 10
LEFT JOIN PricingElement pe ON p.CategoryID = pe.ID AND pe.ClassTypeID = 12035
WHERE p.IsActive = 1
    AND p.TrackInventory = 1
    AND i.ReorderPoint > 0
    AND i.QuantityAvailable <= i.ReorderPoint
GROUP BY pe.ElementName
ORDER BY PartsNeedingReorder DESC
```

5c. **Coverage note:**
Add a note that reorder alerts depend on accurate ReorderPoint configuration in Control. Only 74 of 392 tracked parts have reorder points set. Parts without reorder points won't appear in alerts even if at zero stock. Recommend user work with Control admin to configure reorder points for critical parts.

Add a placeholder for Plan 02: `<!-- Plan 02 adds: purchasing intelligence (PO history, last price paid, vendor costs), material consumption analysis, inventory valuation, and NL routing table -->`

CRITICAL REMINDERS for the executor:
- Always include ClassTypeID=12200 in Inventory joins
- Always include IsGroup=0 AND IsDivisionSummary=0
- Always default to WarehouseID=10
- Always show DisplayUnitText with results
- Zero-qty included in reorder checks, excluded from stock checks
- No references to Part.InventoryID
  </action>
  <verify>
1. Section 4 (STOCK LEVEL QUERIES) has 4 subsections: part search, broad overview, by category, part detail card
2. All stock queries include the canonical Inventory join (ClassTypeID=12200, IsGroup=0, IsDivisionSummary=0, WarehouseID=10)
3. Part search query uses LIKE for name matching
4. Broad overview shows TOP 25 with QuantityOnHand > 0
5. Part detail card includes all quantity fields plus tracking mode and unit context
6. Section 5 (REORDER MONITORING) has reorder alert query with QuantityAvailable <= ReorderPoint
7. Reorder query includes zero-qty parts (no QuantityOnHand > 0 filter)
8. Reorder sorts by most urgent first (biggest deficit)
9. EstimatedReorderCost calculated (AverageCost * ReOrderQuantity)
10. Coverage note mentions only 74 parts have reorder points
11. DisplayUnitText included in all query result sets
12. Plan 02 placeholder comment present
  </verify>
  <done>INV-01 covered with 4 stock level queries (part search, broad overview, category summary, detail card). INV-02 covered with reorder alert report (deficit-sorted), category summary, and coverage note. All queries use canonical Inventory join with proper filters. Plan 02 placeholder present for purchasing intelligence and NL routing.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. skills/control-erp-inventory/control-erp-inventory-SKILL.md exists with valid YAML frontmatter
2. Two-tier confidence model (Primary=purchasing, Secondary=inventory) documented
3. All 7 critical warnings present in prominent warnings section
4. Table architecture documents 10 tables with row counts
5. FLS warehouse configuration correctly identifies Warehouse 10 as default
6. Canonical Part-to-Inventory join documented with all required filters
7. INV-01: 4 stock level queries present (part search, broad overview, by category, detail card)
8. INV-02: Reorder alert query sorts by most urgent, includes zero-qty parts
9. Every Inventory query includes ClassTypeID=12200, IsGroup=0, IsDivisionSummary=0
10. DisplayUnitText included in all query result sets
11. No references to Part.InventoryID for joining
12. File structure ready for Plan 02 to extend with purchasing intelligence and NL routing
</verification>

<success_criteria>
- INV-01 fully covered: users can search for parts and check stock levels with both Available and OnHand quantities
- INV-02 fully covered: users can see parts below reorder threshold with suggested quantities and estimated cost
- Two-tier confidence model clearly separates reliable PO data from caveated inventory data
- All queries use correct Inventory table patterns (never Part table quantities)
- Unit context always displayed (DisplayUnitText, with inventory unit noted when different)
- Data quality warnings present for negative quantities and migration status
- File structure ready for Plan 02 extension
</success_criteria>

<output>
After completion, create `.planning/phases/11-inventory-management/11-01-SUMMARY.md`
</output>
