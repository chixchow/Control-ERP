---
phase: 11-inventory-management
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - skills/control-erp-inventory/control-erp-inventory-SKILL.md
autonomous: true

must_haves:
  truths:
    - "User can ask 'what does [part] cost' and get last price paid from PO history with vendor and PO number"
    - "User can ask about PO history for a part and get the last 10 purchase orders with vendor, qty, price, and unit"
    - "User can ask 'what's our inventory worth' and get GL NodeID 10414 balance ($651K), not part-level calculation"
    - "User can ask about material consumption rates and get average monthly usage from PartUsageCard"
    - "NL routing table covers all INV-01, INV-02, INV-03 patterns with clear trigger-to-query mapping"
    - "Purchasing queries use correct VendorTransDetail polymorphic join (ItemClassTypeID 12076 for CatalogItem, 12014 for direct Part)"
  artifacts:
    - path: "skills/control-erp-inventory/control-erp-inventory-SKILL.md"
      provides: "Purchasing intelligence queries (PO history, last price paid, vendor comparison)"
      contains: "PURCHASING INTELLIGENCE"
    - path: "skills/control-erp-inventory/control-erp-inventory-SKILL.md"
      provides: "Material consumption analysis queries"
      contains: "MATERIAL CONSUMPTION"
    - path: "skills/control-erp-inventory/control-erp-inventory-SKILL.md"
      provides: "Inventory valuation via GL"
      contains: "INVENTORY VALUATION"
    - path: "skills/control-erp-inventory/control-erp-inventory-SKILL.md"
      provides: "Natural language routing table"
      contains: "NATURAL LANGUAGE INTERPRETATION"
  key_links:
    - from: "Last price paid query"
      to: "VendorTransDetail -> CatalogItem -> Part chain"
      via: "JOIN CatalogItem ON vd.ItemID = ci.ID AND vd.ItemClassTypeID = 12076, then ci.PartID = p.ID"
      pattern: "CatalogItem.*ItemClassTypeID.*12076"
    - from: "Inventory valuation"
      to: "GL view with GLAccountID = 10414"
      via: "SUM(Amount) from GL WHERE GLAccountID = 10414"
      pattern: "GL.*GLAccountID = 10414"
    - from: "Consumption rate query"
      to: "PartUsageCard with IsVoided=0 and date filter"
      via: "SUM(Amount) / months from PartUsageCard"
      pattern: "PartUsageCard.*IsVoided = 0.*DATEADD"
    - from: "NL routing"
      to: "All query sections in skill"
      via: "Trigger phrase -> query section mapping"
      pattern: "NATURAL LANGUAGE INTERPRETATION"
---

<objective>
Add purchasing intelligence (INV-03 primary tier), material consumption analysis, inventory valuation, and natural language routing to the inventory skill.

Purpose: Purchasing data is the reliable primary tier for this skill. Users asking "what does X cost" or "show me PO history" get trustworthy answers from Type 7 PO data. This plan also adds consumption analysis from PartUsageCard and GL-based inventory valuation, completing all three requirements (INV-01, INV-02, INV-03).

Output: Extended skill file with purchasing intelligence section, material consumption queries, inventory valuation queries, and complete NL routing table covering all inventory-related natural language patterns.
</objective>

<execution_context>
@/Users/cain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-inventory-management/11-CONTEXT.md
@.planning/phases/11-inventory-management/11-RESEARCH.md
@.planning/phases/11-inventory-management/11-01-SUMMARY.md
@skills/control-erp-core/control-erp-core-SKILL.md
@skills/control-erp-financial/control-erp-financial-SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Purchasing Intelligence Queries (INV-03 Primary Tier)</name>
  <files>skills/control-erp-inventory/control-erp-inventory-SKILL.md</files>
  <action>
Replace the Plan 02 placeholder comment in the skill file with the following sections.

**Section 6: PURCHASING INTELLIGENCE -- PRIMARY TIER (Reliable)**

Add a tier header explaining: "Purchasing data from Type 7 POs is well-maintained and reliable. These queries are the primary source for cost lookups and vendor intelligence. When a user asks 'what does X cost', use the last price paid from PO history."

6a. **Last Price Paid for a Part (via CatalogItem -- primary path)**
Most raw materials with vendor catalog linkage use this path:
```sql
SELECT TOP 1
    p.ItemName AS PartName,
    vd.UnitPrice AS LastPricePaid,
    vd.UnitText AS PriceUnit,
    vd.Quantity AS LastQtyOrdered,
    vd.TotalPrice AS LastTotalCost,
    a.CompanyName AS Vendor,
    th.TransactionNumber AS PONumber
FROM VendorTransDetail vd
JOIN CatalogItem ci ON vd.ItemID = ci.ID AND vd.ItemClassTypeID = 12076
JOIN Part p ON ci.PartID = p.ID
JOIN TransHeader th ON vd.TransHeaderID = th.ID
JOIN Account a ON th.AccountID = a.ID
WHERE th.TransactionType = 7
    AND p.ID = @PartID
ORDER BY th.ID DESC
```

6b. **Last Price Paid for a Part (direct Part link -- secondary path)**
Garments and outsource items link directly:
```sql
SELECT TOP 1
    p.ItemName AS PartName,
    vd.UnitPrice AS LastPricePaid,
    vd.UnitText AS PriceUnit,
    vd.Quantity AS LastQtyOrdered,
    vd.TotalPrice AS LastTotalCost,
    a.CompanyName AS Vendor,
    th.TransactionNumber AS PONumber
FROM VendorTransDetail vd
JOIN Part p ON vd.ItemID = p.ID AND vd.ItemClassTypeID = 12014
JOIN TransHeader th ON vd.TransHeaderID = th.ID
JOIN Account a ON th.AccountID = a.ID
WHERE th.TransactionType = 7
    AND p.ID = @PartID
ORDER BY th.ID DESC
```

Add guidance: Try CatalogItem path (12076) first. If no results, try direct Part path (12014). 160 tracked parts have PO history via CatalogItem; 118 via direct Part link.

6c. **PO History for a Part (last 10 orders)**
```sql
SELECT TOP 10
    th.TransactionNumber AS PONumber,
    a.CompanyName AS Vendor,
    vd.Quantity,
    vd.UnitPrice,
    vd.TotalPrice,
    vd.UnitText
FROM VendorTransDetail vd
JOIN CatalogItem ci ON vd.ItemID = ci.ID AND vd.ItemClassTypeID = 12076
JOIN Part p ON ci.PartID = p.ID
JOIN TransHeader th ON vd.TransHeaderID = th.ID
JOIN Account a ON th.AccountID = a.ID
WHERE th.TransactionType = 7
    AND p.ID = @PartID
ORDER BY th.ID DESC
```

6d. **Price History for a Part (trend over time)**
```sql
SELECT TOP 20
    vd.UnitPrice,
    vd.Quantity,
    vd.UnitText,
    a.CompanyName AS Vendor,
    th.TransactionNumber AS PONumber,
    th.ID AS POSequence
FROM VendorTransDetail vd
JOIN CatalogItem ci ON vd.ItemID = ci.ID AND vd.ItemClassTypeID = 12076
JOIN Part p ON ci.PartID = p.ID
JOIN TransHeader th ON vd.TransHeaderID = th.ID
JOIN Account a ON th.AccountID = a.ID
WHERE th.TransactionType = 7
    AND p.ID = @PartID
ORDER BY th.ID DESC
```
Note: Use th.ID DESC for ordering POs by recency (auto-increment, always reliable). SaleDate may not work reliably for Type 7 records.

6e. **Top Vendors by PO Count**
```sql
SELECT TOP 10
    a.CompanyName AS Vendor,
    COUNT(DISTINCT th.ID) AS POCount,
    SUM(vd.TotalPrice) AS TotalSpend
FROM VendorTransDetail vd
JOIN TransHeader th ON vd.TransHeaderID = th.ID
JOIN Account a ON th.AccountID = a.ID
WHERE th.TransactionType = 7
    AND th.StatusID NOT IN (29)  -- exclude cancelled
GROUP BY a.CompanyName
ORDER BY POCount DESC
```

6f. **Most Frequently Ordered Parts (last 12 months)**
```sql
SELECT TOP 25
    p.ItemName,
    pe.ElementName AS Category,
    COUNT(DISTINCT th.ID) AS POCount,
    SUM(vd.TotalPrice) AS TotalSpend,
    MAX(vd.UnitPrice) AS LastUnitPrice,
    p.DisplayUnitText AS Unit,
    i.QuantityAvailable,
    i.QuantityOnHand
FROM VendorTransDetail vd
JOIN CatalogItem ci ON vd.ItemID = ci.ID AND vd.ItemClassTypeID = 12076
JOIN Part p ON ci.PartID = p.ID
JOIN TransHeader th ON vd.TransHeaderID = th.ID
LEFT JOIN Inventory i ON i.PartID = p.ID
    AND i.ClassTypeID = 12200 AND i.IsGroup = 0 AND i.IsDivisionSummary = 0 AND i.WarehouseID = 10
LEFT JOIN PricingElement pe ON p.CategoryID = pe.ID AND pe.ClassTypeID = 12035
WHERE th.TransactionType = 7
    AND p.IsActive = 1 AND p.TrackInventory = 1
GROUP BY p.ItemName, pe.ElementName, p.DisplayUnitText, i.QuantityAvailable, i.QuantityOnHand
ORDER BY POCount DESC
```

**VendorTransDetail Polymorphic Link Reference:**
Document the three ItemClassTypeID values:
| ItemClassTypeID | Meaning | Count | Join Target |
|-----------------|---------|-------|-------------|
| 12076 | CatalogItem | 6,523 | VendorTransDetail.ItemID -> CatalogItem.ID -> CatalogItem.PartID -> Part.ID |
| 12014 | Part (direct) | 84,191 | VendorTransDetail.ItemID -> Part.ID |
| NULL | Freeform | 38,987 | No link (manual line items, skip) |

**PO Status Reference (Type 7):**
| StatusID | Status | Count |
|----------|--------|-------|
| 28 | Closed | 12,338 |
| 29 | Cancelled | 164 |
| 27 | Ordered | 12 |
| 25 | Requested | 1 |
  </action>
  <verify>
1. Section 6 (PURCHASING INTELLIGENCE) has "PRIMARY TIER" label
2. Last price paid queries exist for both paths (CatalogItem 12076 and direct Part 12014)
3. Guidance explains to try CatalogItem path first, then direct Part path
4. PO history query shows last 10 orders for a part
5. Price history/trend query available
6. Top vendors query present
7. Most frequently ordered parts query present with LEFT JOIN to Inventory for stock context
8. VendorTransDetail polymorphic link reference table documents all 3 ItemClassTypeID values
9. PO Status reference table present
10. All PO queries use th.ID DESC for ordering (not SaleDate)
11. All queries use TransactionType = 7
  </verify>
  <done>Purchasing intelligence section complete with 6 query templates covering last price paid (both paths), PO history, price trends, top vendors, and most ordered parts. VendorTransDetail polymorphic reference and PO status reference documented.</done>
</task>

<task type="auto">
  <name>Task 2: Add Material Consumption, Inventory Valuation, and NL Routing</name>
  <files>skills/control-erp-inventory/control-erp-inventory-SKILL.md</files>
  <action>
Append the remaining sections to the skill file.

**Section 7: MATERIAL CONSUMPTION & USAGE (INV-03)**

7a. **Average Monthly Consumption for a Part**
```sql
SELECT
    p.ItemName,
    COUNT(*) AS UsageEvents,
    SUM(puc.Amount) AS TotalConsumed,
    SUM(puc.Amount) / 12.0 AS MonthlyAverage,
    p.DisplayUnitText AS Unit
FROM PartUsageCard puc
JOIN Part p ON puc.PartID = p.ID
WHERE puc.IsVoided = 0
    AND puc.PostDate >= DATEADD(MONTH, -12, GETDATE())
    AND p.ID = @PartID
GROUP BY p.ItemName, p.DisplayUnitText
```
Note: PartUsageCard has 286K non-voided records spanning 2006-2026, covering 1,127 distinct parts. This is the best source for consumption analysis. PartConsumptionJournal is empty at FLS.

7b. **Top Consumed Parts (last 12 months)**
```sql
SELECT TOP 25
    p.ItemName,
    pe.ElementName AS Category,
    SUM(puc.Amount) AS TotalConsumed,
    COUNT(*) AS UsageEvents,
    SUM(puc.Amount) / 12.0 AS MonthlyAverage,
    p.DisplayUnitText AS Unit,
    i.QuantityAvailable,
    i.QuantityOnHand
FROM PartUsageCard puc
JOIN Part p ON puc.PartID = p.ID
LEFT JOIN Inventory i ON i.PartID = p.ID
    AND i.ClassTypeID = 12200 AND i.IsGroup = 0 AND i.IsDivisionSummary = 0 AND i.WarehouseID = 10
LEFT JOIN PricingElement pe ON p.CategoryID = pe.ID AND pe.ClassTypeID = 12035
WHERE puc.IsVoided = 0
    AND p.IsActive = 1
    AND puc.PostDate >= DATEADD(MONTH, -12, GETDATE())
GROUP BY p.ItemName, pe.ElementName, p.DisplayUnitText, i.QuantityAvailable, i.QuantityOnHand
ORDER BY TotalConsumed DESC
```

7c. **Usage History for a Part (recent events)**
```sql
SELECT TOP 20
    puc.PostDate,
    puc.Amount,
    puc.Cost,
    p.DisplayUnitText AS Unit,
    puc.Description,
    th.TransactionNumber AS OrderNumber
FROM PartUsageCard puc
JOIN Part p ON puc.PartID = p.ID
LEFT JOIN TransHeader th ON puc.TransHeaderID = th.ID
WHERE puc.IsVoided = 0
    AND p.ID = @PartID
ORDER BY puc.PostDate DESC
```

7d. **Months of Supply Remaining (consumption-based)**
For parts with consumption history, calculate how long current stock will last:
```sql
SELECT
    p.ItemName,
    i.QuantityAvailable AS CurrentStock,
    p.DisplayUnitText AS Unit,
    SUM(puc.Amount) / 12.0 AS MonthlyConsumption,
    CASE WHEN SUM(puc.Amount) > 0
         THEN i.QuantityAvailable / (SUM(puc.Amount) / 12.0)
         ELSE NULL END AS MonthsOfSupply
FROM Part p
JOIN Inventory i ON i.PartID = p.ID
    AND i.ClassTypeID = 12200 AND i.IsGroup = 0 AND i.IsDivisionSummary = 0 AND i.WarehouseID = 10
JOIN PartUsageCard puc ON puc.PartID = p.ID AND puc.IsVoided = 0
    AND puc.PostDate >= DATEADD(MONTH, -12, GETDATE())
WHERE p.IsActive = 1 AND p.TrackInventory = 1
    AND i.QuantityAvailable > 0
GROUP BY p.ItemName, i.QuantityAvailable, p.DisplayUnitText
HAVING SUM(puc.Amount) > 0
ORDER BY CASE WHEN SUM(puc.Amount) > 0
         THEN i.QuantityAvailable / (SUM(puc.Amount) / 12.0)
         ELSE 9999 END ASC
```
Note: This is a SECONDARY TIER query -- both inventory quantities and consumption records may be incomplete. Caveat results accordingly. Sort by fewest months of supply (most urgent) first.

**Section 8: INVENTORY VALUATION (INV-03)**

8a. **Total Inventory Value (Accounting -- GL-based, RECOMMENDED)**
```sql
SELECT SUM(Amount) AS InventoryBalance
FROM GL
WHERE GLAccountID = 10414
```
Result at FLS: $651,403.34 (as of research date). This matches the balance sheet and is the authoritative inventory valuation.

Add guidance: "When user asks 'what's our inventory worth' or 'inventory value', use this GL query. The GL balance is the single source of truth for inventory valuation. Do NOT sum part-level costs."

8b. **Inventory GL Sub-Account Breakdown**
```sql
SELECT
    ga.ID AS NodeID,
    ga.AccountName,
    SUM(g.Amount) AS Balance
FROM GL g
JOIN GLAccount ga ON g.GLAccountID = ga.ID
WHERE ga.GLClassificationType = 1003
    AND ga.ClassTypeID = 8001  -- leaf accounts only
GROUP BY ga.ID, ga.AccountName
HAVING SUM(g.Amount) <> 0
ORDER BY SUM(g.Amount) DESC
```
Shows breakdown across all inventory-type GL accounts (10414=Inventory, plus product-specific accounts like Banner Supplies, Inks, etc.).

8c. **Part-Level Valuation (operational estimate, use with caveats)**
```sql
SELECT
    p.ItemName,
    i.QuantityBilled,
    i.AverageCost,
    i.QuantityBilled * i.AverageCost AS EstimatedValue,
    p.DisplayUnitText AS Unit,
    CASE WHEN p.AccrueCosts = 1 THEN 'Full Accrual' ELSE 'Level Only' END AS TrackingMode
FROM Part p
JOIN Inventory i ON i.PartID = p.ID
    AND i.ClassTypeID = 12200
    AND i.IsGroup = 0 AND i.IsDivisionSummary = 0
    AND i.WarehouseID = 10
WHERE p.IsActive = 1 AND p.TrackInventory = 1
    AND p.AccrueCosts = 1
    AND i.QuantityBilled <> 0
ORDER BY i.QuantityBilled * i.AverageCost DESC
```
Note: Use QuantityBilled (not QuantityOnHand) for valuation per wiki formula. Only show AccrueCosts=1 parts (these are GL-integrated). This is an operational estimate; the GL total is authoritative.

**Section 9: NATURAL LANGUAGE INTERPRETATION**

Create the complete NL routing table:

| User Says | Route To | Section |
|-----------|----------|---------|
| "check inventory for X" / "what's in stock for X" / "stock level for X" | Stock Level Check | 4a |
| "what's in stock" / "show me inventory" / "inventory overview" | Broad Stock Overview | 4b |
| "parts by category" / "inventory by category" | Parts by Category | 4c |
| "tell me everything about part X" / "part detail for X" | Part Detail Card | 4d |
| "what needs reordering" / "reorder report" / "low stock" | Reorder Alert | 5a |
| "reorder by category" / "reorder summary" | Reorder Summary | 5b |
| "what does X cost" / "how much is X" / "price of X" | Last Price Paid | 6a/6b |
| "PO history for X" / "purchase orders for X" | PO History | 6c |
| "price history for X" / "price trend" | Price History | 6d |
| "top vendors" / "who do we buy from" | Top Vendors | 6e |
| "most ordered parts" / "what do we buy most" | Most Ordered Parts | 6f |
| "how much X do we use" / "consumption for X" / "usage rate" | Monthly Consumption | 7a |
| "top consumed parts" / "most used materials" | Top Consumed Parts | 7b |
| "usage history for X" / "when did we last use X" | Usage History | 7c |
| "how long will X last" / "months of supply" | Months of Supply | 7d |
| "what's our inventory worth" / "inventory value" | GL Inventory Value | 8a |
| "inventory value breakdown" / "inventory by GL account" | GL Sub-Account | 8b |
| "part-level valuation" / "value of each part" | Part-Level Estimate | 8c |
| "warehouse breakdown" / "apparel inventory" | Run default queries with WarehouseID filter adjusted | General |

**Cross-Skill Routing:**
- "AR for vendor X" / "what do we owe vendor" -> Redirect to control-erp-financial (AP queries)
- "revenue from X" / "sales of X" -> Redirect to control-erp-sales or control-erp-customers
- "GL inventory account" / "inventory on balance sheet" -> Can answer with 8a/8b, or redirect to control-erp-financial for full GL context

**Section 10: DATA QUALITY & MIGRATION STATUS**

Add a final section documenting the current state:
- FLS is migrating inventory from Google Sheets to Control (2026)
- Current inventory data quality: 214 records with negative QuantityOnHand, part-level valuation diverges significantly from GL
- Purchasing data (Type 7 POs) is reliable and well-maintained
- Recommendation: Verify stock levels physically for critical decisions; use PO data for cost/vendor questions
- Post-migration: Inventory quantity queries will become primary tier; reorder monitoring will become reliable
  </action>
  <verify>
1. Section 7 (MATERIAL CONSUMPTION) has 4 queries: monthly average, top consumed, usage history, months of supply
2. Months of supply query caveated as SECONDARY TIER
3. PartUsageCard queries use IsVoided = 0 filter
4. Section 8 (INVENTORY VALUATION) has GL-based total ($651K reference), sub-account breakdown, and part-level estimate
5. GL valuation uses GLAccountID = 10414 (not part-level sum)
6. Part-level valuation uses QuantityBilled (not QuantityOnHand) and only AccrueCosts=1 parts
7. Section 9 (NL INTERPRETATION) has routing for ALL query sections (at least 18 trigger patterns)
8. Cross-skill routing documented (AP -> financial, revenue -> sales/customers)
9. Section 10 (DATA QUALITY) documents migration status and data quality warnings
10. No references to QuantityOnHand * AverageCost for total valuation
11. Plan 02 placeholder comment removed (replaced with actual content)
12. File line count tracked for extraction decision
  </verify>
  <done>INV-03 fully covered: purchasing intelligence (6 queries), material consumption (4 queries), inventory valuation (3 queries with GL-first approach). NL routing table maps 18+ trigger phrases to specific query sections. Cross-skill routing documented. Data quality section captures migration status. Skill file complete for all three requirements (INV-01, INV-02, INV-03).</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. skills/control-erp-inventory/control-erp-inventory-SKILL.md is complete with 10 sections
2. Purchasing intelligence marked as PRIMARY TIER with reliable label
3. Last price paid queries cover both CatalogItem (12076) and direct Part (12014) paths
4. VendorTransDetail polymorphic link fully documented with all 3 ItemClassTypeID values
5. Material consumption uses PartUsageCard with IsVoided=0 filter
6. Months of supply calculation properly caveated as secondary tier
7. Inventory valuation defaults to GL NodeID 10414 ($651K), NOT part-level sum
8. Part-level valuation uses QuantityBilled (not QuantityOnHand) for AccrueCosts=1 parts only
9. NL routing table covers all INV-01, INV-02, INV-03 patterns (18+ entries)
10. Cross-skill routing to financial and sales skills documented
11. Data quality section documents migration status
12. All queries consistent with research findings and CONTEXT.md decisions
</verification>

<success_criteria>
- INV-03 fully covered: purchasing intelligence, material consumption, inventory valuation
- Purchasing is PRIMARY TIER (reliable), inventory quantities are SECONDARY TIER (caveated)
- GL-based valuation is the default for "what's our inventory worth" ($651K NodeID 10414)
- NL routing covers all inventory-related natural language patterns with clear section mapping
- Cross-skill boundaries documented (AP -> financial, revenue -> sales)
- Data quality and migration status documented for user awareness
- Complete skill file ready for deployment covering INV-01, INV-02, INV-03
</success_criteria>

<output>
After completion, create `.planning/phases/11-inventory-management/11-02-SUMMARY.md`
</output>
