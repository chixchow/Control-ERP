---
phase: 09-financial-depth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/control-erp-financial/control-erp-financial-SKILL.md
autonomous: true

must_haves:
  truths:
    - "User can ask 'show me AR aging' and get current/30/60/90+ day buckets with customer breakdown"
    - "User can ask 'show me AR for [customer]' and get invoice-level detail for that customer"
    - "User can ask 'AP aging' and get vendor breakdown with aging buckets from DueDate"
    - "User can ask 'payment history for [vendor]' and get dated payment list with method and reference"
    - "AR aging uses SaleDate (not DueDate) and shows WIP/Built orders separately"
    - "AP aging uses DueDate (vendor payment deadline) and shows Current bucket for not-yet-due bills"
  artifacts:
    - path: "skills/control-erp-financial/control-erp-financial-SKILL.md"
      provides: "AR Detail and AP Detail sections with customer/vendor breakdown queries"
      contains: "AR DETAIL WITH CUSTOMER BREAKDOWN"
    - path: "skills/control-erp-financial/control-erp-financial-SKILL.md"
      provides: "AP Detail section with vendor breakdown and payment history"
      contains: "AP DETAIL WITH VENDOR BREAKDOWN"
  key_links:
    - from: "AR Detail query"
      to: "TransHeader + Account + PaymentTerms"
      via: "JOIN on AccountID and PaymentTermsID"
      pattern: "INNER JOIN Account a ON th.AccountID = a.ID"
    - from: "AP Detail query"
      to: "TransHeader + Account (vendor)"
      via: "TransactionType = 8 with DueDate aging"
      pattern: "th.TransactionType = 8"
    - from: "Vendor Payment History query"
      to: "Payment + Journal + TransHeader + Account"
      via: "ClassTypeID 20009 (Bill Payment)"
      pattern: "p.ClassTypeID = 20009"
---

<objective>
Add AR aging detail with customer breakdown and AP aging detail with vendor breakdown to the existing financial skill, covering requirements FIN-04 and FIN-05.

Purpose: Users need to see who owes them money (AR) and who they owe money to (AP) with full customer/vendor breakdowns matching Control's built-in report format -- not just summary buckets.

Output: Extended financial skill with 4 new query templates (AR detail, AR single-customer drill-down, AP detail, vendor payment history) and updated NL routing entries for AR/AP patterns.
</objective>

<execution_context>
@/Users/cain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-financial-depth/09-CONTEXT.md
@.planning/phases/09-financial-depth/09-RESEARCH.md
@skills/control-erp-financial/control-erp-financial-SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AR Detail with Customer Breakdown (FIN-04)</name>
  <files>skills/control-erp-financial/control-erp-financial-SKILL.md</files>
  <action>
Insert a new subsection `### AR Detail with Customer Breakdown` after the existing `### AR by Payment Terms` section (after line ~575) and before the `---` separator preceding the AP section.

Add the following content:

1. **AR Detail with Customer Breakdown query** -- SELECT from TransHeader JOIN Account JOIN PaymentTerms with aging bucket columns (Current_0_30, Days_31_60, Days_61_90, Days_Over_90). Use SaleDate for aging (NEVER DueDate). Show WIP/Built flag for orders where SaleDate IS NULL. Include HasCreditAccount indicator. ORDER BY CompanyName, SaleDate. Use the exact SQL from the research file (09-RESEARCH.md, lines 183-212).

2. **Single Customer AR Drill-Down query** -- When user asks "show me AR for [customer name]", query with LIKE filter on CompanyName. Show invoice-level detail: OrderNumber, InvoiceNumber, SaleDate, Description, InvoiceTotal, PaymentTotal, BalanceDue, DaysOutstanding, StatusText, FinanceChargeAmount. Use the exact SQL from the research file (lines 216-239).

3. **AR Summary by Customer query** -- A grouped version showing each customer's total AR and aging bucket totals (summary row per customer, not per invoice). This fills the gap between the bucket summary and the full detail:
```sql
SELECT
    a.CompanyName,
    CASE WHEN a.HasCreditAccount = 1 THEN '*' ELSE '' END AS CreditAcct,
    COUNT(*) AS OpenInvoices,
    SUM(th.BalanceDue) AS TotalAR,
    SUM(CASE WHEN th.SaleDate IS NULL THEN th.BalanceDue ELSE 0 END) AS WIPBuilt,
    SUM(CASE WHEN th.SaleDate IS NOT NULL AND DATEDIFF(DAY, th.SaleDate, GETDATE()) <= 30 THEN th.BalanceDue ELSE 0 END) AS Current_0_30,
    SUM(CASE WHEN DATEDIFF(DAY, th.SaleDate, GETDATE()) BETWEEN 31 AND 60 THEN th.BalanceDue ELSE 0 END) AS Days_31_60,
    SUM(CASE WHEN DATEDIFF(DAY, th.SaleDate, GETDATE()) BETWEEN 61 AND 90 THEN th.BalanceDue ELSE 0 END) AS Days_61_90,
    SUM(CASE WHEN DATEDIFF(DAY, th.SaleDate, GETDATE()) > 90 THEN th.BalanceDue ELSE 0 END) AS Days_Over_90
FROM TransHeader th
INNER JOIN Account a ON th.AccountID = a.ID
WHERE th.TransactionType = 1 AND th.IsActive = 1 AND th.BalanceDue > 0 AND th.StatusID != 9
GROUP BY a.CompanyName, a.HasCreditAccount
ORDER BY TotalAR DESC
```

4. Add a brief note explaining that the AR Detail matches Control's A_R Detail report format: customer breakdown with aging columns, WIP/Built orders shown separately, charge account customers marked with asterisk.

5. Update the NL interpretation table (## NATURAL LANGUAGE INTERPRETATION section) to add these new routing entries:
  - "AR detail" / "AR by customer" / "who owes us" -> AR Detail with Customer Breakdown
  - "AR for [customer]" / "what does [customer] owe" -> Single Customer AR Drill-Down
  - "AR summary by customer" -> AR Summary by Customer

CRITICAL: All AR aging must use SaleDate, never DueDate. WIP/Built orders (SaleDate IS NULL) go in a separate bucket, not in the aging columns.
  </action>
  <verify>
Read the modified file. Confirm:
1. New section "AR Detail with Customer Breakdown" exists after AR by Payment Terms
2. Three AR query templates present (detail, drill-down, summary by customer)
3. All AR queries use SaleDate for aging, never DueDate
4. WIP/Built orders handled with IS NULL check on SaleDate
5. NL interpretation table has new AR routing entries
6. No existing content was deleted or broken
  </verify>
  <done>AR detail with customer breakdown, single-customer drill-down, and customer summary queries are in the skill file. AR aging correctly uses SaleDate. NL table routes "AR detail", "AR by customer", "who owes us", and "AR for [customer]" to the correct queries.</done>
</task>

<task type="auto">
  <name>Task 2: Add AP Detail with Vendor Breakdown and Payment History (FIN-05)</name>
  <files>skills/control-erp-financial/control-erp-financial-SKILL.md</files>
  <action>
Insert a new subsection `### AP Detail with Vendor Breakdown` after the existing `### AP Context` section (after line ~653) and before the `---` separator preceding the P&L section.

Add the following content:

1. **AP Detail with Vendor Breakdown query** -- SELECT from TransHeader (TransactionType=8) JOIN Account JOIN PaymentTerms (VendorPaymentTermsID). Use DueDate for AP aging (this IS correct for AP -- DueDate on Type 8 = vendor payment deadline). Show aging buckets: Current (not yet due, DATEDIFF <= 0), Days_1_30, Days_31_60, Days_61_90, Days_Over_90. Include BillNumber, DueDate, Description, BillAmount, BalanceDue. Use the exact SQL from the research file (09-RESEARCH.md, lines 241-273).

2. **AP Summary by Vendor query** -- Grouped version showing each vendor's total AP and aging bucket totals:
```sql
SELECT
    a.CompanyName AS Vendor,
    COUNT(*) AS OpenBills,
    SUM(th.BalanceDue) AS TotalAP,
    SUM(CASE WHEN DATEDIFF(DAY, th.DueDate, GETDATE()) <= 0 THEN th.BalanceDue ELSE 0 END) AS Current,
    SUM(CASE WHEN DATEDIFF(DAY, th.DueDate, GETDATE()) BETWEEN 1 AND 30 THEN th.BalanceDue ELSE 0 END) AS Days_1_30,
    SUM(CASE WHEN DATEDIFF(DAY, th.DueDate, GETDATE()) BETWEEN 31 AND 60 THEN th.BalanceDue ELSE 0 END) AS Days_31_60,
    SUM(CASE WHEN DATEDIFF(DAY, th.DueDate, GETDATE()) BETWEEN 61 AND 90 THEN th.BalanceDue ELSE 0 END) AS Days_61_90,
    SUM(CASE WHEN DATEDIFF(DAY, th.DueDate, GETDATE()) > 90 THEN th.BalanceDue ELSE 0 END) AS Days_Over_90
FROM TransHeader th
INNER JOIN Account a ON th.AccountID = a.ID
WHERE th.TransactionType = 8 AND th.IsActive = 1 AND th.BalanceDue > 0 AND th.StatusID != 9
GROUP BY a.CompanyName
ORDER BY TotalAP DESC
```

3. **Vendor Payment History query** -- When user asks "payment history for [vendor]", query Payment JOIN Journal JOIN TransHeader JOIN Account where Payment.ClassTypeID = 20009 (Bill Payment). Show PaymentDate, BillNumber, Description, PaymentAmount, PaymentMethod (decoded TenderType), Reference (DisplayNumber). Use the exact SQL from the research file (lines 278-303).

4. Add a note clarifying the key difference: AP ages from DueDate (vendor payment deadline) while AR ages from SaleDate (invoice date). This is the most important distinction in AR vs AP aging.

5. Add a note about vendor credits: `Account.VendorCreditBalance` tracks outstanding vendor credits. When a vendor issues a credit, it reduces the effective AP balance.

6. Update the NL interpretation table to add AP routing entries:
  - "AP detail" / "AP by vendor" / "what do we owe" -> AP Detail with Vendor Breakdown
  - "vendor payment history" / "payments to [vendor]" -> Vendor Payment History
  - "AP for [vendor]" / "bills for [vendor]" -> AP Detail filtered by vendor (LIKE on CompanyName)

CRITICAL: AP aging uses DueDate (correct for Type 8 bills). This is the OPPOSITE of AR which uses SaleDate. Document this difference prominently.
  </action>
  <verify>
Read the modified file. Confirm:
1. New section "AP Detail with Vendor Breakdown" exists after AP Context
2. Three AP query templates present (detail, summary by vendor, payment history)
3. All AP queries use DueDate for aging (correct for Type 8 bills)
4. AP aging note clearly distinguishes DueDate (AP) vs SaleDate (AR)
5. Vendor payment history uses ClassTypeID 20009
6. NL interpretation table has new AP routing entries
7. No existing content was deleted or broken
  </verify>
  <done>AP detail with vendor breakdown, vendor summary, and vendor payment history queries are in the skill file. AP aging correctly uses DueDate. NL table routes "AP detail", "AP by vendor", "what do we owe", and "vendor payment history" to the correct queries. The AR/AP date field difference is clearly documented.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. The skill file has new AR Detail and AP Detail subsections with full customer/vendor breakdown queries
2. AR aging uses SaleDate exclusively; AP aging uses DueDate exclusively
3. WIP/Built orders are shown separately in AR (not mixed into aging buckets)
4. NL interpretation table routes all new query patterns correctly
5. No existing queries or content were modified or removed
6. File line count is tracked (needed for Plan 02 to assess extraction threshold)
</verification>

<success_criteria>
- FIN-04 covered: AR aging with customer breakdown, single-customer drill-down, customer summary -- all using SaleDate
- FIN-05 covered: AP aging with vendor breakdown, vendor summary, vendor payment history -- all using DueDate
- NL routing extended for both AR and AP detail patterns
- Existing skill content preserved intact
- All SQL follows validated patterns from research (GL view, correct sign conventions, correct date fields)
</success_criteria>

<output>
After completion, create `.planning/phases/09-financial-depth/09-01-SUMMARY.md`
</output>
