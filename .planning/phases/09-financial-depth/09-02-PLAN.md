---
phase: 09-financial-depth
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - skills/control-erp-financial/control-erp-financial-SKILL.md
  - skills/control-erp-financial/references/financial-analysis.md
autonomous: true

must_haves:
  truths:
    - "User can ask for P&L and get traditional format with Revenue, COGS, Gross Margin, OpEx, Net Income"
    - "User can ask for P&L by product line and get revenue breakdown by product category with aggregate COGS"
    - "User can ask for year-over-year P&L comparison and get current vs prior period with delta columns"
    - "User can ask 'what's our bank balance' and get current cash position with individual account balances"
    - "User can ask 'show me cash flow' and get categorized cash in/out (customer receipts, vendor payments, payroll)"
    - "All P&L queries default to year-to-date when no date range specified"
    - "COGS-to-product limitation is documented (revenue is per-product, COGS is aggregate at GL level)"
  artifacts:
    - path: "skills/control-erp-financial/control-erp-financial-SKILL.md"
      provides: "P&L Analysis and Cash Flow sections OR routing to references/ if >1,200 lines"
      contains: "NATURAL LANGUAGE INTERPRETATION"
    - path: "skills/control-erp-financial/references/financial-analysis.md"
      provides: "Overflow content if main file exceeds 1,200 lines (conditional)"
  key_links:
    - from: "P&L comparison query"
      to: "GL + GLAccount"
      via: "GLClassificationType for category, YEAR() for comparison"
      pattern: "ga.GLClassificationType IN \\(4000, 4001, 5001, 5002\\)"
    - from: "Bank balance query"
      to: "GL + GLAccount"
      via: "GLClassificationType = 1000 (Cash/Bank)"
      pattern: "ga.GLClassificationType = 1000"
    - from: "Cash flow query"
      to: "GL + Journal.ClassTypeID"
      via: "Bank account entries categorized by activity type"
      pattern: "l.GLAccountID IN \\(90, 10412\\)"
---

<objective>
Add P&L analysis with comparison periods and product-line breakdown, plus cash flow and bank balance queries to the financial skill, covering requirements FIN-06 and FIN-07. Handle line count threshold -- if total exceeds 1,200 lines, extract new analytical content to references/financial-analysis.md.

Purpose: Users need P&L comparisons (month-over-month, year-over-year), product-line margin analysis, current bank balances, and categorized cash flow -- the analytical depth for day-to-day financial management.

Output: Extended financial skill with P&L comparison, product-line margin, bank balance, and cash flow queries. Updated NL routing. Potential extraction to references/ if line threshold exceeded.
</objective>

<execution_context>
@/Users/cain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-financial-depth/09-CONTEXT.md
@.planning/phases/09-financial-depth/09-RESEARCH.md
@.planning/phases/09-financial-depth/09-01-SUMMARY.md
@skills/control-erp-financial/control-erp-financial-SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add P&L Analysis with Comparison Periods (FIN-06)</name>
  <files>skills/control-erp-financial/control-erp-financial-SKILL.md</files>
  <action>
Insert a new subsection `### P&L Analysis` after the existing `### P&L Summary` section (after the P&L Summary query block, before the Balance Sheet Key Accounts section).

Add the following content:

1. **P&L with Period Comparison (Year-over-Year)** -- Use the exact SQL from the research file (09-RESEARCH.md, lines 337-361). Shows CurrentYear vs PriorYear columns for each GL category. Default to year-to-date using `DATEADD(yy, DATEDIFF(yy, 0, GETDATE()), 0)` as start date. Include a note that the prior year comparison uses the same day-of-year cutoff for apples-to-apples comparison.

2. **P&L with Month-over-Month Comparison** -- Similar structure but comparing current month vs prior month:
```sql
DECLARE @CurrentMonthStart DATETIME = DATEADD(mm, DATEDIFF(mm, 0, GETDATE()), 0);
DECLARE @PriorMonthStart DATETIME = DATEADD(mm, -1, @CurrentMonthStart);
DECLARE @PriorMonthEnd DATETIME = DATEADD(dd, -1, @CurrentMonthStart);

SELECT
    CASE ga.GLClassificationType
        WHEN 4000 THEN '1-Product Revenue'
        WHEN 4001 THEN '2-Other Income'
        WHEN 5001 THEN '3-Cost of Goods Sold'
        WHEN 5002 THEN '4-Operating Expenses'
    END AS Category,
    ga.AccountName,
    SUM(CASE WHEN l.EntryDateTime >= @CurrentMonthStart
        THEN CASE WHEN ga.GLClassificationType IN (4000, 4001) THEN -l.Amount ELSE l.Amount END
        ELSE 0 END) AS CurrentMonth,
    SUM(CASE WHEN l.EntryDateTime BETWEEN @PriorMonthStart AND @PriorMonthEnd
        THEN CASE WHEN ga.GLClassificationType IN (4000, 4001) THEN -l.Amount ELSE l.Amount END
        ELSE 0 END) AS PriorMonth
FROM GL l
INNER JOIN GLAccount ga ON l.GLAccountID = ga.ID
WHERE ga.GLClassificationType IN (4000, 4001, 5001, 5002)
    AND l.EntryDateTime >= @PriorMonthStart
GROUP BY ga.GLClassificationType, ga.AccountName
HAVING SUM(l.Amount) != 0
ORDER BY Category
```

3. **Product-Line Margin Analysis** -- Revenue by product line with aggregate COGS and calculated gross margin:
```sql
-- Revenue breakdown by product line with aggregate COGS
-- NOTE: COGS is aggregate (not per-product) at GL level. Per-product COGS requires TransDetail analysis.
SELECT
    ga.AccountName AS ProductLine,
    SUM(-l.Amount) AS Revenue
FROM GL l
INNER JOIN GLAccount ga ON l.GLAccountID = ga.ID
WHERE ga.GLClassificationType = 4000
    AND l.EntryDateTime BETWEEN @StartDate AND @EndDate
GROUP BY ga.AccountName
ORDER BY Revenue DESC;

-- Separate query for total COGS (cannot be broken by product at GL level)
SELECT
    SUM(l.Amount) AS TotalCOGS
FROM GL l
INNER JOIN GLAccount ga ON l.GLAccountID = ga.ID
WHERE ga.GLClassificationType = 5001
    AND l.EntryDateTime BETWEEN @StartDate AND @EndDate;
```

4. **COGS Limitation Note** -- Add a prominent callout:
> **COGS-to-product mapping:** Revenue GL accounts have per-product NodeIDs (e.g., 10116=DyeSub, 10120=Table Covers), but COGS accounts (GLClassificationType 5001) are aggregate. Product-line P&L shows revenue breakdown by product with total COGS. Per-product margin requires TransDetail-level cost analysis (different approach, not GL-based).

5. **P&L Formatting Guidance** -- Add a note on output formatting per context decisions:
  - Default date range: year-to-date
  - Currency: $1,234.56 format with comma separators
  - Negative numbers: accounting parentheses ($1,234.56)
  - Show computed rows: Gross Margin (Revenue - COGS), Net Income (Revenue - COGS - OpEx)
  - Full list, no truncation

6. Update the NL interpretation table with P&L routing entries:
  - "P&L comparison" / "P&L vs last year" / "year over year P&L" -> P&L with Period Comparison (YoY)
  - "P&L this month vs last month" / "monthly P&L comparison" -> P&L with MoM Comparison
  - "P&L by product line" / "margin by product" / "product profitability" -> Product-Line Margin Analysis
  - "gross margin by product" -> Product-Line Margin + COGS limitation note

CRITICAL: Revenue uses SUM(-Amount) for GLClassificationType IN (4000, 4001). COGS and OpEx use SUM(Amount). Default period is YTD. Never mix sign conventions.
  </action>
  <verify>
Read the modified file. Confirm:
1. New section "P&L Analysis" exists after P&L Summary
2. Three P&L query templates present (YoY comparison, MoM comparison, product-line margin)
3. All queries use correct sign conventions (SUM(-Amount) for revenue, SUM(Amount) for COGS/OpEx)
4. COGS limitation note is prominently documented
5. Default date range is YTD
6. NL interpretation table has new P&L routing entries
7. No existing content was deleted or broken
  </verify>
  <done>P&L comparison (YoY and MoM), product-line margin analysis, and COGS limitation are in the skill file. All queries use correct sign conventions and default to YTD. NL table routes P&L comparison, product profitability, and margin queries correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Add Cash Flow and Bank Balance Queries (FIN-07)</name>
  <files>skills/control-erp-financial/control-erp-financial-SKILL.md</files>
  <action>
Insert a new section `## CASH FLOW AND BANK BALANCES` after the `## ALL-TIME REVENUE CONTEXT` section (after line ~757) and before the `## NATURAL LANGUAGE INTERPRETATION` section.

Add the following content:

1. **Bank Balance (Current Cash Position)** -- Query GL for cumulative balance on bank accounts. NO date filter for "current" balance (cumulative all-time). Exclude ZoomTex legacy accounts (10522-10525). Use the exact SQL from the research file (09-RESEARCH.md, lines 363-378). Add a total row at the bottom summing all bank accounts.

2. **Undeposited Funds** -- Show funds in transit (not yet deposited to bank):
```sql
-- Undeposited funds by account (in transit, not yet in bank)
SELECT
    ga.AccountName,
    SUM(l.Amount) AS Balance
FROM GL l
INNER JOIN GLAccount ga ON l.GLAccountID = ga.ID
WHERE ga.GLClassificationType = 1007  -- Undeposited Funds
    AND ga.IsActive = 1
    AND ga.ID NOT IN (10522, 10523, 10524, 10525)  -- Exclude ZoomTex
GROUP BY ga.AccountName, ga.ID
HAVING SUM(l.Amount) != 0
ORDER BY ga.ID
```

3. **Cash Flow Summary (YTD)** -- Categorized cash in/out for a date range. Use the approach from research (lines 384-407) but refine the categorization to use Journal.ClassTypeID for better accuracy:
```sql
DECLARE @StartDate DATETIME = DATEADD(yy, DATEDIFF(yy, 0, GETDATE()), 0);
DECLARE @EndDate DATETIME = GETDATE();

-- Cash flow: entries hitting bank accounts (GLClassificationType = 1000)
-- Categorized by associated activity type
SELECT
    CASE
        WHEN l.DepositJournalID IS NOT NULL AND l.Amount > 0 THEN 'Customer Deposits'
        WHEN j.ClassTypeID = 20009 THEN 'Vendor Payments'
        WHEN l.PayrollID IS NOT NULL THEN 'Payroll'
        WHEN l.EntryType = 1 THEN 'Manual/Adjustments'
        WHEN l.Amount > 0 THEN 'Other Inflows'
        ELSE 'Other Outflows'
    END AS CashCategory,
    SUM(l.Amount) AS NetAmount,
    COUNT(*) AS Entries
FROM GL l
LEFT JOIN Journal j ON l.JournalID = j.ID
WHERE l.GLAccountID IN (90, 10412)  -- Bank accounts only
    AND l.EntryDateTime BETWEEN @StartDate AND @EndDate
GROUP BY
    CASE
        WHEN l.DepositJournalID IS NOT NULL AND l.Amount > 0 THEN 'Customer Deposits'
        WHEN j.ClassTypeID = 20009 THEN 'Vendor Payments'
        WHEN l.PayrollID IS NOT NULL THEN 'Payroll'
        WHEN l.EntryType = 1 THEN 'Manual/Adjustments'
        WHEN l.Amount > 0 THEN 'Other Inflows'
        ELSE 'Other Outflows'
    END
ORDER BY NetAmount DESC
```

4. **Monthly Cash Flow Time Series** -- When user asks for cash flow over multiple months:
```sql
SELECT
    YEAR(l.EntryDateTime) AS Yr,
    MONTH(l.EntryDateTime) AS Mo,
    SUM(CASE WHEN l.Amount > 0 THEN l.Amount ELSE 0 END) AS CashIn,
    SUM(CASE WHEN l.Amount < 0 THEN l.Amount ELSE 0 END) AS CashOut,
    SUM(l.Amount) AS NetCashFlow
FROM GL l
WHERE l.GLAccountID IN (90, 10412)  -- Bank accounts
    AND l.EntryDateTime BETWEEN @StartDate AND @EndDate
GROUP BY YEAR(l.EntryDateTime), MONTH(l.EntryDateTime)
ORDER BY Yr, Mo
```

5. **Cash Flow Notes:**
  - Bank balance = cumulative (no date filter). Cash flow = period activity (with date filter). Different queries for different purposes.
  - Cash flow tracks only bank account movements (GLClassificationType = 1000) to avoid double-counting the undeposited -> bank two-step process.
  - Categorization covers ~90% of entries. "Other" bucket captures miscellaneous GL entries (bank fees, loan payments, etc.)
  - Default period: year-to-date (consistent with P&L)
  - Payment forecast is deferred to analytics milestone. This skill provides historical cash flow only.

6. Update the NL interpretation table with cash flow routing entries:
  - "bank balance" / "cash position" / "how much cash do we have" -> Bank Balance query (replaces existing "Cash position" entry with more specific routing)
  - "undeposited funds" / "funds in transit" -> Undeposited Funds query
  - "cash flow" / "cash in and out" / "where does our money go" -> Cash Flow Summary
  - "monthly cash flow" / "cash flow trend" -> Monthly Cash Flow Time Series

CRITICAL: Bank balance uses NO date filter (cumulative). Cash flow uses date range (period activity). Never confuse these. Exclude ZoomTex legacy accounts (10522-10525) from both.
  </action>
  <verify>
Read the modified file. Confirm:
1. New section "CASH FLOW AND BANK BALANCES" exists after ALL-TIME REVENUE CONTEXT
2. Four query templates present (bank balance, undeposited funds, cash flow summary, monthly time series)
3. Bank balance query has NO date filter (cumulative)
4. Cash flow queries use date range with YTD default
5. ZoomTex accounts excluded from all queries
6. Cash flow notes document double-counting avoidance and categorization coverage
7. NL interpretation table has new cash flow routing entries
8. No existing content was deleted or broken
  </verify>
  <done>Bank balance, undeposited funds, cash flow summary, and monthly cash flow time series queries are in the skill file. Bank balance is cumulative (no date filter). Cash flow is period-based with YTD default. ZoomTex excluded. NL table routes "bank balance", "cash flow", "cash in and out" queries correctly.</done>
</task>

<task type="auto">
  <name>Task 3: Check Line Count and Extract to References if Needed</name>
  <files>
    skills/control-erp-financial/control-erp-financial-SKILL.md
    skills/control-erp-financial/references/financial-analysis.md
  </files>
  <action>
After Tasks 1 and 2 are complete, count the total lines in the skill file using `wc -l`.

**If total <= 1,200 lines:** No extraction needed. Add a comment at the top of the file updating the validation line: change the final line's context note to include the new content areas. Done.

**If total > 1,200 lines:** Extract the NEW analytical sections to a references file:

1. Create directory `skills/control-erp-financial/references/` if it doesn't exist.

2. Create `skills/control-erp-financial/references/financial-analysis.md` containing:
   - All content from "### AR Detail with Customer Breakdown" (the new AR detail queries)
   - All content from "### AP Detail with Vendor Breakdown" (the new AP detail queries)
   - All content from "### P&L Analysis" (the new P&L comparison queries)
   - All content from "## CASH FLOW AND BANK BALANCES" (all new cash flow queries)

3. Replace the extracted content in the main SKILL.md with brief summaries that reference the file:
```markdown
### AR Detail with Customer Breakdown
See `references/financial-analysis.md` for full AR detail queries with customer breakdown, single-customer drill-down, and customer summary. Key patterns: SaleDate for aging, WIP/Built separate bucket, HasCreditAccount indicator.

### AP Detail with Vendor Breakdown
See `references/financial-analysis.md` for full AP detail queries with vendor breakdown, vendor summary, and payment history. Key patterns: DueDate for aging (opposite of AR), ClassTypeID 20009 for bill payments.

### P&L Analysis
See `references/financial-analysis.md` for P&L comparison queries (YoY, MoM) and product-line margin analysis. Key patterns: SUM(-Amount) for revenue, YTD default, COGS is aggregate (not per-product).

## CASH FLOW AND BANK BALANCES
See `references/financial-analysis.md` for bank balance, undeposited funds, cash flow summary, and monthly time series queries. Key patterns: bank balance is cumulative (no date filter), cash flow is period-based, exclude ZoomTex.
```

4. Keep the NL interpretation table entries in the main SKILL.md (routing stays in main file, detail goes to reference).

5. Update the final validation line at the bottom of the skill file to reflect the new content areas and current date.

The extraction threshold (1,200 lines) is a project decision from STATE.md. This ensures the main skill file stays within Claude's optimal context consumption range.
  </action>
  <verify>
Run `wc -l` on the skill file.
If <= 1,200: Confirm file is complete with all new content inline.
If > 1,200: Confirm references/financial-analysis.md exists with full query content, and main SKILL.md has brief summaries with routing to references file. Confirm NL interpretation table is still in main file.
  </verify>
  <done>Skill file is at a manageable size. If >1,200 lines, analytical content is extracted to references/financial-analysis.md with summaries in the main file. NL routing remains in the main file regardless of extraction.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. FIN-06: P&L comparison (YoY, MoM) and product-line margin queries are available
2. FIN-07: Bank balance, undeposited funds, cash flow summary, and monthly time series queries are available
3. All queries use correct sign conventions (SUM(-Amount) for revenue)
4. Default period is YTD for all period-based queries
5. Bank balance is cumulative (no date filter) -- distinct from period cash flow
6. COGS limitation is documented (aggregate, not per-product at GL level)
7. NL interpretation table is complete with all new routing entries
8. Skill file is within manageable size (inline or extracted to references/)
9. No existing skill content was modified or removed
</verification>

<success_criteria>
- FIN-06 covered: P&L comparison (YoY, MoM), product-line margin, COGS limitation documented
- FIN-07 covered: Bank balance, undeposited funds, cash flow summary, monthly time series
- All queries follow validated GL patterns with correct sign conventions
- File size managed (inline if <= 1,200 lines, extracted if > 1,200)
- NL routing complete for all new query patterns
- Phase 9 requirements (FIN-04 through FIN-07) are fully covered across Plans 01 and 02
</success_criteria>

<output>
After completion, create `.planning/phases/09-financial-depth/09-02-SUMMARY.md`
</output>
