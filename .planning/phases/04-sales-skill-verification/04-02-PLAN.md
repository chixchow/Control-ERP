---
phase: 04-sales-skill-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/04-sales-skill-verification/04-VERIFICATION.md
  - skills/control-erp-sales/control-erp-sales-SKILL.md
autonomous: true

must_haves:
  truths:
    - "SALES-04: Product category revenue breakdown validated -- DyeSub Print total matches $1,793,445 and reconciliation total matches ~$3,047K detail-level"
    - "SALES-05: Top customer list validated -- FLASH Visual Media is #1 at ~$430K, top 10 combined ~$1.5M"
    - "SALES-06: Monthly trend produces 12 rows summing to ~$3,052,949; annual total = $3,052,952.52; YoY shows 2024 and 2025"
    - "Internal consistency confirmed: monthly sums = annual, categories sum to DyeSub total, all groups sum to detail total"
  artifacts:
    - path: ".planning/phases/04-sales-skill-verification/04-VERIFICATION.md"
      provides: "Formal verification report for SALES-04, -05, -06 with query results and expected vs actual"
      contains: "SALES-04.*PASS"
  key_links:
    - from: ".planning/phases/04-sales-skill-verification/04-VERIFICATION.md"
      to: "output/phase2-test-results.md"
      via: "Cross-references validated results against prior test run"
      pattern: "phase2-test-results"
    - from: "skills/control-erp-sales/control-erp-sales-SKILL.md"
      to: "TransHeader JOIN TransDetail JOIN TransDetailParam"
      via: "Query templates that are validated by this plan"
      pattern: "TransDetailParam"
---

<objective>
Validate all 9 query templates in the sales skill against known expected values, covering SALES-04 (product revenue), SALES-05 (customer revenue), and SALES-06 (sales trends). Cross-reference results with the existing phase2-test-results.md (21/21 PASS) and verify internal consistency across queries.

Purpose: The queries were validated in the same session that built them. This plan independently verifies the expected values are correctly documented and the queries are internally consistent. If MCP is available, run queries live. If not, verify against documented results and mark for future live validation.

Output: Completed 04-VERIFICATION.md with all 6 SALES requirements verified. Updated skill file if any query issues found.
</objective>

<execution_context>
@/Users/cain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-sales-skill-verification/04-RESEARCH.md
@skills/control-erp-sales/control-erp-sales-SKILL.md
@skills/control-erp-core/control-erp-core-SKILL.md
@output/phase2-test-results.md
@phase2-test-suite.md
@validation/control-erp-validation-results.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Validate product revenue queries (SALES-04)</name>
  <files>.planning/phases/04-sales-skill-verification/04-VERIFICATION.md</files>
  <action>
**Attempt MCP validation first.** Try to run Template 3 (DyeSub category revenue) using the MSSQL MCP tools. If MCP is available, execute all queries live. If MCP returns an error or is unavailable, fall back to cross-referencing documented results.

**If MCP IS available (preferred path):**

Run these three queries and document results:

1. **Template 3 -- DyeSub Print Category Revenue (2025):**
```sql
SELECT tdp.ValueAsStr25 AS ProductCategory,
    COUNT(DISTINCT th.ID) AS OrderCount,
    COUNT(DISTINCT td.ID) AS LineItemCount,
    SUM(td.SubTotalPrice) AS Revenue
FROM TransHeader th
INNER JOIN TransDetail td ON th.ID = td.TransHeaderID AND td.IsActive = 1
INNER JOIN TransDetailParam tdp ON tdp.ParentID = td.ID AND tdp.VariableID = 11053
WHERE th.TransactionType = 1 AND th.IsActive = 1 AND YEAR(th.SaleDate) = 2025
GROUP BY tdp.ValueAsStr25
ORDER BY Revenue DESC
```
Expected: 21 categories, total = $1,793,445. Top 3: Swing Flags ~$615K, Feather Flags ~$486K, Banners ~$259K.
**CRITICAL:** Verify query does NOT have IsActive or ParentClassTypeID filter on TransDetailParam JOIN.

2. **Template 8 -- Full Revenue Reconciliation (2025):**
Run the full CASE statement query from the skill file.
Expected: Detail-level total ~$3,047,058. DyeSub Print = $1,793,445 (58.7%), DyeLux = $479,184, Other = $256,563.
Check: Sum all product groups. Confirm header-detail gap ~$5,895.

3. **Template 1 -- Annual Revenue (2025):**
```sql
SELECT YEAR(SaleDate) AS SaleYear, SUM(SubTotalPrice) AS Revenue, COUNT(*) AS OrderCount
FROM TransHeader
WHERE TransactionType = 1 AND IsActive = 1 AND SaleDate IS NOT NULL
GROUP BY YEAR(SaleDate) ORDER BY SaleYear DESC
```
Expected: 2025 = $3,052,952.52, 4,172 orders.

**If MCP is NOT available (fallback path):**

Cross-reference the existing test results:
1. Read `output/phase2-test-results.md` -- Test 2.1 (DyeSub categories), Test 2.3 (full reconciliation), Test 1.1 (annual revenue)
2. For each, verify the documented result matches the expected value
3. Verify the query templates in the skill file match the queries that produced these results (compare line by line)
4. Confirm no IsActive/ParentClassTypeID filters are present in skill Templates 3 and 8
5. Mark as "PASS (verified against documented results; live re-validation recommended)"

**Internal consistency checks (regardless of MCP):**
- DyeSub category revenues (from Test 2.1) should sum to $1,793,445
- All product groups (from Test 2.3) should sum to ~$3,047,058
- Header-detail gap should be ~$5,895 ($3,052,953 - $3,047,058)

Write SALES-04 section in 04-VERIFICATION.md with:
- Requirement text
- Queries run (or cross-referenced)
- Expected vs actual for each query
- Internal consistency check results
- Status: PASS or FAIL
  </action>
  <verify>
Read 04-VERIFICATION.md and confirm:
- SALES-04 section exists with status line
- DyeSub total documented as $1,793,445 (within $100 of expected)
- Reconciliation total documented as ~$3,047K (within 1%)
- Internal consistency checks documented
- If MCP was used, actual query results match expected within tolerance
  </verify>
  <done>SALES-04 has PASS/FAIL status in 04-VERIFICATION.md with product revenue validation results, including DyeSub category breakdown, full reconciliation, and internal consistency verification.</done>
</task>

<task type="auto">
  <name>Task 2: Validate customer and trend queries (SALES-05, SALES-06) and compile final verification</name>
  <files>.planning/phases/04-sales-skill-verification/04-VERIFICATION.md, skills/control-erp-sales/control-erp-sales-SKILL.md</files>
  <action>
**SALES-05: Customer Revenue Validation**

**If MCP IS available:**
1. Run Template 6 (Top 10 Customers):
```sql
SELECT TOP 10 a.CompanyName, a.AccountNumber, COUNT(DISTINCT th.ID) AS OrderCount,
    SUM(th.SubTotalPrice) AS Revenue, MAX(th.SaleDate) AS LastSaleDate
FROM TransHeader th
INNER JOIN Account a ON th.AccountID = a.ID
WHERE th.TransactionType = 1 AND th.IsActive = 1 AND th.SaleDate IS NOT NULL AND YEAR(th.SaleDate) = 2025
GROUP BY a.CompanyName, a.AccountNumber
ORDER BY Revenue DESC
```
Expected: FLASH Visual Media #1 at ~$430K, Propvinyls #2 at ~$320K, PAC BannerWorks #3 at ~$218K. Top 10 combined ~$1,506K (49.3%).

2. Run Template 5 for a specific customer (PAC BannerWorks):
```sql
SELECT a.CompanyName, td.Description, COUNT(DISTINCT th.ID) AS OrderCount, SUM(td.SubTotalPrice) AS Revenue
FROM TransHeader th
INNER JOIN Account a ON th.AccountID = a.ID
INNER JOIN TransDetail td ON th.ID = td.TransHeaderID AND td.IsActive = 1
WHERE th.TransactionType = 1 AND th.IsActive = 1 AND YEAR(th.SaleDate) = 2025
    AND a.CompanyName LIKE '%PAC%Banner%'
GROUP BY a.CompanyName, td.Description ORDER BY Revenue DESC
```
Expected: Multiple product lines, top item = Double Sided Medium Feather Flag (~$112K).

**If MCP is NOT available:**
Cross-reference Test 3.1 (Top 10 customers) and Test 3.2 (PAC BannerWorks) from `output/phase2-test-results.md`. Verify the skill's Template 6 query matches what produced those results.

**SALES-06: Sales Trend Validation**

**If MCP IS available:**
1. Run Template 2 (Monthly Revenue 2025):
Expected: 12 rows. Sum = $3,052,949. Peak = Sep ($455,748), Trough = Nov ($108,504).

2. Run Template 9 (Year-over-Year):
Expected: 2024 = ~$3,060K (4,302 orders), 2025 = ~$3,053K (4,172 orders).

3. Internal consistency: Monthly sum should equal annual total within $4 (the $3.50 voided-with-SaleDate edge case accounts for the difference between $3,052,949 monthly sum and $3,052,953 annual).

**If MCP is NOT available:**
Cross-reference Tests 1.2 (monthly), 1.4 (YoY) from test results. Verify internal consistency: sum the 12 monthly values from the documented results and confirm they match the annual total.

**Consistency checks:**
- Monthly sum ($3,052,949) vs annual ($3,052,952.52) -- difference should be < $5
- Q4 = Oct ($212,246) + Nov ($108,504) + Dec ($272,039) = $592,789
- Template 6 customer revenue sum for all customers should approximate $3,052,953

**Compile Final Verification Report**

After completing SALES-05 and SALES-06 verification, finalize 04-VERIFICATION.md:

1. Add SALES-05 and SALES-06 sections with the same structure as SALES-04
2. Add a **Summary** section at the top of the file:

```markdown
# Phase 4: Sales Skill Verification Report

**Phase:** 04-sales-skill-verification
**Date:** [execution date]
**Skill verified:** control-erp-sales-SKILL.md (368 lines, 9 query templates)
**Method:** [MCP live query / cross-reference verification]

## Summary

| Requirement | Description | Status | Notes |
|-------------|-------------|--------|-------|
| SALES-01 | DyeSub Print container architecture | PASS/FAIL | [brief] |
| SALES-02 | Table Cover identification | PASS/FAIL | [brief] |
| SALES-03 | Non-container products | PASS/FAIL | [brief] |
| SALES-04 | Product revenue validation | PASS/FAIL | [brief] |
| SALES-05 | Customer revenue validation | PASS/FAIL | [brief] |
| SALES-06 | Sales trend validation | PASS/FAIL | [brief] |

**Overall: X/6 PASS**
```

3. Add a **Known Limitations** section documenting:
   - "Other Products/Services" bucket not analyzed in detail ($256K)
   - DyeLux/Garment grouping discrepancy vs Control report
   - MCP availability constraint (if applicable)
   - Header vs detail revenue gap ($5,895)

4. If any SALES requirement FAILS, document the specific fix needed and whether it requires skill file changes or just documentation.

5. If all 6 requirements pass, add: "Phase 4 complete. All SALES requirements verified. The control-erp-sales skill is ready for downstream consumption by Phase 6 (Glossary) and Phase 7 (Test Suite)."
  </action>
  <verify>
Read 04-VERIFICATION.md and confirm:
- Summary table at top with all 6 SALES requirements
- Each requirement has its own section with status
- SALES-05 section documents top customer results
- SALES-06 section documents monthly trend and consistency checks
- Known Limitations section exists
- File ends with phase completion statement (if all pass) or remediation plan (if any fail)
  </verify>
  <done>04-VERIFICATION.md is complete with all 6 SALES requirements verified. Summary table shows overall pass/fail. Known limitations documented. Phase 4 verification report is ready for Phase 7 (Test Suite) and Phase 8 (Documentation) to reference.</done>
</task>

</tasks>

<verification>
Phase-level verification for Plan 2:
1. 04-VERIFICATION.md has summary table with all 6 SALES requirements
2. SALES-04: DyeSub total = $1,793,445, reconciliation detail total ~$3,047K, internal consistency confirmed
3. SALES-05: Top customer is FLASH Visual Media at ~$430K, PAC BannerWorks has multiple product lines
4. SALES-06: Monthly trend has 12 rows summing to ~$3,053K, YoY shows 2024 and 2025
5. Internal consistency: monthly = annual, categories = DyeSub total, groups = detail total
6. Known limitations section documents "Other" bucket, grouping discrepancies, header-detail gap
</verification>

<success_criteria>
- SALES-04: Product revenue validated with DyeSub Print = $1,793,445 (+/-$100) and reconciliation total within 1% of $3,047K
- SALES-05: Top 10 customers documented with FLASH at #1, combined ~49% of total revenue
- SALES-06: 12-month trend documented, monthly sum within $5 of annual total, YoY shows both years
- All internal consistency checks pass (no unexplained discrepancies)
- 04-VERIFICATION.md complete with summary table, per-requirement sections, known limitations
- Overall: 6/6 SALES requirements have PASS or documented FAIL with remediation
</success_criteria>

<output>
After completion, create `.planning/phases/04-sales-skill-verification/04-02-SUMMARY.md`
</output>
